<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hi, MrGong</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://gyunzhi.github.io/"/>
  <updated>2019-07-11T13:04:07.940Z</updated>
  <id>https://gyunzhi.github.io/</id>
  
  <author>
    <name>GYunZhi</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Express框架入门</title>
    <link href="https://gyunzhi.github.io/2018/12/09/Express%E6%A1%86%E6%9E%B6%E5%85%A5%E9%97%A8/"/>
    <id>https://gyunzhi.github.io/2018/12/09/Express框架入门/</id>
    <published>2018-12-08T20:16:56.000Z</published>
    <updated>2019-07-11T13:04:07.940Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Express-简介"><a href="#Express-简介" class="headerlink" title="Express 简介"></a>Express 简介</h3><p><a href="http://www.expressjs.com.cn" target="_blank" rel="noopener">Express</a> 是一基于Node的一个框架，用来快速创建Web服务的一个工具，为什么要使用Express呢，因为创建Web服务如果从Node开始有很多繁琐的工作要做，而Express为你解放了很多工作，从而让你更加关注于逻辑业务开发。举个例子：</p><p>创建一个很简单的网站：</p><ol><li>使用Node来开发：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">'Hello World'</span>)</span><br><span class="line">&#125;).listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure><p>这是一个简单的 Hello World，但实际上真正的网站要比这个复杂很多，主要有：</p><p>（1） 多个页面的路由功能</p><p>（2） 对请求的逻辑处理</p><p>那么使用node原生写法就要进行以下处理</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>)</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, rep</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//req.url: 访问路径</span></span><br><span class="line">  <span class="keyword">var</span> urlObj = url.parse(req.url);</span><br><span class="line">  <span class="keyword">switch</span> (urlObj.pathname) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">      <span class="comment">//首页</span></span><br><span class="line">      rep.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      rep.end(<span class="string">'&lt;h1&gt;这是首页&lt;/h1&gt;'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/user'</span>:</span><br><span class="line">      <span class="comment">//个人中心</span></span><br><span class="line">      rep.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      rep.end(<span class="string">'&lt;h1&gt;这是个人中心&lt;/h1&gt;'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">     <span class="comment">//处理其他情况</span></span><br><span class="line">     rep.writeHead(<span class="number">404</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">     &#125;)</span><br><span class="line">     rep.end(<span class="string">'&lt;h1&gt;页面不见了&lt;/h1&gt;'</span>);</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, <span class="string">'localhost'</span>)</span><br></pre></td></tr></table></figure><p>代码里在createServer函数里传递一个回调函数用来处理http请求并返回结果，在这个函数里有两个工作要做：</p><p>（1）路由分析，对于不同的路径需要进行分别处理</p><p>（2）逻辑处理和返回，对某个路径进行特别的逻辑处理</p><p>如果一个大型网站拥有海量的页面，每个页面的处理逻辑也是交错复杂，那这里的写法会非常混乱，没法维护，为了解决这个问题，TJ提出了Connect的概念，把Java里面的中间件概念第一次进入到JS的世界，Web请求将一个一个经过中间件，并通过其中一个中间件返回，大大提高了代码的可维护性和开发效率。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入connect模块</span></span><br><span class="line"><span class="keyword">var</span> connect = <span class="built_in">require</span>(<span class="string">"connect"</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 建立app</span></span><br><span class="line"><span class="keyword">var</span> app = connect();</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 添加中间件</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    response.writeHead(<span class="number">200</span>, &#123; <span class="string">"Content-Type"</span>: <span class="string">"text/plain"</span> &#125;);</span><br><span class="line">    response.end(<span class="string">"Hello world!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">启动应用 http.createServer(app).listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>但是TJ认为还应该更好一点，于是Express诞生了，通过Express开发以上的例子：</p><ol start="2"><li>使用Express来开发：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'Hello World!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/about'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'About'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">  <span class="keyword">var</span> host = server.address().address; </span><br><span class="line">  <span class="keyword">var</span> port = server.address().port; </span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Example app listening at http://%s:%s'</span>, host, port); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>从Express例子可以看出，使用Express大大减少了代码，而且逻辑更为简洁，所以使用Express可以提高开发效率并降低项目维护成本。</p><h3 id="Express-安装使用"><a href="#Express-安装使用" class="headerlink" title="Express 安装使用"></a>Express 安装使用</h3><p>1.手动安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init </span><br><span class="line">npm install express || yarn add express</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">   res.send(<span class="string">'Hello World!'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = app.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> host = server.address().address;</span><br><span class="line">  <span class="keyword">var</span> port = server.address().port;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Example app listening at http://%s:%s'</span>, host, port);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>2.通过express-generator生成express项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install express-generator -g</span><br><span class="line">express --ejs express_demo || .  // .代表在当前目录生成项目</span><br><span class="line"><span class="built_in">cd</span> express_demo</span><br><span class="line">npm install || yarn</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行项目</span></span><br><span class="line">npm start || node ./bin/www</span><br></pre></td></tr></table></figure><h3 id="Express-源码结构"><a href="#Express-源码结构" class="headerlink" title="Express 源码结构"></a>Express 源码结构</h3><p>在 Express4.x 的版本中，已经移除了connect模块，Express内部自己实现了connect的模块，并进行了一些增强处理。这里对Express 源码进行一些简单的说明。</p><p>首先我们看一下Express的源码结构：</p><p><img src="http://img.gongyz.cn/blog/20190228/L86HlXsRhwYH.png?imageslim" alt="mark"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">middleware:中间件</span><br><span class="line"></span><br><span class="line">    init.js 初始化request，response</span><br><span class="line"></span><br><span class="line">    query.js 格式化url，将url中的rquest参数剥离, 储存到req.query中</span><br><span class="line"></span><br><span class="line">router: 路由</span><br><span class="line"></span><br><span class="line">index.js  Router类，用于存储中间件数组</span><br><span class="line"></span><br><span class="line">layer.js  中间件实体类</span><br><span class="line"></span><br><span class="line">route.js  Route类，用于处理不同Method</span><br><span class="line"></span><br><span class="line">application.js 对外API</span><br><span class="line"></span><br><span class="line">express.js 入口</span><br><span class="line"></span><br><span class="line">request.js 请求增强</span><br><span class="line"></span><br><span class="line">response.js 返回增强</span><br><span class="line"></span><br><span class="line">utils.js 工具函数</span><br><span class="line"></span><br><span class="line">view.js 模版相关</span><br></pre></td></tr></table></figure><p>Express中的中间件和connect中不太一样，因为Express有两种中间件，<strong>普通中间件、路由中间件</strong>。</p><p><img src="http://img.gongyz.cn/blog/20190711/ga75BUM7nW6R.png?imageslim" alt></p><p>app初始化时，会push两个中间件（init，query）进router.stack里。我们可以通过app.use往app添加非路由中间件，也可以通过app[METHOD]添加路由中间件。</p><p><strong>普通中间件：</strong></p><p>使用app.use方法的时候，会通过lazyrouter()方法实例化一个Router对象，在整个app中只有一个Router对象。最终调用router.use()方法，把 Layer 添加到 Router stack 中，且这个 Layer 的 route属性为undefined。</p><p><strong>路由中间件：</strong></p><p>使用app[METHOD]方法的时候，同样会把这个中间件添加到 Router对象的 stack 中， 但是这个 Layer 的 route属性会指向一个实例化的 Route 对象， 在Route里也有一个实例化的 Layer，且放在stack里，与Router的 Layer不同的是，Route的没有layer.route 且 layer.method 存放了http方法。</p><p><strong>总结：</strong></p><ul><li><p>express 中添加中间件方法有 app.use 和 app[METHOD] ,当然还有内置的 Router 类，app.use 用来添加非路由中间件，app[METHOD] 用来添加路由中间件。</p></li><li><p>Layer 类封装中间的 path 和 handle (处理函数)</p></li><li><p>Router 和 Route都有对应的 stack，但是 Route 在整个 app 中只有一个，而 Route 可以有多个。放在Router<br>   stack 里的路由中间件，通过Layer.route 指向 Route，与 Route stack 相关联起来。</p></li></ul><h3 id="Express-运行原理"><a href="#Express-运行原理" class="headerlink" title="Express 运行原理"></a>Express 运行原理</h3><p><img src="http://img.gongyz.cn/blog/181030/gJbi318Jci.png" alt="mark"></p><h3 id="Express基本使用"><a href="#Express基本使用" class="headerlink" title="Express基本使用"></a>Express基本使用</h3><p>示例代码： <a href="https://gitee.com/gongyz/blog_express/tree/study/" target="_blank" rel="noopener">https://gitee.com/gongyz/blog_express/tree/study/</a></p><h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>路由定义了应用程序如何响应客户端的请求，这些请求是由一个 <strong>URI + HTTP请求方法</strong> 组成，每个路由都可以指定一个或者多个处理函数，处理函数会在匹配路由时执行。</p><p>路由的定义采用以下的结构：app.METHOD(PATH, HANDLER)</p><h5 id="1、基本使用"><a href="#1、基本使用" class="headerlink" title="1、基本使用"></a>1、基本使用</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  默认路由，基础路径为 '/'</span></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,rep,next</span>) </span>&#123;</span><br><span class="line">  rep.send(<span class="string">'Hello World!'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,rep,next</span>) </span>&#123;</span><br><span class="line">  rep.send(<span class="string">'user'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以指定多个处理函数</span></span><br><span class="line">app.get(<span class="string">'/user'</span>,fn1, fn2, ... function (req,rep,next) &#123;</span><br><span class="line">  rep.send(<span class="string">'user'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user/:name/:group'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,rep,next</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(rep.params)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建子路由，并且对子路由进行配置</span></span><br><span class="line"><span class="keyword">var</span> router = express.Router(&#123;</span><br><span class="line">  mergeParams: <span class="literal">true</span>,</span><br><span class="line">  caseSensitive: <span class="literal">true</span>,</span><br><span class="line">  strict: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册子路由，基础路径为 /user/:name/:group</span></span><br><span class="line">app.use(<span class="string">'/user/:name/:group'</span>, router)</span><br><span class="line"></span><br><span class="line"><span class="comment">//  /user:name:group 和 /user:name:group/ 都可以匹配</span></span><br><span class="line">router.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, rep, next</span>) </span>&#123;</span><br><span class="line">  rep.send(req.params)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// /user:name:group/test</span></span><br><span class="line">router.get(<span class="string">'/test'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, rep, next</span>) </span>&#123;</span><br><span class="line">  rep.send(<span class="string">'router test'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="2、路由路径"><a href="#2、路由路径" class="headerlink" title="2、路由路径"></a>2、路由路径</h5><p>路由路径可以是字符串、字符串匹配模式或正则表达式，详细的可以查看官方文档关于<a href="http://www.expressjs.com.cn/guide/routing.html" target="_blank" rel="noopener">路由</a> 这一节。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/users/:userId/books/:bookId</span><br><span class="line">/abc?d  <span class="number">0</span>次或<span class="number">1</span>次</span><br><span class="line">/abc+d  <span class="number">1</span>次或多次</span><br><span class="line">/abc\*d c~d之间任意字符</span><br><span class="line">/a(bc)?d</span><br><span class="line">/a(bc)+d</span><br><span class="line">/\/ab[<span class="number">1</span>,<span class="number">2</span>]\/cd/ 正则匹配</span><br><span class="line">[<span class="regexp">/abc?d, /</span>a(bc)?d] <span class="comment">//  多个匹配</span></span><br><span class="line"></span><br><span class="line">app.get(<span class="regexp">/\/ab[1,2]\/cd/</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res,next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'finish'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="3、app-all"><a href="#3、app-all" class="headerlink" title="3、app.all()"></a>3、app.all()</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.all() 所有匹配到该路由路径的HTTP方法都会执行处理函数</span></span><br><span class="line">router.all(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// runs for all HTTP verbs first</span></span><br><span class="line">  <span class="comment">// think of it as route specific middleware!</span></span><br><span class="line">  next();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="4、app-param"><a href="#4、app-param" class="headerlink" title="4、app.param()"></a>4、app.param()</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 普通写法对请求参数进行处理</span></span><br><span class="line"> app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (req.params.id !== <span class="string">'1'</span>) &#123;</span><br><span class="line">    res.send(<span class="number">404</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.send(<span class="string">'success'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用app.param添加一个拦截器，对请求参数进行处理，下面的路由用来处理正确的请求</span></span><br><span class="line">app.param(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next, id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (req.params.id !== <span class="string">'1'</span>) &#123;</span><br><span class="line">    res.send(<span class="number">404</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'success'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个参数时的写法</span></span><br><span class="line"><span class="comment">// 回调函数会执行两次，等同于下面的写法，建议采用下面的写法分开写</span></span><br><span class="line">app.param([<span class="string">'id'</span>, <span class="string">'name'</span>], <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next, value</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value) </span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 第一次</span></span><br><span class="line">app.param(<span class="string">'id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next, id</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(id)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 第二次</span></span><br><span class="line">app.param(<span class="string">'name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next, name</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(name)</span><br><span class="line">  next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/user/:id/:name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'success'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// router.param 用法和 app.param一样，不同的是router.param不支持['id', 'name']接收参数</span></span><br></pre></td></tr></table></figure><h5 id="5、app-route"><a href="#5、app-route" class="headerlink" title="5、app.route()"></a>5、app.route()</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 router.route() 方法避免对同一个路径重复命名</span></span><br><span class="line">router.route(<span class="string">'/users/:user_id'</span>)</span><br><span class="line">.all(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// runs for all HTTP verbs first</span></span><br><span class="line">  <span class="comment">// think of it as route specific middleware!</span></span><br><span class="line">  next();</span><br><span class="line">&#125;)</span><br><span class="line">.get(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.json(req.user);</span><br><span class="line">&#125;)</span><br><span class="line">.post(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'not implemented'</span>));</span><br><span class="line">&#125;)</span><br><span class="line">.put(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// just an example of maybe updating the user</span></span><br><span class="line">  req.user.name = req.params.name;</span><br><span class="line">  <span class="comment">// save user ... etc</span></span><br><span class="line">  res.json(req.user);</span><br><span class="line">&#125;)</span><br><span class="line">.delete(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'not implemented'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="静态资源访问"><a href="#静态资源访问" class="headerlink" title="静态资源访问"></a>静态资源访问</h4><p>express内部引用了  <a href="http://www.expressjs.com.cn/en/resources/middleware/serve-static.html" target="_blank" rel="noopener">serve-static</a> 这个库，并且挂载到了express的static方法上。在后面的<strong>响应</strong>部分也介绍了在不使用 express.static 方法情况下如何实现静态资源访问。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本用法</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义配置</span></span><br><span class="line">app.use(express.static(<span class="string">'public'</span>, &#123;</span><br><span class="line">    index: <span class="string">'index.html'</span>, <span class="comment">// ['index.html', 'index.htm'] 指定默认的首页</span></span><br><span class="line">    dotfiles: <span class="string">'allow'</span>, <span class="comment">// 是否.XXX</span></span><br><span class="line">    extensions:[<span class="string">'html'</span>, <span class="string">'htm'</span>] <span class="comment">// 配置扩展名</span></span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure><h4 id="获取客户端请求数据"><a href="#获取客户端请求数据" class="headerlink" title="获取客户端请求数据"></a>获取客户端请求数据</h4><h5 id="1、获取URL中的数据"><a href="#1、获取URL中的数据" class="headerlink" title="1、获取URL中的数据"></a>1、获取URL中的数据</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/index/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,res,next</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">`</span></span><br><span class="line"><span class="string">    &lt;ul&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.methed = <span class="subst">$&#123;req.method&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.hostnam = <span class="subst">$&#123;req.hostname&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.originalUrl = <span class="subst">$&#123;req.originalUrl&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.path = <span class="subst">$&#123;req.path&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.protocol = <span class="subst">$&#123;req.protocol&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.query = <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.query)&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;req.params= <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(req.params)&#125;</span>&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">  `</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="2、获取-headers-中的数据"><a href="#2、获取-headers-中的数据" class="headerlink" title="2、获取 headers 中的数据"></a>2、获取 headers 中的数据</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/index'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">res.send(req.headers)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="3、获取-body-中的数据"><a href="#3、获取-body-中的数据" class="headerlink" title="3、获取 body 中的数据"></a>3、获取 body 中的数据</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">表单提交编码方式常用的有三种</span><br><span class="line">application/x-www-form-urlencoded   默认</span><br><span class="line">text/plain</span><br><span class="line">multipart/form-data  <span class="comment">// 该类型需要使用 Multer 中间件处理，下面会介绍</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入 body-parse 模块，express支持 json、urlencoded、text 方法</span></span><br><span class="line"><span class="comment">// express内部已经引入了 body-parse 模块，并且把两个常用的方法json、urlencoded方法挂载到了express实例上</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  处理 Content-Type 为 application/x-www-form-urlencoded 类型的请求</span></span><br><span class="line">app.use(bodyParser.urlencoded());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 Content-Type 为 text/plain 类型的请求</span></span><br><span class="line">app.use(bodyParser.text());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 Content-Type 为 application/json 类型的请求</span></span><br><span class="line">app.use(bodyParser.json());  </span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Postman测试</span></span><br><span class="line">app.post(<span class="string">'/test'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  res.send(req.body)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="4、获取上传文件的数据"><a href="#4、获取上传文件的数据" class="headerlink" title="4、获取上传文件的数据"></a>4、获取上传文件的数据</h5><p>这里需要用到 <a href="https://github.com/expressjs/multer/blob/master/doc/README-zh-cn.md" target="_blank" rel="noopener">Multer</a> 中间件，用于处理 <code>multipart/form-data</code> 类型的表单数据，它主要用于上传文件。</p><p><strong>注意</strong>: Multer 不会处理任何非 <code>multipart/form-data</code> 类型的表单数据。</p><p><strong>安装</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ npm install --save multer</span><br></pre></td></tr></table></figure><p><strong>使用</strong></p><p>Multer 会添加一个 <code>body</code> 对象 以及 <code>file</code> 或 <code>files</code> 对象 到 express 的 <code>request</code> 对象中。 <code>body</code> 对象包含表单的文本域信息，<code>file</code> 或 <code>files</code> 对象包含对象表单上传的文件信息。</p><p><strong>警告:</strong>  <strong>确保你总是处理了用户的文件上传。永远不要将 multer 作为全局中间件使用，因为恶意用户可以上传文件到一个你没有预料到的路由，应该只在你需要处理上传文件的路由上使用。</strong></p><p>基本使用方法:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  Multer 接受一个 options 对象，其中最基本的是 dest 属性，</span></span><br><span class="line"><span class="comment">  这将告诉 Multer 将上传文件保存在哪。如果你省略 options对象，</span></span><br><span class="line"><span class="comment">  这些文件将保存在内存中，永远不会写入磁盘。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// var upload = multer(&#123; dest: 'uploads/' &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存存储</span></span><br><span class="line"><span class="comment">// var storage = multer.memoryStorage()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 磁盘存储</span></span><br><span class="line"><span class="keyword">var</span> storage = multer.diskStorage(&#123;</span><br><span class="line">  destination: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="literal">null</span>, <span class="string">'uploads'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  filename: <span class="function"><span class="keyword">function</span> (<span class="params">req, file, cb</span>) </span>&#123;</span><br><span class="line">    cb(<span class="literal">null</span>, file.originalname + <span class="string">'-'</span> + <span class="built_in">Date</span>.now())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建上传中间件对请求进行拦截，处理上传的文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置一个函数来控制什么文件可以上传以及什么文件应该跳过</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fileFilter</span> (<span class="params">req, file, cb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 这个函数应该调用 cb 用 boolean 值来指示是否应接受该文件</span></span><br><span class="line">  <span class="keyword">if</span> (file.mimetype === <span class="string">'image/png'</span>) &#123;</span><br><span class="line">    <span class="comment">// 接受这个文件，使用`true`</span></span><br><span class="line">    cb(<span class="literal">null</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 拒绝这个文件，使用false</span></span><br><span class="line">    cb(<span class="literal">null</span>, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拒绝同时抛出错误给express处理</span></span><br><span class="line">    cb(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'file type illegal'</span>),<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> upload = multer(&#123; <span class="attr">storage</span>: storage, <span class="attr">fileFilter</span>: fileFilter &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只接受文本域</span></span><br><span class="line">app.post(<span class="string">'/upload'</span>, upload.none(), <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">   res.send(req.body)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接受文本域和一切上传的文件，文件数组将保存在 req.files</span></span><br><span class="line">app.post(<span class="string">'/upload'</span>, upload.any(), <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.body'</span>, req.body)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.file'</span>, req.file)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.files'</span>, req.files)</span><br><span class="line">  res.send(<span class="string">'请求成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理单个以 fieldname 命名的文件，fieldname 由表单指定, 文件的信息保存在 req.file</span></span><br><span class="line">app.post(<span class="string">'/upload'</span>, upload.single(<span class="string">'file'</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.body'</span>, req.body)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.file'</span>, req.file)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.files'</span>, req.files)</span><br><span class="line">  res.send(<span class="string">'请求成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理多个以 fieldname 命名的文件，文件 fieldname 相同, 可以配置 maxCount 来限制上传的最大数量，文件的信息保存在 req.files</span></span><br><span class="line">app.post(<span class="string">'/upload'</span>, upload.array(<span class="string">'file'</span>, <span class="number">3</span>), <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.body'</span>, req.body)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.file'</span>, req.file)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'req.files'</span>, req.files)</span><br><span class="line">  res.send(<span class="string">'请求成功'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理不同 fieldname 命名的文件，文件的信息保存在 req.files</span></span><br><span class="line">fields 应该是一个对象数组，具有 name 和可选的 maxCount 属性</span><br><span class="line"> <span class="keyword">let</span> fields = [</span><br><span class="line">   &#123; <span class="attr">name</span>: <span class="string">'file'</span>, <span class="attr">maxCount</span>: <span class="number">1</span> &#125;,</span><br><span class="line">   &#123; <span class="attr">name</span>: <span class="string">'file2'</span>, <span class="attr">maxCount</span>: <span class="number">2</span> &#125;</span><br><span class="line"> ]</span><br><span class="line"> app.post(<span class="string">'/upload'</span>, upload.fields(fields), <span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'req.body'</span>, req.body)</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'req.file'</span>, req.file)</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'req.files'</span>, req.files)</span><br><span class="line">   res.send(<span class="string">'请求成功'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h4><h5 id="1、基本方式的响应"><a href="#1、基本方式的响应" class="headerlink" title="1、基本方式的响应"></a>1、基本方式的响应</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/txt'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'my name is gongyz'</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/json'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  res.send(&#123;<span class="attr">name</span>: <span class="string">'gongyz'</span>, <span class="attr">age</span>: <span class="number">23</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/html'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  res.send(<span class="string">'&lt;p style="color: red"&gt;Hello World&lt;/p&gt;'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"> app.get(<span class="string">'/download'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">   res.download(<span class="string">'public/download.txt'</span>);</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/redirect'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">  res.redirect(<span class="string">'http://www.baidu.com'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态资源访问</span></span><br><span class="line">app.get(<span class="string">'/file/:name'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> options = &#123;</span><br><span class="line">    root: __dirname + <span class="string">'/public/'</span>,</span><br><span class="line">    dotfiles: <span class="string">'deny'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'x-timestamp'</span>: <span class="built_in">Date</span>.now(),</span><br><span class="line">      <span class="string">'x-sent'</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> fileName = req.params.name;</span><br><span class="line">  res.sendFile(fileName, options, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      next(err)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Sent:'</span>, fileName)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="2、动态页面渲染"><a href="#2、动态页面渲染" class="headerlink" title="2、动态页面渲染"></a>2、动态页面渲染</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// view engine setup</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'ejs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> indexRouter = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> usersRouter = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span> ,indexRouter)</span><br><span class="line">app.use(<span class="string">'/user'</span> ,usersRouter)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line"><span class="comment">// router.get('/', function(req, res, next) &#123;</span></span><br><span class="line"><span class="comment">//   var arr =[1,2,3,4,5,6,7,8]</span></span><br><span class="line"><span class="comment">//   res.render('index', &#123; title: 'index', arr &#125;);</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际项目中的做法</span></span><br><span class="line"><span class="keyword">var</span> db = &#123;</span><br><span class="line">  getData (req,res,next) &#123;</span><br><span class="line">    <span class="keyword">var</span> arr =[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>]</span><br><span class="line">    res.locals = &#123;<span class="attr">title</span>: <span class="string">'index'</span>, arr&#125;</span><br><span class="line">    next()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>,db.getData, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.render(<span class="string">'index'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Express-简介&quot;&gt;&lt;a href=&quot;#Express-简介&quot; class=&quot;headerlink&quot; title=&quot;Express 简介&quot;&gt;&lt;/a&gt;Express 简介&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;http://www.expressjs.com.cn&quot; 
      
    
    </summary>
    
      <category term="Express" scheme="https://gyunzhi.github.io/categories/Express/"/>
    
    
      <category term="Express" scheme="https://gyunzhi.github.io/tags/Express/"/>
    
  </entry>
  
  <entry>
    <title>Connect框架源码分析</title>
    <link href="https://gyunzhi.github.io/2018/11/11/Connect%E6%A1%86%E6%9E%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    <id>https://gyunzhi.github.io/2018/11/11/Connect框架源码分析/</id>
    <published>2018-11-10T19:26:32.000Z</published>
    <updated>2019-05-31T03:01:39.707Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://github.com/senchalabs/connect" target="_blank" rel="noopener">Connect</a> 是一个可扩展(中间件作为插件)的 Http 服务器框架，Connect 刚出道之时自带了许多中间件，为保证其框架的轻量级以及扩展性，最终还是将这些中间件的实现抛给了社区。可能在搜索 Connect 的相关项目时，你会发现 <code>connect().use(connect.bodyParser())</code>这些的写法，这对于现在的 Connect (最新版本3.6.0) 是不支持的，而只能通过 npm 下载第三方的模块 (如 body-parser) 替代原先的中间价。</p><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> connect = <span class="built_in">require</span>(<span class="string">'connect'</span>);</span><br><span class="line"><span class="keyword">var</span> createError = <span class="built_in">require</span>(<span class="string">'http-errors'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = connect()</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  res.writeHead(<span class="number">200</span>,<span class="string">'OK'</span>,&#123;</span><br><span class="line">    <span class="comment">//'content-type': 'text/plain' //纯文本</span></span><br><span class="line">    <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  res.write(<span class="string">'&lt;h1&gt;你好，欢迎学习connect&lt;/h1&gt;'</span>)</span><br><span class="line">  res.end()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(createError(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  res.statusCode = <span class="number">404</span>;</span><br><span class="line">  res.end(<span class="string">'Not Found'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两种方式监听指定端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>) <span class="comment">// 这种方式在connect里面调用了http.createServer方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// http.createServer(app).listen(3000);</span></span><br></pre></td></tr></table></figure><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>这篇文章是基于<code>&quot;version&quot;: &quot;3.6.6&quot;</code>这个版本来对源码进行分析的，这个版本所有的代码都在<code>index.js</code>文件中。下面我们来看一下connect是怎么工作的。</p><p>首先我们看一下这个文件的模块出口，可以看到导出了一个<code>createServer</code>函数，这个函数最终返回的是app，app本身是一个函数，在下面一段代码中我们可以的看到它是作为了request事件的处理函数。同时它既继承了proto、EventEmitter属性和方法，也有自己的route、stack属性。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模块出口</span></span><br><span class="line"><span class="built_in">module</span>.exports = createServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前环境，初始化proto 对象</span></span><br><span class="line"><span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span>;</span><br><span class="line"><span class="keyword">var</span> proto = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// app 函数对象，可以添加属性和方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">app</span>(<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">    app.handle(req, res, next); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// merge： 相当于Object.assign</span></span><br><span class="line">  merge(app, proto);  <span class="comment">// 继承proto的属性和方法</span></span><br><span class="line">  merge(app, EventEmitter.prototype); <span class="comment">// 继承EventEmitter（事件派发器）属性和方法</span></span><br><span class="line">  app.route = <span class="string">'/'</span>;</span><br><span class="line">  app.stack = []; <span class="comment">// 存放中间件的数组,中间件会被格式化成形为&#123;route: route , handle : fn&#125;的匿名对象存放</span></span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听指定端口号</span></span><br><span class="line">proto.listen = <span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> server = http.createServer(<span class="keyword">this</span>); <span class="comment">// this ——&gt; app函数对象,作为request事件的处理函数</span></span><br><span class="line">  <span class="keyword">return</span> server.listen.apply(server, <span class="built_in">arguments</span>); <span class="comment">// 从 arguments 拿到端口号</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>connect框架的核心是use、handle、call三个方法，我们来分析一下这三个方法分别有什么作用。</p><p><strong>use方法：添加中间件</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加中间件</span></span><br><span class="line">proto.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">route, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> handle = fn;</span><br><span class="line">  <span class="keyword">var</span> path = route;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果参数只有一个，那么path默认是 '/', 传入的参数作为处理函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    handle = route;</span><br><span class="line">    path = <span class="string">'/'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果fn为一个app的实例，则将其自身handle方法的包裹给fn</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handle.handle === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> server = handle;</span><br><span class="line">    server.route = path;</span><br><span class="line">    handle = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">      server.handle(req, res, next);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果fn为一个http.Server实例，则fn为其request事件的第一个监听器</span></span><br><span class="line">  <span class="keyword">if</span> (handle <span class="keyword">instanceof</span> http.Server) &#123;</span><br><span class="line">    handle = handle.listeners(<span class="string">'request'</span>)[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果route参数的以 '/' 结尾，则删除 '/'</span></span><br><span class="line">  <span class="keyword">if</span> (path[path.length - <span class="number">1</span>] === <span class="string">'/'</span>) &#123;</span><br><span class="line">    path = path.slice(<span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把中间件添加到stack数组中</span></span><br><span class="line">  debug(<span class="string">'use %s %s'</span>, path || <span class="string">'/'</span>, handle.name || <span class="string">'anonymous'</span>);</span><br><span class="line">  <span class="keyword">this</span>.stack.push(&#123; <span class="attr">route</span>: path, <span class="attr">handle</span>: handle &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回自身，以便继续链式调用</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>handle方法：根据当前路径找到stack中所有与之相匹配的中间件，通过call方法调用中间件处理函数</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">proto.handle = <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">req, res, out</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> protohost = getProtohost(req.url) || <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> removed = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> slashAdded = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> stack = <span class="keyword">this</span>.stack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// final function handler</span></span><br><span class="line">  <span class="keyword">var</span> done = out || finalhandler(req, res, &#123;</span><br><span class="line">    env: env,</span><br><span class="line">    onerror: logerror</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store the original URL</span></span><br><span class="line">  req.originalUrl = req.originalUrl || req.url;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用next方法传递的err信息，可以在下一个中间件处理函数的err参数中获取到</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (slashAdded) &#123;</span><br><span class="line">      req.url = req.url.substr(<span class="number">1</span>);</span><br><span class="line">      slashAdded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (removed.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      req.url = protohost + removed + req.url.substr(protohost.length);</span><br><span class="line">      removed = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出第一个中间件，index+1，再次调用取出第二个中间件....</span></span><br><span class="line">    <span class="keyword">var</span> layer = stack[index++];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all done</span></span><br><span class="line">    <span class="keyword">if</span> (!layer) &#123;</span><br><span class="line">      defer(done, err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// route data</span></span><br><span class="line">    <span class="keyword">var</span> path = parseUrl(req).pathname || <span class="string">'/'</span>;</span><br><span class="line">    <span class="keyword">var</span> route = layer.route;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// skip this layer if the route doesn't match</span></span><br><span class="line">    <span class="keyword">if</span> (path.toLowerCase().substr(<span class="number">0</span>, route.length) !== route.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip if route match does not border "/", ".", or end</span></span><br><span class="line">    <span class="keyword">var</span> c = path.length &gt; route.length &amp;&amp; path[route.length];</span><br><span class="line">    <span class="keyword">if</span> (c &amp;&amp; c !== <span class="string">'/'</span> &amp;&amp; c !== <span class="string">'.'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trim off the part of the url that matches the route</span></span><br><span class="line">    <span class="keyword">if</span> (route.length !== <span class="number">0</span> &amp;&amp; route !== <span class="string">'/'</span>) &#123;</span><br><span class="line">      removed = route;</span><br><span class="line">      req.url = protohost + req.url.substr(protohost.length + removed.length);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ensure leading slash</span></span><br><span class="line">      <span class="keyword">if</span> (!protohost &amp;&amp; req.url[<span class="number">0</span>] !== <span class="string">'/'</span>) &#123;</span><br><span class="line">        req.url = <span class="string">'/'</span> + req.url;</span><br><span class="line">        slashAdded = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行handler中匹配到的中间件</span></span><br><span class="line">    call(layer.handle, route, err, req, res, next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>call方法:：执行handler中匹配到的中间件</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">handle, route, err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// handle函数的参数个数(3个参数为一般中间件，4个参数为错误处理中间件)</span></span><br><span class="line">  <span class="comment">// next参数接收的是上面定义的next函数，然后传入到中间件的handle函数中，handle函数同样通过next参数接  收，所以在中间件中调用next后会继续执行下一个中间件</span></span><br><span class="line">  <span class="keyword">var</span> arity = handle.length;</span><br><span class="line">  <span class="keyword">var</span> error = err;</span><br><span class="line">  <span class="keyword">var</span> hasError = <span class="built_in">Boolean</span>(err);</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'%s %s : %s'</span>, handle.name || <span class="string">'&lt;anonymous&gt;'</span>, route, req.originalUrl);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasError &amp;&amp; arity === <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// 执行错误处理中间件</span></span><br><span class="line">      handle(err, req, res, next);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasError &amp;&amp; arity &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// 执行一般中间件</span></span><br><span class="line">      handle(req, res, next);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// replace the error</span></span><br><span class="line">    error = e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// continue</span></span><br><span class="line">  next(error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="connect运行过程"><a href="#connect运行过程" class="headerlink" title="connect运行过程"></a>connect运行过程</h3><p>通过下面的这张图，总结一下connect工作流程，app.use方法负责把中间件添加到stack数组中，中间件会被格式化成形为{route: route , handle : fn}的匿名对象存放 ；app.handle方法根据当前路径找到stack中所有与之相匹配的中间件，并通过call方法调用中间件处理函数 ；app.call方法根据handle函数的参数个数(3个参数为一般中间件，4个参数为错误处理中间件) 来执行中间件，并把接收的next函数传给中间件。</p><p><img src="http://img.gongyz.cn/blog/181030/5ce8BaBg39.png" alt="mark"></p><h3 id="完整源码"><a href="#完整源码" class="headerlink" title="完整源码"></a>完整源码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入依赖</span></span><br><span class="line"><span class="keyword">var</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">'connect:dispatcher'</span>);</span><br><span class="line"><span class="keyword">var</span> EventEmitter = <span class="built_in">require</span>(<span class="string">'events'</span>).EventEmitter;</span><br><span class="line"><span class="keyword">var</span> finalhandler = <span class="built_in">require</span>(<span class="string">'finalhandler'</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> merge = <span class="built_in">require</span>(<span class="string">'utils-merge'</span>);</span><br><span class="line"><span class="keyword">var</span> parseUrl = <span class="built_in">require</span>(<span class="string">'parseurl'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 模块出口</span></span><br><span class="line"><span class="built_in">module</span>.exports = createServer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断当前环境，初始化proto 对象</span></span><br><span class="line"><span class="keyword">var</span> env = process.env.NODE_ENV || <span class="string">'development'</span>;</span><br><span class="line"><span class="keyword">var</span> proto = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> defer = <span class="keyword">typeof</span> setImmediate === <span class="string">'function'</span></span><br><span class="line">  ? setImmediate</span><br><span class="line">  : <span class="function"><span class="keyword">function</span>(<span class="params">fn</span>)</span>&#123; process.nextTick(fn.bind.apply(fn, <span class="built_in">arguments</span>)) &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// app 函数对象，可以添加属性和方法</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">app</span>(<span class="params">req, res, next</span>)</span>&#123; </span><br><span class="line">    app.handle(req, res, next); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 相当于Object.assign</span></span><br><span class="line">  merge(app, proto); <span class="comment">// 继承proto的属性和方法</span></span><br><span class="line">  merge(app, EventEmitter.prototype); <span class="comment">// 继承EventEmitter（事件派发器）属性和方法</span></span><br><span class="line">  app.route = <span class="string">'/'</span>;</span><br><span class="line">  app.stack = []; <span class="comment">// 存放中间件的数组,中间件会被格式化成形为&#123;route: route , handle : fn&#125;的匿名对象存放</span></span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听指定端口号</span></span><br><span class="line">proto.listen = <span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> server = http.createServer(<span class="keyword">this</span>); <span class="comment">// this ——&gt; app函数对象,作为request事件的处理函数</span></span><br><span class="line">  <span class="keyword">return</span> server.listen.apply(server, <span class="built_in">arguments</span>); <span class="comment">// 从 arguments 拿到端口号</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 添加中间件</span></span><br><span class="line">proto.use = <span class="function"><span class="keyword">function</span> <span class="title">use</span>(<span class="params">route, fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> handle = fn;</span><br><span class="line">  <span class="keyword">var</span> path = route;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果参数只有一个，那么path默认是 '/', 传入的参数作为处理函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> route !== <span class="string">'string'</span>) &#123;</span><br><span class="line">    handle = route;</span><br><span class="line">    path = <span class="string">'/'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果fn为一个app的实例，则将其自身handle方法给fn</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handle.handle === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> server = handle;</span><br><span class="line">    server.route = path;</span><br><span class="line">    handle = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">      server.handle(req, res, next);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果fn为一个http.Server实例，则fn为其request事件的第一个监听器</span></span><br><span class="line">  <span class="keyword">if</span> (handle <span class="keyword">instanceof</span> http.Server) &#123;</span><br><span class="line">    handle = handle.listeners(<span class="string">'request'</span>)[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果route参数的以 '/' 结尾，则删除 '/'</span></span><br><span class="line">  <span class="keyword">if</span> (path[path.length - <span class="number">1</span>] === <span class="string">'/'</span>) &#123;</span><br><span class="line">    path = path.slice(<span class="number">0</span>, <span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把中间件添加到stack数组中</span></span><br><span class="line">  debug(<span class="string">'use %s %s'</span>, path || <span class="string">'/'</span>, handle.name || <span class="string">'anonymous'</span>);</span><br><span class="line">  <span class="keyword">this</span>.stack.push(&#123; <span class="attr">route</span>: path, <span class="attr">handle</span>: handle &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回自身，以便继续链式调用</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个函数作用是根据当前路径找到stack中所有与之相匹配的中间件，并通过call方法调用中间件处理函数</span></span><br><span class="line">proto.handle = <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">req, res, out</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> protohost = getProtohost(req.url) || <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> removed = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> slashAdded = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">var</span> stack = <span class="keyword">this</span>.stack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// final function handler</span></span><br><span class="line">  <span class="keyword">var</span> done = out || finalhandler(req, res, &#123;</span><br><span class="line">    env: env,</span><br><span class="line">    onerror: logerror</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// store the original URL</span></span><br><span class="line">  req.originalUrl = req.originalUrl || req.url;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (slashAdded) &#123;</span><br><span class="line">      req.url = req.url.substr(<span class="number">1</span>);</span><br><span class="line">      slashAdded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (removed.length !== <span class="number">0</span>) &#123;</span><br><span class="line">      req.url = protohost + removed + req.url.substr(protohost.length);</span><br><span class="line">      removed = <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// next callback</span></span><br><span class="line">    <span class="keyword">var</span> layer = stack[index++];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all done</span></span><br><span class="line">    <span class="keyword">if</span> (!layer) &#123;</span><br><span class="line">      defer(done, err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// route data</span></span><br><span class="line">    <span class="keyword">var</span> path = parseUrl(req).pathname || <span class="string">'/'</span>;</span><br><span class="line">    <span class="keyword">var</span> route = layer.route;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip this layer if the route doesn't match</span></span><br><span class="line">    <span class="keyword">if</span> (path.toLowerCase().substr(<span class="number">0</span>, route.length) !== route.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// skip if route match does not border "/", ".", or end</span></span><br><span class="line">    <span class="keyword">var</span> c = path.length &gt; route.length &amp;&amp; path[route.length];</span><br><span class="line">    <span class="keyword">if</span> (c &amp;&amp; c !== <span class="string">'/'</span> &amp;&amp; c !== <span class="string">'.'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> next(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// trim off the part of the url that matches the route</span></span><br><span class="line">    <span class="keyword">if</span> (route.length !== <span class="number">0</span> &amp;&amp; route !== <span class="string">'/'</span>) &#123;</span><br><span class="line">      removed = route;</span><br><span class="line">      req.url = protohost + req.url.substr(protohost.length + removed.length);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ensure leading slash</span></span><br><span class="line">      <span class="keyword">if</span> (!protohost &amp;&amp; req.url[<span class="number">0</span>] !== <span class="string">'/'</span>) &#123;</span><br><span class="line">        req.url = <span class="string">'/'</span> + req.url;</span><br><span class="line">        slashAdded = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过call方法调用中间件的handle函数处理对应的路由</span></span><br><span class="line">    call(layer.handle, route, err, req, res, next);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params">handle, route, err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// handle函数的参数个数(3个参数为一般中间件，4个参数为错误处理中间件)</span></span><br><span class="line">  <span class="comment">// next参数接收的是上面定义的next函数，然后传入到中间件的handle函数中，handle函数同样通过next参数接收，所以在中间件中调用next后会继续执行下一个中间件</span></span><br><span class="line">  <span class="keyword">var</span> arity = handle.length;</span><br><span class="line">  <span class="keyword">var</span> error = err;</span><br><span class="line">  <span class="keyword">var</span> hasError = <span class="built_in">Boolean</span>(err);</span><br><span class="line"></span><br><span class="line">  debug(<span class="string">'%s %s : %s'</span>, handle.name || <span class="string">'&lt;anonymous&gt;'</span>, route, req.originalUrl);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hasError &amp;&amp; arity === <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// 执行错误处理中间件</span></span><br><span class="line">      handle(err, req, res, next);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasError &amp;&amp; arity &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="comment">// 执行一般中间件</span></span><br><span class="line">      handle(req, res, next);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// replace the error</span></span><br><span class="line">    error = e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// continue</span></span><br><span class="line">  next(error);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logerror</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (env !== <span class="string">'test'</span>) <span class="built_in">console</span>.error(err.stack || err.toString());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getProtohost</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (url.length === <span class="number">0</span> || url[<span class="number">0</span>] === <span class="string">'/'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> searchIndex = url.indexOf(<span class="string">'?'</span>);</span><br><span class="line">  <span class="keyword">var</span> pathLength = searchIndex !== <span class="number">-1</span> ? searchIndex : url.length;</span><br><span class="line">  <span class="keyword">var</span> fqdnIndex = url.substr(<span class="number">0</span>, pathLength).indexOf(<span class="string">'://'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fqdnIndex !== <span class="number">-1</span> ? url.substr(<span class="number">0</span>, url.indexOf(<span class="string">'/'</span>, <span class="number">3</span> + fqdnIndex)) : <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://github.com/senchalabs/connect&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Connect&lt;/a&gt; 是一个可扩展(中间件作为插件)的 Http 服务器框架，Connect 刚出道之时自带了许多
      
    
    </summary>
    
      <category term="Express" scheme="https://gyunzhi.github.io/categories/Express/"/>
    
    
      <category term="Express" scheme="https://gyunzhi.github.io/tags/Express/"/>
    
  </entry>
  
  <entry>
    <title>Node基础知识</title>
    <link href="https://gyunzhi.github.io/2018/10/19/Node%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    <id>https://gyunzhi.github.io/2018/10/19/Node基础知识/</id>
    <published>2018-10-18T18:16:52.000Z</published>
    <updated>2019-07-06T04:41:50.554Z</updated>
    
    <content type="html"><![CDATA[<h2 id="module-模块"><a href="#module-模块" class="headerlink" title="module - 模块"></a>module - 模块</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Node应用由模块组成，采用CommonJS模块化规范，在node中一个文件就是一个模块，每个模块都有自己的作用域。</p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>所有代码都运行在模块作用域，不会污染全局作用域。</li><li>模块可以多次加载，但是只会在第一次加载时运行一次，然后运行结果就被缓存了，以后再加载，就直接读取缓存结果。要想让模块再次运行，必须清除缓存。</li><li>模块加载的顺序，按照其在代码中出现的顺序。</li></ul><h3 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h3><h4 id="module对象"><a href="#module对象" class="headerlink" title="module对象"></a>module对象</h4><p>​        CommonJS规范规定，每个模块内部，都有一个module对象，代表当前模块,它的exports属性</p><p>​        是对外的接口。加载某个模块，其实是加载该模块的module.exports属性。</p><p>​        module对象的属性：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.id  模块的识别符，通常是带有绝对路径的模块文件名。</span><br><span class="line"><span class="built_in">module</span>.filename   模块的文件名，带有绝对路径。</span><br><span class="line"><span class="built_in">module</span>.loaded 返回一个布尔值，表示模块是否已经完成加载。</span><br><span class="line"><span class="built_in">module</span>.parent 返回一个对象，表示调用该模块的模块。</span><br><span class="line"><span class="built_in">module</span>.children 返回一个数组，表示该模块要用到的其他模块。</span><br><span class="line"><span class="built_in">module</span>.exports 表示模块对外输出的值。</span><br></pre></td></tr></table></figure><h4 id="require"><a href="#require" class="headerlink" title="require()"></a>require()</h4><p>​        Node使用CommonJS模块规范，内置的require()用于加载模块文件,require命令的基本功能是，读入</p><p>​        并执行一个JavaScript文件，然后返回该模块的module.exports属性。</p><h4 id="exports变量"><a href="#exports变量" class="headerlink" title="exports变量"></a>exports变量</h4><p>​        在模块中，还有一个变量exports，它是module.exports对象的引用，在使用exports变量时，</p><p>​        注意不要破坏它和module.exports对象之间的引用关系。</p><p>​        我们经常看到这样的写法：</p><p>​        exports = module.exports = somethings</p><p>​        上面的代码等价于:</p><p>​        module.exports = somethings</p><p>​        exports = module.exports</p><p>​        原理很简单，即 module.exports 指向新的对象时，exports 断开了与 module.exports 的引用，那么通过 </p><p>​        exports = module.exports 让 exports 重新指向 module.exports 即可。</p><h3 id="模块加载中的两个问题"><a href="#模块加载中的两个问题" class="headerlink" title="模块加载中的两个问题"></a>模块加载中的两个问题</h3><ol><li>路径问题：根据参数的不同格式，require命令去不同路径寻找模块文件。</li></ol><p>​    （1） 如果参数字符串以“/”开头，则表示加载的是一个位于绝对路径的模块文件。</p><p>​      比如，<code>require(&#39;E:/NodeJs/module/2.js&#39;)</code></p><p>​    （2）如果参数字符串以“./”开头，则表示加载的是一个位于相对路径（当前目录）的模块文件。</p><p>​      比如，<code>require(&#39;./2.js&#39;)</code></p><p>​    （3）如果参数字符串不以“./“或”/“开头，则表示加载node的核心模块，或者是node_modules下面的模块</p><p>​      比如，<code>require(&#39;fs&#39;)</code></p><ol start="2"><li>文件查找问题</li></ol><p>​    (1)首先按照加载的模块的文件名称进行查找</p><p>​    (2)如果没有找到，则会在模块文件名称后面加上.js后缀，进行查找</p><p>​    (3)如果还没有找到，则会在模块文件名称后面加上.json后缀，进行查找</p><p>​    (4)如果还没有找到，则会在模块文件名称后面加上.node后缀，进行查找</p><p>​    (5)以上都没有找到就会报错</p><h2 id="global-全局变量"><a href="#global-全局变量" class="headerlink" title="global - 全局变量"></a>global - 全局变量</h2><p>全局变量在所有模块中均可使用。 以下变量虽然看起来像全局变量，但实际上不是。 它们的作用域只在模块内，详见 <a href="http://nodejs.cn/s/TQHXpm" target="_blank" rel="noopener">module文档</a>：</p><ul><li><a href="http://nodejs.cn/s/etUQhi" target="_blank" rel="noopener"><code>__dirname</code></a></li><li><a href="http://nodejs.cn/s/RH6qCV" target="_blank" rel="noopener"><code>__filename</code></a></li><li><a href="http://nodejs.cn/s/JzVhDV" target="_blank" rel="noopener"><code>exports</code></a></li><li><a href="http://nodejs.cn/s/2UCVu5" target="_blank" rel="noopener"><code>module</code></a></li><li><a href="http://nodejs.cn/s/Hig9sg" target="_blank" rel="noopener"><code>require()</code></a></li></ul><h3 id="process-进程"><a href="#process-进程" class="headerlink" title="process - 进程"></a>process - 进程</h3><p>process对象是一个全局变量，可以在任何地方都能访问到它，通过这个对象提供的属性和方法，使我们可以对当前运行的程序的进程进行访问和控制。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">process.argv   返回一个包含命令行参数的数组</span><br><span class="line">process.env    返回用户环境信息</span><br><span class="line">process.version    返回node版本信息</span><br><span class="line">process.versions    返回node及node依赖包版本信息</span><br><span class="line">process.pid 返回进程的pid</span><br><span class="line">process.title 返回当前进程显示的名称</span><br><span class="line">process.arch 返回CPU处理器架构</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">stdin、stdout：标准输入输出流（I/O操作）</span><br><span class="line"></span><br><span class="line">process.stdin.resume()  <span class="comment">// 开启输入流, 监听输入流数据，默认开启</span></span><br><span class="line">process.stdin.pause()   <span class="comment">// 关闭输入流</span></span><br><span class="line"></span><br><span class="line">例<span class="number">1</span>: 监听用户的输入数据</span><br><span class="line"></span><br><span class="line">process.stdin.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunnk</span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'用户输入了:'</span> + chunnk )</span><br><span class="line">process.stdin.pause();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">例<span class="number">2</span>: 要求用户输入两个数值，然后把和输出到终端</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> num1, num2;</span><br><span class="line">process.stdout.write(<span class="string">'请输入num1的值：'</span>);</span><br><span class="line">process.stdin.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!num1) &#123;</span><br><span class="line">    num1 = <span class="built_in">Number</span>(chunk);</span><br><span class="line">    process.stdout.write(<span class="string">'请输入num2的值: '</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      num2 = <span class="built_in">Number</span>(chunk)</span><br><span class="line">      process.stdout.write(<span class="string">'结果是：'</span> + (num1 + num2))</span><br><span class="line">      process.stdin.pause()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>提示：vscode的内置调试控制台默认不从stdout的输出流中抓取内容，需要在vscode的启动配置(launch.json)中添加如下配置：</strong> </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 使用 IntelliSense 了解相关属性。 </span></span><br><span class="line">  <span class="comment">// 悬停以查看现有属性的描述。</span></span><br><span class="line">  <span class="comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">  </span><br><span class="line">    <span class="string">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">    <span class="string">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"node"</span>,</span><br><span class="line">            <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="string">"outputCapture"</span>: <span class="string">"std"</span>,        <span class="comment">// 抓取stdout输出流的内容</span></span><br><span class="line">            <span class="string">"console"</span>: <span class="string">"externalTerminal"</span>, <span class="comment">// 另外打开控制台</span></span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"启动程序"</span>,</span><br><span class="line">            <span class="string">"program"</span>: <span class="string">"$&#123;file&#125;"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h3><p><code>Buffer</code> 类用于操作二进制数据流 。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) <span class="keyword">new</span> Buffer(size) （size [<span class="built_in">Number</span>]） 创建一个Buffer对象，并为这个对象分配空间大小</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> bf = <span class="keyword">new</span> Buffer(<span class="number">5</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(bf)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当我们为一个Buffer对象分配空间大小之后，其长度是固定的，不能更改</span></span><br><span class="line">  bf[<span class="number">5</span>]=<span class="number">1</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(bf);</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) <span class="keyword">new</span> Buffer([array]) 创建一个Buffer对象，并初始化</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer([<span class="number">0x62</span>, <span class="number">0x75</span>, <span class="number">0x66</span>, <span class="number">0x66</span>, <span class="number">0x65</span>, <span class="number">0x72</span>]);</span><br><span class="line">  <span class="built_in">console</span>.log(bf);</span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>) <span class="keyword">new</span> Buffer(sring,[encoding]) 创建一个Buffer对象，并使用字符串初始化,第二个参数用于指定字符串编码</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="string">'miaov'</span>,<span class="string">'utf-8'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(bf);</span><br><span class="line">  <span class="built_in">console</span>.log(bf[<span class="number">0</span>].toString(<span class="number">16</span>));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">String</span>.fromCharCode(bf[<span class="number">0</span>]));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">String</span>.fromCharCode(bf[<span class="number">1</span>]));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">String</span>.fromCharCode(bf[<span class="number">2</span>]));</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">String</span>.fromCharCode(bf[<span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line"> (<span class="number">4</span>) buf.length <span class="comment">// 输出的是字节长度</span></span><br><span class="line"> </span><br><span class="line">   <span class="keyword">var</span> str1=<span class="string">'miaov'</span>;</span><br><span class="line">   <span class="built_in">console</span>.log(str1.length);</span><br><span class="line">   <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(str1);</span><br><span class="line">   <span class="built_in">console</span>.log(bf.length);</span><br><span class="line">   <span class="keyword">var</span> str2=<span class="string">'妙味'</span>;</span><br><span class="line">   <span class="built_in">console</span>.log(str2.length);</span><br><span class="line">   <span class="keyword">var</span> bf2=<span class="keyword">new</span> Buffer(str2);</span><br><span class="line">   <span class="built_in">console</span>.log(bf2.length); <span class="comment">// 输出的是字节长度</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>) buf.write(string[, offset[, length]][, encoding]) 将字符串写入到Buffer中</span><br><span class="line">    string 要写入 buf 的字符串。</span><br><span class="line">    offset 从Buffer对象中的第几位开始写入。默认: <span class="number">0</span>。</span><br><span class="line">    length 写入的字符串的长度。默认: buf.length - offset。</span><br><span class="line">    encoding 字符编码。默认: <span class="string">'utf8'</span>。</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> str=<span class="string">'miaov'</span>;</span><br><span class="line">    <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="number">5</span>);</span><br><span class="line">    bf.write(str);</span><br><span class="line"></span><br><span class="line">    bf.write(str,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf);</span><br><span class="line"></span><br><span class="line">    bf.write(str,<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>) buf.toString([encoding[, start[, end]]]) 根据encoding参数，将Buffer对象输出为字符串</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="string">'miaov'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf.toString());</span><br><span class="line">    <span class="built_in">console</span>.log(bf.toString(<span class="string">'utf-8'</span>,<span class="number">1</span>,<span class="number">3</span>)); <span class="comment">//不包含结束位</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf2=<span class="keyword">new</span> Buffer(<span class="string">'妙味'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf2);</span><br><span class="line">    <span class="built_in">console</span>.log(bf2.toString(<span class="string">'utf-8'</span>,<span class="number">1</span>));</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"> (<span class="number">3</span>) buf.toJSON()将Buffer对象转换为<span class="built_in">JSON</span>格式</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="string">'miaov'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf.toJSON()); <span class="comment">// &#123;type: 'Buffer', data:[109,105,97,111,118]&#125;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"> (<span class="number">4</span>) buf.slice([start[, end]])返回一个新的buffer，这个buffer将和老的buffer引用相同的内存地址</span><br><span class="line"></span><br><span class="line">    注意：修改这个新的buffer对象，会改变原来老的buffer对象</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="string">'miaov'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf);</span><br><span class="line">    <span class="keyword">var</span> bf2=bf.slice(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf2);</span><br><span class="line"></span><br><span class="line">    bf2[<span class="number">0</span>]=<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(bf2);</span><br><span class="line">    <span class="built_in">console</span>.log(bf); <span class="comment">// 老的buffer也被改变了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> (<span class="number">5</span>) bf.copy(targetBuffer,[targetStart],[sourceStart],[sourceEnd])进行buffer的拷贝</span><br><span class="line"></span><br><span class="line">    修改新的buffer对象，不会会改变原来老的buffer对象</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf=<span class="keyword">new</span> Buffer(<span class="string">'miaov'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(bf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bf2=<span class="keyword">new</span> Buffer(<span class="number">6</span>);</span><br><span class="line">    bf.copy(bf2); <span class="comment">//将bf中的内容拷贝到bf2中</span></span><br><span class="line">    <span class="built_in">console</span>.log(bf2);</span><br><span class="line"></span><br><span class="line">    bf2[<span class="number">0</span>]=<span class="number">2</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(bf2);</span><br><span class="line">    <span class="built_in">console</span>.log(bf);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">静态方法</span><br><span class="line"></span><br><span class="line">Buffer.isEncoding(<span class="string">'utf-8'</span>)    检测Buffer对象是否支持某种编码</span><br><span class="line"></span><br><span class="line">Buffer.isBuffer(bf)   判断某个对象是否是Buffer对象</span><br><span class="line"></span><br><span class="line">Buffer.byteLength(str)           返回该字符串的字节长度，encoding编码默认是utf<span class="number">-8</span></span><br><span class="line"></span><br><span class="line">Buffer.concat(arr,[totallLength]) 返回一个将传入的buffer数组中所有的buffer对象拼接在一起新的buffer对象</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> str1=<span class="string">'miaov'</span>;</span><br><span class="line"><span class="keyword">var</span> str2=<span class="string">'妙味'</span>;</span><br><span class="line"><span class="keyword">var</span> arr=[<span class="keyword">new</span> Buffer(str1),<span class="keyword">new</span> Buffer(str2)];</span><br><span class="line"><span class="keyword">var</span> bf=Buffer.concat(arr,<span class="number">11</span>);<span class="comment">// 当第二个参数不给的时候，程序会默认计算buffer数组的总字节长度</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标准输入输出流中的内容也是二进制数据</span></span><br><span class="line">process.stdout.write(<span class="string">'请输入内容:'</span>);</span><br><span class="line">process.stdin.resume();</span><br><span class="line">process.stdin.on(<span class="string">'data'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(chunk); <span class="comment">// &lt;Buffer 61 0a&gt;   0a：回车</span></span><br><span class="line">  <span class="built_in">console</span>.log(chunk.toString());</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'输入的内容是：'</span> + chunk); <span class="comment">// 用+进行字符串拼接时，会自动对chunk进行字符串转换</span></span><br><span class="line">  process.stdin.pause();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="fs-文件系统"><a href="#fs-文件系统" class="headerlink" title="fs - 文件系统"></a>fs - 文件系统</h2><p><code>fs</code> 模块提供了一些 API，用于与文件系统进行交互，所有的文件系统操作都有异步和同步两种形式。 </p><h3 id="读写操作"><a href="#读写操作" class="headerlink" title="读写操作"></a>读写操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）打开一个文件</span><br><span class="line">fs.open(path,flags,[mode],callback)  异步</span><br><span class="line">fs.openSync(path, flags, [mode])     同步</span><br><span class="line"></span><br><span class="line">  path:  文件路径</span><br><span class="line">  flags: 打开文件的模式 读/写</span><br><span class="line">  mode:  设置文件的模式 读/写/执行  <span class="number">4</span>/<span class="number">2</span>/<span class="number">1</span></span><br><span class="line">  callback:</span><br><span class="line">    err: 文件打开失败时错误信息保存在err对象里面，如果成功err为<span class="literal">null</span></span><br><span class="line">    fd： 打开的文件的标识</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">  <span class="keyword">var</span> fileName = __dirname + <span class="string">'/'</span> + <span class="string">'1.txt'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//异步方式</span></span><br><span class="line">  fs.open(fileName, <span class="string">'r'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, fd</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(fd);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">//同步方式</span></span><br><span class="line">  <span class="keyword">var</span> fd = fs.openSync(fileName, <span class="string">'r'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(fd);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">2</span>）读取文件内容，从指定的文档标识符fd读取文件数据</span><br><span class="line"></span><br><span class="line">fs.read(fd, buffer, offset, length, position, callback)  异步</span><br><span class="line">fs.readSync(fd, buffer, offset, length, position)同步,返回bytesRead的个数</span><br><span class="line"></span><br><span class="line">  fd:通过open方法成功打开一个文件返回的编号,用来标识打开的文件</span><br><span class="line">  buffer：数据将被写入到的 buffer 对象</span><br><span class="line">  offset:读取的内容添加到buffer中的起始位置</span><br><span class="line">  length:是一个整数，指定要读取的字节数</span><br><span class="line">  position:读取文件的起始位置</span><br><span class="line">  callback: </span><br><span class="line">    error: 文件读取失败时错误信息保存在err对象里面，如果成功err为<span class="literal">null</span></span><br><span class="line">    bytesRead: 读取的字节数</span><br><span class="line">    buffer: 读取完成之后的buffer对象</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">  <span class="keyword">var</span> fileName = __dirname + <span class="string">'/'</span> + <span class="string">'1.txt'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步方式</span></span><br><span class="line">  fs.open(fileName, <span class="string">'r'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件打开失败'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> bf1 = <span class="keyword">new</span> Buffer(<span class="number">10</span>);</span><br><span class="line">      fs.read(fd, bf1, <span class="number">0</span>, <span class="number">4</span>, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> (<span class="params">error, bytesRead, buf</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(bytesRead);</span><br><span class="line">        <span class="built_in">console</span>.log(buf);</span><br><span class="line">        <span class="built_in">console</span>.log(buf.toString());</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 同步方式</span></span><br><span class="line">  fs.open(fileName, <span class="string">'r'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'文件打开失败'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> bf1 = <span class="keyword">new</span> Buffer(<span class="number">10</span>);</span><br><span class="line">      <span class="keyword">var</span> bytesRead = fs.readSync(fd, bf1, <span class="number">0</span>, <span class="number">2</span>, <span class="literal">null</span>)</span><br><span class="line">      <span class="built_in">console</span>.log(bytesRead)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">3</span>) 写入数据到指定文件中/关闭打开的文件</span><br><span class="line"></span><br><span class="line">  异步</span><br><span class="line">  写入 buffer 到 fd 指定的文件</span><br><span class="line">  fs.write(fd, buffer, offset, length[, position], callback) </span><br><span class="line">  </span><br><span class="line">    fd: 打开文件的标识</span><br><span class="line">    buffer：要写入的数据</span><br><span class="line">    offset：buffer对象中要写入的数据的起始位置</span><br><span class="line">    length: 是一个整数，指定要写入的字节数</span><br><span class="line">    position：指向从文件开始写入数据的的起始位置</span><br><span class="line">    callback：</span><br><span class="line">         error:  文件写入失败时错误信息保存在error对象里面，如果成功error为<span class="literal">null</span></span><br><span class="line">         bytesWritten: 写入的字节数</span><br><span class="line">         buffer: 读取完成之后的buffer对象</span><br><span class="line"> </span><br><span class="line">写入 string 到 fd 指定的文件，如果 string 不是一个字符串，则该值将被强制转换为一个字符串。</span><br><span class="line">  fs.write(fd, string[, position[, encoding]], callback) </span><br><span class="line">   fd: 打开文件的标识</span><br><span class="line">    string：写入string 到 fd 指定的文件</span><br><span class="line">    position：指向从文件开始写入数据的的起始位置</span><br><span class="line">    callback：</span><br><span class="line">         error:  文件写入失败时错误信息保存在error对象里面，如果成功error为<span class="literal">null</span></span><br><span class="line">         written: 写入的字节数</span><br><span class="line">         string: 读取完成之后的buffer对象</span><br><span class="line">         </span><br><span class="line"> 关闭一个打开的文件</span><br><span class="line">  fs.close(fd, callback)</span><br><span class="line"> </span><br><span class="line">  同步</span><br><span class="line">  fs.writeSync(fd, buffer, offset, length[, position])</span><br><span class="line">  fs.writeSync(fd, data[, position[, encoding]])</span><br><span class="line">  fs.closeSync(fd)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当我们要对打开的文件进行写操作的时候，打开文件的模式应该是读写方式 r+</span></span><br><span class="line">  fs.open(fileName, <span class="string">'r+'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, fd</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'打开文件失败'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> bf = <span class="keyword">new</span> Buffer(<span class="string">'abcd'</span>);</span><br><span class="line">    fs.write(fd, bf, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, bytesWritten, buf</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(bytesWritten)</span><br><span class="line">      <span class="built_in">console</span>.log(buf.toString())</span><br><span class="line">    &#125;)</span><br><span class="line">    fs.write(fd, <span class="string">'123'</span>, <span class="number">3</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err, written, string</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(written)</span><br><span class="line">      <span class="built_in">console</span>.log(string)</span><br><span class="line">    &#125;);</span><br><span class="line">    fs.close(fd, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;);</span><br><span class="line">    fs.write(fd, <span class="string">'9'</span>, <span class="number">7</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;); <span class="comment">//文件已经关闭，这段代码不会执行</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><u><code>fs.open</code></u>、<code>fs.read</code>、 <code>fs.write</code>等是更底层的操作，node提供了一些封装好的方法供开发者调用，可以更方便的对文件进行读写操作</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）写入数据</span><br><span class="line">fs.writeFlie(filename, data, [options], callback)  异步的将数据写入一个文件，如果该文件不存在，则新建，如果存在则覆盖原来的内容。data 可以是一个string，也可以是一个原生buffer。</span><br><span class="line">fs.writeFileSync(filename, data, [options])</span><br><span class="line"></span><br><span class="line">fs.appendFile(filename, data, [options], callback) 异步的将数据写入一个文件，如果该文件不存在，则新建，如果存在则添加到原内容后面。data 可以是一个string，也可以是一个原生buffer。</span><br><span class="line">fs.appendFileSync(filename, data, [options])</span><br><span class="line"></span><br><span class="line">fs.access(path[, mode], callback)    检查文件是否存在于当前目录</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">  <span class="keyword">var</span> filename = __dirname + <span class="string">'/'</span> + <span class="string">'2.txt'</span>;</span><br><span class="line">  </span><br><span class="line">  fs.writeFile(filename, <span class="string">'hello'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  fs.appendFile(filename, <span class="string">'-leo'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  fs.access(filename, fs.constants.F_OK, (err) =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;filename&#125;</span> <span class="subst">$&#123;err ? <span class="string">'不存在'</span> : <span class="string">'存在'</span>&#125;</span>`</span>);</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结合fs.access对文件进行读取操作</span></span><br><span class="line">  fs.access(filename, fs.constants.F_OK, (err) =&gt; &#123;</span><br><span class="line">     <span class="keyword">if</span>(err) &#123;</span><br><span class="line">       fs.writeFile(filename,<span class="string">'hello'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(err)&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'出错了'</span>);</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'创建新文件成功'</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       fs.appendFile(filename,<span class="string">'-leo'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">         <span class="keyword">if</span>(err)&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'新的内容添加失败'</span>);</span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">'新的内容添加成功'</span>);</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;)</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 同步模式</span></span><br><span class="line">  fs.access(filename, fs.constants.F_OK, (err) =&gt; &#123;</span><br><span class="line">     <span class="keyword">if</span>(err) &#123;</span><br><span class="line">       fs.writeFileSync(filename,<span class="string">'miaov'</span>);</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'新文件创建成功'</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       fs.appendFile(filename,<span class="string">'-leo'</span>);</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'新内容添加成功'</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">2</span>）读取数据</span><br><span class="line">fs.readFile(filename, [options], callback) 异步读取一个文件的全部内容</span><br><span class="line">fs.readFileSync(filename, [options])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line">  <span class="keyword">var</span> filename = __dirname + <span class="string">'/'</span> + <span class="string">'2.txt'</span>;</span><br><span class="line"></span><br><span class="line">   fs.readFile(filename, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (err) &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">' 文件读取失败'</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><h3 id="常用的文件操作"><a href="#常用的文件操作" class="headerlink" title="常用的文件操作"></a>常用的文件操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> fs.unlink(path, callback)  删除一个文件</span><br><span class="line"> fs.rename(oldPath, newPath, callback)  重命名</span><br><span class="line"> fs.stat(path, callback) 读取文件信息</span><br><span class="line"> fs.watch(filename, [options], [listener]) 监控文件的修改</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"> <span class="keyword">var</span> filename = __dirname + <span class="string">'/'</span> + <span class="string">'2.txt'</span>;</span><br><span class="line"></span><br><span class="line"> fs.unlink(filename,<span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(err)&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'删除成功'</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'删除失败'</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">fs.rename(filename,__dirname + <span class="string">'/'</span> + <span class="string">'3.txt'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(err)&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'重命名失败'</span>);</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'重命名成功'</span>);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">fs.stat(filename, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(stats);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.watch(filename, <span class="function"><span class="keyword">function</span> (<span class="params">eventType, fileName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fileName) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(eventType);</span><br><span class="line">    <span class="built_in">console</span>.log(fileName + <span class="string">'发生了改变'</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="常用的文件夹操作"><a href="#常用的文件夹操作" class="headerlink" title="常用的文件夹操作"></a>常用的文件夹操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">fs.mkdir(path, [mode], callback) 创建一个文件夹</span><br><span class="line">fs.rmdir(path, callback) 删除一个文件夹</span><br><span class="line">fs.readdir(path, callback) 读取文件夹</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"> </span><br><span class="line">fs.mkdir(__dirname + <span class="string">'/1'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(err);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.rmdir(__dirname + <span class="string">'/1'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">arguments</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fs.readdir(__dirname, <span class="function"><span class="keyword">function</span> (<span class="params">err, fileList</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// console.log(fileList); // 返回值是一个数组，包含了该文件夹下所有文件</span></span><br><span class="line">  fileList.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">    fs.stat(__dirname + <span class="string">'/'</span> + item, <span class="function"><span class="keyword">function</span> (<span class="params">err, stats</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (stats.mode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16822</span>:</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'[文件夹]: '</span> + item);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">33206</span>:</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'[文件]: '</span> + item);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'其他类型: '</span> + item);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="http-HTTP"><a href="#http-HTTP" class="headerlink" title="http-HTTP"></a>http-HTTP</h2><p>  通过http模块，可以非常方便的搭建一个http服务器。</p><h3 id="搭建http服务器"><a href="#搭建http服务器" class="headerlink" title="搭建http服务器"></a>搭建http服务器</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 加载一个http模块</span></span><br><span class="line"> <span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"> （<span class="number">1</span>） 通过http模块下的 createServer 创建并返回一个http服务器对象 </span><br><span class="line">     http.createServer([requestListener])</span><br><span class="line">     requestListener : 监听到客户端连接的回调函数(request事件的回调函数，也可以采用下面的写法)</span><br><span class="line">     </span><br><span class="line">  <span class="keyword">var</span> server = http.createServer();</span><br><span class="line"></span><br><span class="line"> （<span class="number">2</span>） 监听客户端连接请求，只有当调用了listen方法以后，服务器才开始工作</span><br><span class="line">       server.listen(port, [hostname], [backlog], [callback])</span><br><span class="line">       port : 监听的端口</span><br><span class="line">       hostname : 主机名（IP/域名)</span><br><span class="line">       backlog : 连接等待队列的最大长度</span><br><span class="line">       callback : 调用listen方法并成功开启监听以后，会触发一个listening事件，callback将作为该事件的          执行函数</span><br><span class="line"></span><br><span class="line"> server.listen(<span class="number">8080</span>, <span class="string">'localhost'</span>);</span><br><span class="line"></span><br><span class="line"> (<span class="number">3</span>) error 事件 当服务开启失败的时候触发的事件 参数err : 具体的错误对象</span><br><span class="line"></span><br><span class="line"> server.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'err'</span>);</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line"> (<span class="number">4</span>) 当server调用listen方法并成功开始监听以后触发的事件，该事件的回调也可以在listen方法中使用</span><br><span class="line"></span><br><span class="line"> server.on(<span class="string">'listening'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'listenning'</span>);</span><br><span class="line"> &#125;)</span><br><span class="line"></span><br><span class="line">(<span class="number">5</span>) request事件: 当有客户端发送请求的时候触发</span><br><span class="line">    参数：</span><br><span class="line">     req对象 ：通过它我们可以获取到这次请求的一些信息，比如头信息，数据等    </span><br><span class="line">     res对象 ：通过他我们可以向该次请求的客户端输出返回响应</span><br><span class="line">      </span><br><span class="line">     req对象:    </span><br><span class="line">     httpVersion : 使用的http协议的版本</span><br><span class="line">     headers : 请求头信息中的数据</span><br><span class="line">     url : 请求的地址</span><br><span class="line">     method : 请求方式</span><br><span class="line"></span><br><span class="line">     res对象 </span><br><span class="line">     write(chunk, [encoding]) : 发送一个数据块到响应正文中</span><br><span class="line">     end([chunk], [encoding]) : 当所有的正文和头信息发送完成以后调用该方法告诉服务器数据已经全部发送完成了，这个方法在每次完成信息发送以后必须调用，并且是最后调用</span><br><span class="line">     statusCode : 该属性用来设置返回的状态码</span><br><span class="line">     setHeader(name, value) : 设置返回头信息</span><br><span class="line">     writeHead(statusCode, [reasonPhrase], [headers]) : 这个方法只能在当前请求中使用一次，并且必须在response.end()之前调用</span><br><span class="line"></span><br><span class="line"> server.on(<span class="string">'request'</span>,<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'有用户连接进来了'</span>);</span><br><span class="line">   res.writeHead(<span class="number">200</span>,<span class="string">'OK'</span>,&#123;</span><br><span class="line">     <span class="comment">//'content-type':'text/plain',//纯文本</span></span><br><span class="line">     <span class="string">'content-type'</span>:<span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">   &#125;);</span><br><span class="line">   res.write(<span class="string">'&lt;h1&gt;你好，欢迎学习node&lt;/h1&gt;'</span>);</span><br><span class="line">   res.end(); <span class="comment">// 当所有的正文和头信息发送完成以后调用该方法告诉服务器数据已经全部发送完成了</span></span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure><h3 id="url处理"><a href="#url处理" class="headerlink" title="url处理"></a>url处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">上一个例子中，监听到request事件时(当有客户端发送请求时)，返回的数据都是一样的</span><br><span class="line">实际开发过程中，对于不同请求，我们需要返回不同的数据,所以需要用到url模块对req对象中的url进行处理</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"> </span><br><span class="line">(<span class="number">1</span>)url.parse(request.url): 对url格式的字符串进行解析，返回一个对象,不同的url处理之后返回的数据是不同的 </span><br><span class="line"><span class="keyword">var</span> urlObj = url.parse(<span class="string">'http://www.baidu.com:8080/a/b?age=23&amp;name=jack#p=1'</span>)</span><br><span class="line"><span class="built_in">console</span>.log(urlObj);</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)利用url模块处理request.url，对于不同的pathname(路径),返回不同的数据,即做出不同的响应</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer();</span><br><span class="line">server.listen(<span class="number">8080</span>, <span class="string">'localhost'</span>);</span><br><span class="line"></span><br><span class="line">server.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//req.url: 访问路径</span></span><br><span class="line">  <span class="comment">//console.log(req.url);</span></span><br><span class="line">  <span class="keyword">var</span> urlObj = url.parse(req.url);</span><br><span class="line">  <span class="keyword">switch</span> (urlObj.pathname) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">      <span class="comment">//首页</span></span><br><span class="line">      res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      res.end(<span class="string">'&lt;h1&gt;这是首页&lt;/h1&gt;'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/user'</span>:</span><br><span class="line">      <span class="comment">//个人中心</span></span><br><span class="line">      res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      res.end(<span class="string">'&lt;h1&gt;这是个人中心&lt;/h1&gt;'</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">     <span class="comment">//处理其他情况</span></span><br><span class="line">     res.writeHead(<span class="number">404</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">     &#125;)</span><br><span class="line">     res.end(<span class="string">'&lt;h1&gt;页面不见了&lt;/h1&gt;'</span>);</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="请求数据处理"><a href="#请求数据处理" class="headerlink" title="请求数据处理"></a>请求数据处理</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">  使用fs模块实现nodejs代码和html的分离</span><br><span class="line"> queryString模块  对<span class="keyword">get</span>和和post方法提交的数据进行处理</span><br><span class="line">  queryString.parse() : 将一个 querystring 反序列化为一个对象</span><br><span class="line"></span><br><span class="line">    var http = require('http');</span><br><span class="line">    var url = require('url');</span><br><span class="line">    var fs = require('fs');</span><br><span class="line"></span><br><span class="line">   通过req.method 拿到请求的方法</span><br><span class="line">   (1) <span class="keyword">get</span>请求的数据处理 ：<span class="keyword">get</span>请求的数据在querystring中，通过url.parse解析之后可以存放在query属性中。 qs.parse(urlObj.query)</span><br><span class="line">   (2) post请求的数据处理 : post发送的数据会被写入缓冲区中(buffer)，需要通过resquest的data和end事件来获取数据，并且用 + 进行字符串拼接或者 chunk.toString()，对chunk进行字符串转换。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var qs = require('querystring');</span><br><span class="line">var server = http.createServer();</span><br><span class="line"></span><br><span class="line">//保存html目录路径</span><br><span class="line"></span><br><span class="line">var HtmlDir = __dirname + '/html';</span><br><span class="line">server.listen(8080, 'localhost');</span><br><span class="line">server.on('request', function (req, res) &#123;</span><br><span class="line">  <span class="keyword">var</span> urlObj = url.parse(req.url);</span><br><span class="line">  <span class="keyword">switch</span> (urlObj.pathname) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/'</span>:</span><br><span class="line">      <span class="comment">// 首页</span></span><br><span class="line">      sendData(HtmlDir + <span class="string">'/index.html'</span>, req, res);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/user'</span>:</span><br><span class="line">      <span class="comment">// 个人中心</span></span><br><span class="line">      sendData(HtmlDir + <span class="string">'/user.html'</span>, req, res);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/login'</span>:</span><br><span class="line">      <span class="comment">// 登录页面</span></span><br><span class="line">      sendData(HtmlDir + <span class="string">'/login.html'</span>, req, res);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/login/check'</span>:</span><br><span class="line">      <span class="comment">// 登录验证</span></span><br><span class="line">      <span class="comment">// get请求</span></span><br><span class="line">      <span class="comment">// qs.parse(urlObj.query)   </span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// post请求 nodejs用req.on(data)接收客户端的post请求数据</span></span><br><span class="line">      <span class="keyword">if</span> (req.method.toUpperCase() == <span class="string">'POST'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> str = <span class="string">''</span>;</span><br><span class="line">        req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">          str += chunk; <span class="comment">// 用 + 进行字符串拼接时，会自动对chunk进行字符串转换，等同于 chunk.toString()</span></span><br><span class="line">        &#125;)</span><br><span class="line">        req.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="built_in">console</span>.log(qs.parse(str));</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">//处理其他情况</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendData</span>(<span class="params">file, req, res</span>) </span>&#123;</span><br><span class="line">  fs.readFile(file, <span class="function"><span class="keyword">function</span> (<span class="params">err, data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      res.writeHead(<span class="number">404</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      res.end(<span class="string">'&lt;h1&gt;页面不见了......&lt;/h1&gt;'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'content-type'</span>: <span class="string">'text/html;charset=utf-8'</span></span><br><span class="line">      &#125;)</span><br><span class="line">      res.end(data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">总结： http模块配合url模块、fs模块、queryString搭建了一个对于不同的http请求进行响应的web服务器</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;module-模块&quot;&gt;&lt;a href=&quot;#module-模块&quot; class=&quot;headerlink&quot; title=&quot;module - 模块&quot;&gt;&lt;/a&gt;module - 模块&lt;/h2&gt;&lt;h3 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerli
      
    
    </summary>
    
      <category term="Node" scheme="https://gyunzhi.github.io/categories/Node/"/>
    
    
      <category term="Node" scheme="https://gyunzhi.github.io/tags/Node/"/>
    
  </entry>
  
  <entry>
    <title>Node、NPM安装</title>
    <link href="https://gyunzhi.github.io/2018/10/06/Node%E3%80%81NPM%E5%AE%89%E8%A3%85/"/>
    <id>https://gyunzhi.github.io/2018/10/06/Node、NPM安装/</id>
    <published>2018-10-06T13:09:59.000Z</published>
    <updated>2019-07-11T13:13:31.495Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Node环境的安装"><a href="#Node环境的安装" class="headerlink" title="Node环境的安装"></a>Node环境的安装</h3><h4 id="官网下载安装"><a href="#官网下载安装" class="headerlink" title="官网下载安装"></a>官网下载安装</h4><p>官方地址：<a href="https://nodejs.org/en/" target="_blank" rel="noopener">https://nodejs.org/en/</a> 或 <a href="https://nodejs.org/zh-cn/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/</a> </p><p>下载完成之后直接双击安装即可，安装完成之后会自动添加node、npm环境变量，安装完成之后打开控制台，执行以下命令，测试是否安装成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v  查看   node 版本</span><br><span class="line">npm -v   查看   npm 版本</span><br></pre></td></tr></table></figure><h4 id="使用nvm安装"><a href="#使用nvm安装" class="headerlink" title="使用nvm安装"></a>使用nvm安装</h4><p>   操作系统环境： windows 7 x64 </p><p>   安装nvm之前如果已经安装了node，没有关系，直接安装nvm，安装完成之后nvm会自动管理已经安装好的 node。</p><p>（1）安装nvm</p><ul><li>安装<a href="https://github.com/coreybutler/nvm-windows#node-version-manager-nvm-for-windows" target="_blank" rel="noopener">nvm-windows</a> ，注意安装路径不要有中文或者空格，安装完成之后会自动添加环境变量</li><li>安装过程有一个Set Node.js Symlink的步骤，作用是设置一个快捷方式，这个路径可以nvm一样，也可以不一样，看个人习惯。</li><li>安装成功之后我们可以看一下nvm/settings.txt这个文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root: D:\nvm // nvm安装目录</span><br><span class="line">path: C:\Program Files\nodejs //快捷方式目录</span><br></pre></td></tr></table></figure><ul><li>执行以下代码，测试是否安装成功</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvm version</span><br><span class="line">1.1.7  // 安装成功</span><br></pre></td></tr></table></figure><p>（2）安装node</p><p>安装成功之后，接下来使用nvm命令来安装和使用指定的node版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nvm install &lt;version&gt; &lt;arch&gt;  // 安装指定版本的node</span><br><span class="line"></span><br><span class="line">nvm install 8.11.3</span><br><span class="line">nvm install latest // 安装最新版本</span><br><span class="line">nvm install 8.11.3 32 // 32位操作系统需指定arch值，声明系统架构为32位</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nvm list  // 查看已经安装的node</span><br><span class="line">8.11.3</span><br><span class="line">    10.12.0</span><br><span class="line">  </span><br><span class="line">nvm use 8.11.3 // 使用指定版本的node</span><br><span class="line">Now using node v8.11.3 (64-bit)</span><br></pre></td></tr></table></figure><p>（3）快捷方式的作用，直接在安装nvm的时候设置了一个快捷方式目录，这里做一个说明，在C:\Program Files下会有一个nodejs，它是一个快捷方式，和我们当前nvm使用的那个node版本对应的文件夹是管理在一起的，如现在node的版本是8.11.3，那么当前这个快捷方式的文件夹和<code>D:\nvm\v8.11.3</code>文件夹是关联的。当使用<code>nvm use &lt;version&gt;</code>切换其他的node版本后，它就会和切换之后的node对应的文件夹进行关联。</p><h3 id="NPM全局模块和局部模块"><a href="#NPM全局模块和局部模块" class="headerlink" title="NPM全局模块和局部模块"></a>NPM全局模块和局部模块</h3><p>在安装node的同时，会一起安装好npm模块，安装完成后，要设置镜像源，以加快下载速度：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">npm config <span class="built_in">set</span> disturl https://npm.taobao.org/dist</span><br></pre></td></tr></table></figure><p>设置完成之后可以在<code>C:\Users\Administrator\.npmrc</code>目录下查看到刚才的配置</p><p>我们知道npm安装的依赖可以是全局的，也可以是局部的，局部的模块是安装在项目中的的<code>node_modules</code>中。全局安装的模块有一些不同，可以通过<code>npm config get prefix</code> 查看全局模块安装的位置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">（1）通过官网下载安装的node </span><br><span class="line">  npm config get prefix</span><br><span class="line">  C:\Users\Administrator\AppData\Roaming\npm // 默认位置</span><br><span class="line"></span><br><span class="line">（2）通过nvm安装的node</span><br><span class="line">  npm config get prefix</span><br><span class="line">  C:\Program Files\nodejs</span><br></pre></td></tr></table></figure><p>npm中还有一个缓存目录，可以通过<code>npm config get cache</code>查看</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config get cache</span><br><span class="line">C:\Users\Administrator\AppData\Roaming\npm-cache</span><br></pre></td></tr></table></figure><p>修改全局模块目录和缓存目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> prefix <span class="string">'C:\Program Files\nodejs\node_global'</span></span><br><span class="line">npm config <span class="built_in">set</span> cache <span class="string">'C:\Program Files\nodejs\node_cache'</span></span><br><span class="line"></span><br><span class="line">// 安装完成之后需配置环境变量</span><br><span class="line">Path <span class="string">"，输入'C:\Program Files\nodejs\node_global'</span></span><br></pre></td></tr></table></figure><p>安装yarn，我个人习惯使用yarn，所以在配置好npm后会先下载yarn，并且配置镜像源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn config <span class="built_in">set</span> registry https://registry.npm.taobao.org --global </span><br><span class="line">yarn config <span class="built_in">set</span> disturl https://npm.taobao.org/dist --global</span><br></pre></td></tr></table></figure><p>同样的yarn的依赖也分为全局和局部依赖，我们可以通过<code>yarn global dir</code> 查看yarn全局安装的模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn global dir</span><br><span class="line">C:\Users\Administrator\AppData\Local\Yarn\Data\global</span><br></pre></td></tr></table></figure><p>注意事项：个人建议先安装node，在安装nvm，然后然nvm自动管理已经安装好的node，因为卸载node，通过nvm去安装时，全局模块安装的默认位置在<code>C:\Program Files\nodejs</code>，这个时候需要我们去修改手动修改全局模块和缓存目录，其次不能使用yarn去安装全局模块，原因目前暂时不知道。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Node环境的安装&quot;&gt;&lt;a href=&quot;#Node环境的安装&quot; class=&quot;headerlink&quot; title=&quot;Node环境的安装&quot;&gt;&lt;/a&gt;Node环境的安装&lt;/h3&gt;&lt;h4 id=&quot;官网下载安装&quot;&gt;&lt;a href=&quot;#官网下载安装&quot; class=&quot;head
      
    
    </summary>
    
      <category term="Node" scheme="https://gyunzhi.github.io/categories/Node/"/>
    
    
      <category term="Node" scheme="https://gyunzhi.github.io/tags/Node/"/>
    
  </entry>
  
  <entry>
    <title>Javascript异步编程的演进</title>
    <link href="https://gyunzhi.github.io/2018/09/09/Javascript%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E7%9A%84%E6%BC%94%E8%BF%9B/"/>
    <id>https://gyunzhi.github.io/2018/09/09/Javascript异步编程的演进/</id>
    <published>2018-09-09T13:12:56.000Z</published>
    <updated>2019-05-06T09:26:27.124Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一、Javascript-异步的由来"><a href="#一、Javascript-异步的由来" class="headerlink" title="一、Javascript 异步的由来"></a>一、Javascript 异步的由来</h2><h3 id="Javascript-单线程"><a href="#Javascript-单线程" class="headerlink" title="Javascript 单线程"></a>Javascript 单线程</h3><p>大家都知道 js 是单线程的，那为什么要是单线程的呢？</p><p>因为 js 的运用场景是浏览器，包含了很多用户的交互，如果是多线程，那一个线程要在某个 DOM 上添加内容，另一个线程直接要删除这个 DOM，那浏览器到底听哪个的好呢？所以为了降低复杂性，js 从一诞生，就是单线程，这也是这门语言的核心特征，因为 js 一开始就是为浏览器而生的</p><p>既然是单线程，也就是每次只执行一个任务，只有等到当前任务执行完毕，才能执行后面的任务，这些任务会形成一个任务队列，排队等候执行</p><p>就像大家去超市买东西排队结账，得前面一个人付完钱，排在他后面的那个才能买单。但是如果前面一个任务很耗时，比如正常每个人手里都是拿着一两样东西等着排队，而你前面那位大哥推着满满一车的东西，你是不是得崩溃了？</p><p>所以像我们平时遇到的浏览器无响应和页面假死，往往是因为某段 js 代码执行时间过长，或者直接陷入死循环，导致页面卡死，后面的任务当然就无法继续执行了</p><p>但是，在前端的某些任务的确是非常耗时的，比如网络请求、定时器和事件监听等等，如果让他们和别的任务一样都老老实实的排队等待执行的话，执行效率会非常低。所以，这时候浏览器为这些耗时的任务开辟了另外的线程，主要包括事件触发线程、定时器触发线程和异步 HTTP 请求线程</p><h3 id="浏览器多线程"><a href="#浏览器多线程" class="headerlink" title="浏览器多线程"></a>浏览器多线程</h3><p>浏览器渲染进程是多线程的，它包含如下线程：</p><ul><li>GUI 渲染线程</li><li>JS 引擎线程</li><li>事件触发线程</li><li>定时器触发线程</li><li>异步 HTTP 请求线程</li></ul><h4 id="1、GUI-渲染线程"><a href="#1、GUI-渲染线程" class="headerlink" title="1、GUI 渲染线程"></a>1、GUI 渲染线程</h4><p>负责渲染浏览器界面，解析 HTML、CSS<br>当界面需要重绘（Repaint）或由于某种操作引发回流（Reflow）时，该线程就会执行<br>GUI 渲染线程与 JS 引擎线程是互斥的，因为 JS 可以操作 DOM 元素， 从而影响到 GUI 的渲染结果，当 JS 引擎执行时 GUI 线程会被挂起，GUI 更新会被保存在一个队列中等到 JS 引擎空闲时立即被执行</p><h4 id="2、JS-引擎线程"><a href="#2、JS-引擎线程" class="headerlink" title="2、JS 引擎线程"></a>2、JS 引擎线程</h4><p>JS 内核（例如V8引擎），负责处理 Javascript 脚本程序<br>JS 引擎一直等待着任务队列中任务的到来，然后加以处理<br>因为 GUI 渲染线程与JS引擎线程是互斥的，所以如果 JS 执行时间过长，页面渲染就不连贯，造成页面渲染加载阻塞</p><h4 id="3、事件触发线程"><a href="#3、事件触发线程" class="headerlink" title="3、事件触发线程"></a>3、事件触发线程</h4><p>由于 JS 引擎这个单线程的家伙自己都忙不过来，所以需要浏览器另开一个线程协助它<br>待处理队列中的事件都得排队等待 JS 引擎处理（当 JS 引擎空闲时才会去执行）</p><h4 id="4、定时触发器线程"><a href="#4、定时触发器线程" class="headerlink" title="4、定时触发器线程"></a>4、定时触发器线程</h4><p>setInterval 与 setTimeout所在线程<br>JS 引擎阻塞状态下计时不准确，所以由浏览器另开线程单独计时<br>计时完毕后，添加到事件队列中，等待 JS 引擎空闲后执行</p><h4 id="5、异步-HTTP-请求线程"><a href="#5、异步-HTTP-请求线程" class="headerlink" title="5、异步 HTTP 请求线程"></a>5、异步 HTTP 请求线程</h4><p>如果请求有回调事件，异步线程就产生<strong>状态变更事件</strong>，将这个回调再放入事件队列中，等 JS 引擎空闲后执行</p><h3 id="事件循环（Event-Loop）"><a href="#事件循环（Event-Loop）" class="headerlink" title="事件循环（Event Loop）"></a>事件循环（Event Loop）</h3><p>js 一直在做一个工作，就是从任务队列里提取任务，放到主线程里执行，看下面这张图：</p><p><img src="http://img.gongyz.cn/blog/20190123/u8rkfQEHPu7h.png?imageslim" alt="mark"></p><ul><li>JS 运行时引擎(runtime)：也就是 js 线程，由内存堆(heap)和调用栈(stack)组成，其中内存堆是用于内存分配，调用栈是代码执行时的栈</li><li>Web APIs：上文中说到的浏览器为异步任务单独开辟的线程在这里可以统一理解为 Web APIs</li><li>回调队列(callback queue)：也就是任务队列，上面 Web APIs 子线程任务执行结束后会将任务的回调函数推入回调队列</li><li>事件循环(Event Loop)：事件轮询机制，观察运行时调用栈是否为空，如果为空，将回调队列中的任务推到调用栈，回调队列遵循先入先出(FIFO)的原则，也就是按照子线程执行任务完成顺序依次被调用</li></ul><p>我们再来看一个经典的问题，下面代码输出的结果是什么：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">&#125;,<span class="number">0</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>结果是 2、1，因为执行 setTimeout 会立即交给浏览器的定时触发器线程去处理，计时完毕后会把匿名函数放到任务队列里等待 js 主线程调用，但这个时候 js 线程里的 stack 并不是空的，因为还有一句 <code>console.log(2)</code>。</p><p>要等到 <code>console.log(2)</code>执行完之后，才通过事件循环把匿名函数推到 stack 里面去执行</p><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>js 从诞生起是单线程的，所谓的 js 异步，其实是由单线程的 js、多线程的宿主浏览器和事件循环机制共同作用而成</p><h2 id="二、Javascript-异步编程的演进"><a href="#二、Javascript-异步编程的演进" class="headerlink" title="二、Javascript 异步编程的演进"></a>二、Javascript 异步编程的演进</h2><h3 id="1、回调函数"><a href="#1、回调函数" class="headerlink" title="1、回调函数"></a>1、回调函数</h3><p>实现 js 异步编程最基础方式的就是『回调函数』，这里列举几个大家熟悉的场景，比如：Ajax 请求、IO 操作或者定时器</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ajax(url, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="comment">//回调函数</span></span><br><span class="line">&#125;);</span><br><span class="line">setTimeOut(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="comment">//回调函数</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure><p>如上面代码，回调本身没什么毛病，是比较好用的，但是随着 Web 前端的复杂度不断提高，以及 js 应用场景的不断拓宽，光是回调已经不够用了</p><p>因为我们阅读和编写程序是顺序的，对于复杂的回调函数会不易理解，所以我们需要一种同步的、顺序的方式来表达异步，看下面栗子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数实现两数相加，两个数字都是异步获取</span></span><br><span class="line"><span class="comment">// 这里 fetchX() 和 fetchY() 是异步获取数字的 Ajax 请求，接受一个回调函数作为参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">getX,  getY, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> x, y</span><br><span class="line">  getX(<span class="function"><span class="keyword">function</span>(<span class="params">xVal</span>) </span>&#123;</span><br><span class="line">    x = xVal</span><br><span class="line">    <span class="keyword">if</span> (y != <span class="literal">undefined</span>) &#123;</span><br><span class="line">      cb(x + y)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  getY(<span class="function"><span class="keyword">function</span>(<span class="params">yVal</span>) </span>&#123;</span><br><span class="line">    y = yVal</span><br><span class="line">    <span class="keyword">if</span>(x != <span class="literal">undefined</span>) &#123;</span><br><span class="line">      cb(x + y)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">add(fetchX, fetchY, <span class="function"><span class="keyword">function</span>(<span class="params">sum</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(sum)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>再来看下用 Promise 怎么实现：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Promise 实现两数相加</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">xPromise, yPromise</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.all([xPromise, yPromise])</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">values</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> values[<span class="number">0</span>] + values[<span class="number">1</span>]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这里 fetchX()、fetchY()返回相应值的 Promise</span></span><br><span class="line">add(fetchX(), fetchY())</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span>(<span class="params">sum</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(sum)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>这里只需保证 fetchX() 和 fetchY() 返回的是 Promise，然后直接用 <code>Promise.all</code> 即可</p><p>显然第二种处理起来是不是顺畅得多？</p><h3 id="2、Promise"><a href="#2、Promise" class="headerlink" title="2、Promise"></a>2、Promise</h3><p><code>Promise</code> 是一种弥补回调函数不足的异步解决方案，最早由社区提出并实现，后来写进了 es6 规范</p><p>简单地说，<code>Promise</code> 是一个特殊的对象，它可以表示异步操作的成功或者失败，同时返回异步操作的执行结果</p><h4 id="理解-Promise"><a href="#理解-Promise" class="headerlink" title="理解 Promise"></a>理解 Promise</h4><p>什么意思呢，上面的解释可能还是不够直观，咱们举个栗子：</p><p>假设你苦苦追求的女神，有一天终于禁不住你的死缠烂打，答应跟你去看电影了。那答应跟你去看电影这个事情就是一个<strong>承诺（Promise）</strong>。可其实你心里也没底，你并不知道女神会不会真的陪你去看电影，女神可能兑现承诺，也可能放你鸽子</p><p>这就是 Promise，一个 Promise 有三种状态：</p><ol><li>Promise 是<strong>待定的（pending）</strong>： 你并不知道女神会不会真的陪你去看电影</li><li>Promise 是<strong>已解决的（resolved）</strong>：女神兑现承诺</li><li>Promise 是<strong>被拒绝的（rejected）</strong>:  被放鸽子</li></ol><h4 id="创建一个-Promise"><a href="#创建一个-Promise" class="headerlink" title="创建一个 Promise"></a>创建一个 Promise</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> isHayyp = <span class="literal">false</span></span><br><span class="line"><span class="keyword">let</span> watchingMovies = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isHayyp) &#123;</span><br><span class="line">      <span class="keyword">const</span> movie = &#123;</span><br><span class="line">        name: <span class="string">'海王'</span>,</span><br><span class="line">        time: <span class="string">'2018-12-27 18:20'</span></span><br><span class="line">      &#125;</span><br><span class="line">    resolve(movie)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'女神心情不好'</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">watchingMovies.then(<span class="function">(<span class="params">movie</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 女神兑现承诺，一起去看了电影</span></span><br><span class="line">    <span class="comment">// 然后再一起去吃饭</span></span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 女神心情不好，被放鸽子了，回家打游戏</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>以上两段代码，第一段是调用 <code>Promise</code> 构造函数，第二段是调用了 <code>Promise</code> 实例的 <code>.then</code> 方法</p><ol><li>构造函数<ul><li>构造函数接受一个函数作为参数</li><li>调用构造函数得到实例 watchingMovies 的同时，作为参数的函数会立即执行</li><li>参数函数接受两个回调函数参数 resolve 和 reject</li><li>在参数函数被执行的过程中，如果在其内部调用 resolve，会将 watchingMovies 的状态变成 fulfilled，或者调用 reject，会将 watchingMovies 的状态变成 rejected</li></ul></li><li>调用 <code>.then</code><ul><li>调用 <code>.then</code> 可以为实例 p 注册两种状态回调函数</li><li>当实例 watchingMovies 的状态为 fulfilled，会触发第一个函数执行</li><li>当实例 watchingMovies 的状态为 rejected，则触发第二个函数执行</li></ul></li></ol><p>我们结合上面讲的 js 异步，再来看下面这段代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">  resolve()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>打印结果是 132，<code>Promise</code> 新建后立即执行，所以首先输出的是 1。然后，<code>then</code> 方法注册的回调函数，将在当前脚本所有同步任务执行完才会执行，所以 2 最后输出</p><h4 id="Promise-API"><a href="#Promise-API" class="headerlink" title="Promise API"></a>Promise API</h4><p>Promise 的 API 分为构造函数、实例方法和静态方法</p><ul><li>1个构造函数： <code>new Promise</code></li><li>3个实例方法：<code>.then</code> 、 <code>.catch</code> 和 <code>.finally</code></li><li>4个静态方法：<code>Promise.all</code>、<code>Promise.race</code>、<code>Promise.resolve</code> 和 <code>Promise.reject</code></li></ul><p>#####1、<code>.then</code>方法</p><p><code>.then</code>方法返回的是一个新的 <code>Promise</code> 实例（注意，不是原来那个 <code>Promise</code> 实例）。因此可以采用链式写法，即 <code>.then</code> 方法后面再调用另一个 <code>.then</code> 方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">"/posts.json"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> json.post</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>上面的代码使用 <code>.then</code> 方法，依次注册了两个回调函数。第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数</p><p>#####2、<code>.catch</code>方法</p><p>处理异常的推荐写法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不推荐</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// success</span></span><br><span class="line">&#125;, (err) =&gt; &#123;</span><br><span class="line">  <span class="comment">// error</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 推荐</span></span><br><span class="line">promise.then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// success</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// error</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>因为 catch 可以捕获到 then 里的异常</p><p>Promise 对象的错误具有『冒泡』性质，会一直向后传递，直到被捕获为止。也就是说，错误总是会被下一个 <code>catch</code> 捕获</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getJSON(<span class="string">'/post/1.json'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getJSON(post.commentURL)</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">comments</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// some code</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 处理前面三个Promise产生的错误</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>上面代码中，一共有三个 Promise 对象：一个由 <code>getJSON</code> 产生，两个由 <code>then</code> 产生。它们之中任何一个抛出的错误，都会被最后一个 <code>catch</code> 捕获</p><p>#####3、<code>Promise.all</code>方法</p><p><code>Promise.all</code> 方法用于将多个 Promise 实例，包装成一个新的 Promise 实例</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.all([p1, p2, p3])</span><br></pre></td></tr></table></figure><p>上面代码中，<code>Promise.all</code> 方法接受一个数组作为参数，<code>p1</code>、<code>p2</code>、<code>p3</code> 都是 Promise 实例，如果不是，就会先调用 <code>Promise.resolve</code> 方法，将参数转为 Promise 实例</p><p><code>p</code> 的状态由<code>p1</code>、<code>p2</code>、<code>p3</code>决定，分成两种情况：</p><p>（1）只有<code>p1</code>、<code>p2</code>、<code>p3</code>的状态都变成<code>fulfilled</code>，<code>p</code>的状态才会变成<code>fulfilled</code>，此时<code>p1</code>、<code>p2</code>、<code>p3</code>的返回值组成一个数组，传递给<code>p</code>的回调函数</p><p>（2）只要<code>p1</code>、<code>p2</code>、<code>p3</code>之中有一个被<code>rejected</code>，<code>p</code>的状态就变成<code>rejected</code>，此时第一个被<code>reject</code>的实例的返回值，会传递给<code>p</code>的回调函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个 Promise 对象的数组</span></span><br><span class="line"><span class="keyword">const</span> promiseList = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>].map(<span class="function"><span class="keyword">function</span> (<span class="params">id</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getJSON(<span class="string">'/post/'</span> + id + <span class="string">".json"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all(promises).then(<span class="function"><span class="keyword">function</span> (<span class="params">posts</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">reason</span>)</span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>上面代码中，<code>promiseList</code> 是包含 6 个 Promise 实例的数组，只有这 6 个实例的状态都变成 <code>fulfilled</code>，或者其中有一个变为 <code>rejected</code>，才会调用 <code>Promise.all</code> 方法后面的回调函数</p><p>#####4、<code>Promise.race</code>方法</p><p><code>Promise.race</code> 方法同样是将多个 Promise 实例，包装成一个新的 Promise 实例</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="built_in">Promise</span>.race([p1, p2, p3])</span><br></pre></td></tr></table></figure><p>但不同的是，这里只要 <code>p1</code>、<code>p2</code>、<code>p3</code>之中有一个实例率先改变状态，<code>p</code>的状态就跟着改变。那个率先改变的 Promise 实例的返回值，就传递给 <code>p</code> 的回调函数</p><p>#####5、<code>Promise.resolve</code> 和 <code>Promise.reject</code>方法</p><p><code>Promise.resolve</code> 会返回一个状态为 fulfilled 状态的 Promise 对象，<code>Promise.reject</code> 与 <code>Promise.resolve</code> 同理，区别在于返回的 Promise 对象状态为 rejected</p><p><code>Promise.resolve</code> 等价于下面的写法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'foo'</span>)</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(<span class="string">'foo'</span>))</span><br></pre></td></tr></table></figure><h4 id="Promise-和-setTimeout-的执行顺序"><a href="#Promise-和-setTimeout-的执行顺序" class="headerlink" title="Promise 和 setTimeout 的执行顺序"></a>Promise 和 setTimeout 的执行顺序</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve</span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">resolve()</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>以上代码运行结果是 2431，为什么不是 2413，不是 setTimeout 先加入任务队列的么？</p><p>所以这里又要从任务队列说起了，任务队列可以细分为 MacroTask Queue(宏任务队列) 和 MicroTask Queue(微任务队列) 两种</p><p>整个 script 代码放在了宏任务队列，setTimeout 也放在了宏任务队列，但 <code>promise.then</code> 放到了微任务队列</p><p>这两个队列的执行顺序如下：</p><ol><li>取宏任务队列里第一个 task，执行之</li><li>把微任务队列里<strong>所有</strong> task 执行完</li><li>再取宏任务队列里下一个 task 执行之，周而复始</li></ol><p>代码开始执行时，所有这些代码在宏任务队列中，取出来执行之。</p><p>后面遇到了setTimeout，又加入到macrotask queue中，</p><p>然后，遇到了 <code>promise.then</code>，<strong>放入到了另一个队列，微任务队列</strong>。</p><p>等整个 stack 执行完后，</p><p>下一步该取的是<strong>微任务队列</strong>中的任务了。</p><p>因此 <code>promise.then</code> 的回调比 setTimeout 先执行</p><h3 id="3、Generator-函数（生成器函数）"><a href="#3、Generator-函数（生成器函数）" class="headerlink" title="3、Generator 函数（生成器函数）"></a>3、Generator 函数（生成器函数）</h3><p>Generator 函数，也可以叫生成器函数，是 ES6 提供的一种异步编程解决方案，执行生成器函数会返回一个迭代器对象，所以我们先来看下什么是迭代器。</p><h4 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h4><p>迭代器并不是某一个语法或者对象，而是一个协议，只要遵循了这个协议，所实现的都是迭代器对象，下面我们来看一个简易的迭代器：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeIterator</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> nextIndex = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 返回迭代器对象</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// next() 方法返回的结果对象</span></span><br><span class="line">    next: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> nextIndex &lt; array.length ?</span><br><span class="line">        &#123;<span class="attr">value</span>: array[nextIndex++], <span class="attr">done</span>: <span class="literal">false</span>&#125; :</span><br><span class="line">        &#123;<span class="attr">value</span>: <span class="literal">undefined</span>, <span class="attr">done</span>: <span class="literal">true</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> it = makeIterator([<span class="string">'a'</span>, <span class="string">'b'</span>])</span><br><span class="line"></span><br><span class="line">it.next() <span class="comment">// &#123; value: "a", done: false &#125;</span></span><br><span class="line">it.next() <span class="comment">// &#123; value: "b", done: false &#125;</span></span><br><span class="line">it.next() <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure><p>上面代码定义了一个<code>makeIterator</code>函数，它是一个迭代器生成函数，作用就是返回一个迭代器对象。对数组<code>[&#39;a&#39;, &#39;b&#39;]</code>执行这个函数，就会返回该数组的迭代器对象<code>it</code></p><p>迭代器对象的<code>next</code>方法，用来移动指针。开始时，指针指向数组的开始位置。然后，每次调用<code>next</code>方法，指针就会指向数组的下一个成员。第一次调用，指向<code>a</code>；第二次调用，指向<code>b</code></p><p><code>next</code>方法返回一个对象，表示当前数据成员的信息。这个对象具有<code>value</code>和<code>done</code>两个属性，<code>value</code>属性返回当前位置的成员，<code>done</code>属性是一个布尔值，表示遍历是否结束</p><h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>借助于迭代器的这个特征，我们现在可以理解一下生成器，字面意思呢，就是生成一个东西，那生成器函数就是一个返回迭代器的函数</p><p>生成器函数从语法上来看，只是<code>function</code>关键字与函数名之间比普通函数多了一个星号，同时每一次迭代，都会通过 <code>yield</code>关键字来实现</p><p>我们把上面代码改写一下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">makeIterator</span>(<span class="params">array</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.length; i++) &#123;</span><br><span class="line">        <span class="keyword">yield</span> array[i]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> it = makeIterator([<span class="string">'a'</span>, <span class="string">'b'</span>])</span><br><span class="line"></span><br><span class="line">it.next() <span class="comment">// &#123; value: "a", done: false &#125;</span></span><br><span class="line">it.next() <span class="comment">// &#123; value: "b", done: false &#125;</span></span><br><span class="line">it.next() <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure><p>打印的值和上面代码是一模一样的，所以生成器的出现实际上是为了简化掉我们上面那一坨代码，简化创建迭代器的过程</p><p>咱们再来看个简单的栗子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">helloWorldGenerator</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'hello'</span></span><br><span class="line">  <span class="keyword">yield</span> <span class="string">'world'</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">'ending'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hw = helloWorldGenerator()</span><br></pre></td></tr></table></figure><p>上面代码定义了一个生成器函数<code>helloWorldGenerator</code>，它内部有两个<code>yield</code>表达式（<code>hello</code>和<code>world</code>），即该函数有三个状态：hello，world 和 return 语句（结束执行）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'hello', done: false &#125;</span></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'world', done: false &#125;</span></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: 'ending', done: true &#125;</span></span><br><span class="line">hw.next()</span><br><span class="line"><span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure></p><p>下一步，我们必须调用遍历器对象的<code>next</code>方法，使得指针移向下一个状态。也就是说，每次调用<code>next</code>方法，内部指针就从函数头部或上一次停下来的地方开始执行，直到遇到下一个<code>yield</code>表达式（或<code>return</code>语句）为止。我们可以理解为，生成器函数是分段执行的，<code>yield</code>表达式是暂停执行的标记，而<code>next</code>方法可以恢复执行</p><h4 id="co-模块"><a href="#co-模块" class="headerlink" title="co 模块"></a>co 模块</h4><p><a href="https://github.com/tj/co" target="_blank" rel="noopener">co 模块</a>是著名程序员 TJ Holowaychuk 于 2013 年 6 月发布的一个小工具，用于生成器函数的自动执行</p><p>下面是一个生成器函数，用于依次读取两个文件，这里的 <code>yield</code> 关键字后面跟的是一个 Promise：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> readFile = <span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    fs.readFile(fileName, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) reject(error)</span><br><span class="line">      resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/fstab'</span>)</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/shells'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString())</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>co 模块可以让你不用编写 Generator 函数的执行器。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>)</span><br><span class="line">co(gen)</span><br></pre></td></tr></table></figure><p>上面代码中，Generator 函数只要传入<code>co</code>函数，就会自动执行。</p><p><code>co</code>函数返回一个<code>Promise</code>对象，因此可以用<code>then</code>方法添加回调函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">co(gen).then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Generator 函数执行完成'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>上面代码中，等到 Generator 函数执行结束，就会输出一行提示</p><p>为什么 co 可以自动执行 Generator 函数？简单的说就是将异步操作包装成 Promise 对象，用<code>then</code>方法交回执行权，具体细节大家可以去看 co 库的源码</p><h3 id="4、Async-await"><a href="#4、Async-await" class="headerlink" title="4、Async/await"></a>4、Async/await</h3><p>ES2017 标准引入了 async 函数，使得异步操作变得更加方便</p><p><code>async/await</code>调用方式跟使用<code>co</code>库后的<code>Generator</code>函数看起来很相似，自带执行器，并且语义更清楚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">var</span> co = <span class="built_in">require</span>(<span class="string">'co'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> readFile = <span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    fs.readFile(fileName, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) reject(error)</span><br><span class="line">      resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/fstab'</span>)</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">yield</span> readFile(<span class="string">'/etc/shells'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString())</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">co(gen)</span><br></pre></td></tr></table></figure><p>写成 async 函数，就是下面这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> readFile = <span class="function"><span class="keyword">function</span> (<span class="params">fileName</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    fs.readFile(fileName, <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (error) reject(error)</span><br><span class="line">      resolve(data)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> asyncReadFile = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> f1 = <span class="keyword">await</span> readFile(<span class="string">'/etc/fstab'</span>)</span><br><span class="line">  <span class="keyword">var</span> f2 = <span class="keyword">await</span> readFile(<span class="string">'/etc/shells'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(f1.toString())</span><br><span class="line">  <span class="built_in">console</span>.log(f2.toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asyncReadFile()</span><br></pre></td></tr></table></figure><p>一比较就会发现，async 函数就是将 Generator 函数的星号（*）替换成 async，将 yield 替换成 await，仅此而已</p><p>所以说，生成器函数和 co 库都只是 async/await 标准化落地之前的过度方案，现在我们只要掌握 Promise 和 async/await 即可</p><h2 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h2><p>然后最后总结一下，今天我们探讨了 js 异步的实现已经 js 异步流程的演进路线，js 异步的实现，相信大家现在都能理解了，而 js 异步流程，从 promise 到 async 函数，无论如何，promise都是基石，是必须要掌握的，而生成器函数和 co 只是为了引出 async/await 的过度方案，所以大家只要掌握 promise 和 最终方案 async/await 即可</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;一、Javascript-异步的由来&quot;&gt;&lt;a href=&quot;#一、Javascript-异步的由来&quot; class=&quot;headerlink&quot; title=&quot;一、Javascript 异步的由来&quot;&gt;&lt;/a&gt;一、Javascript 异步的由来&lt;/h2&gt;&lt;h3 id=&quot;J
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>ECMAScript 6</title>
    <link href="https://gyunzhi.github.io/2018/08/27/ECMAScript%206/"/>
    <id>https://gyunzhi.github.io/2018/08/27/ECMAScript 6/</id>
    <published>2018-08-26T23:16:56.000Z</published>
    <updated>2019-05-06T09:26:27.117Z</updated>
    
    <content type="html"><![CDATA[<p>ECMAScript 6.0（以下简称 ES6）是 JavaScript 语言的下一代标准，已经在 2015 年 6 月正式发布了。阮一峰老师的<a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener">ECMAScript 6 入门</a>中详细介绍了ES6中最新的语法和修改。本篇博客作为学习记录，整理了一下ES6中常用的一些知识和特性。</p><h3 id="let、const命令与块级作用域"><a href="#let、const命令与块级作用域" class="headerlink" title="let、const命令与块级作用域"></a>let、const命令与块级作用域</h3><h4 id="let命令"><a href="#let命令" class="headerlink" title="let命令"></a><strong>let命令</strong></h4><h5 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">a <span class="comment">// ReferenceError: a is not defined.</span></span><br><span class="line">b <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><p>上面代码在代码块之中，分别用<code>let</code>和<code>var</code>声明了两个变量。然后在代码块之外调用这两个变量，结果<code>let</code>声明的变量报错，<code>var</code>声明的变量返回了正确的值。这表明，<code>let</code>声明的变量只在它所在的代码块有效。</p><h5 id="不存在变量提升"><a href="#不存在变量提升" class="headerlink" title="不存在变量提升"></a>不存在变量提升</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var 的情况</span></span><br><span class="line"><span class="built_in">console</span>.log(foo); <span class="comment">// 输出undefined</span></span><br><span class="line"><span class="keyword">var</span> foo = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let 的情况</span></span><br><span class="line"><span class="built_in">console</span>.log(bar); <span class="comment">// 报错ReferenceError</span></span><br><span class="line"><span class="keyword">let</span> bar = <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>上面代码中，变量<code>foo</code>用<code>var</code>命令声明，会发生<strong><em>变量提升</em></strong>，即脚本开始运行时，变量<code>foo</code>已经存在了，但是没有值，所以会输出<code>undefined</code>。变量<code>bar</code>用<code>let</code>命令声明，不会发生变量提升。这表示在声明它之前，变量<code>bar</code>是不存在的，这时如果用到它，就会抛出一个错误。 </p><h5 id="暂时性死区"><a href="#暂时性死区" class="headerlink" title="暂时性死区"></a>暂时性死区</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// TDZ开始</span></span><br><span class="line">  tmp = <span class="string">'abc'</span>; <span class="comment">// ReferenceError</span></span><br><span class="line">  <span class="built_in">console</span>.log(tmp); <span class="comment">// ReferenceError</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> tmp; <span class="comment">// TDZ结束</span></span><br><span class="line">  <span class="built_in">console</span>.log(tmp); <span class="comment">// undefined</span></span><br><span class="line"></span><br><span class="line">  tmp = <span class="number">123</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(tmp); <span class="comment">// 123</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在代码块内，使用<code>let</code>命令声明变量之前，该变量都是不可用的。这在语法上，称为“暂时性死区”（temporal dead zone，简称 TDZ）。 上面代码中，在<code>let</code>命令声明变量<code>tmp</code>之前，都属于变量<code>tmp</code>的“死区”。 </p><p>“暂时性死区”也意味着<code>typeof</code>不再是一个百分之百安全的操作。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> x; <span class="comment">// ReferenceError</span></span><br><span class="line"><span class="keyword">let</span> x;</span><br></pre></td></tr></table></figure><p>上面代码中，变量<code>x</code>使用<code>let</code>命令声明，所以在声明之前，都属于<code>x</code>的“死区”，只要用到该变量就会报错。因此，<code>typeof</code>运行时就会抛出一个<code>ReferenceError</code>。</p><p>作为比较，如果一个变量根本没有被声明，使用<code>typeof</code>反而不会报错。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> undeclared_variable <span class="comment">// "undefined"</span></span><br></pre></td></tr></table></figure><p>上面代码中，<code>undeclared_variable</code>是一个不存在的变量名，结果返回“undefined”。所以，在没有<code>let</code>之前，<code>typeof</code>运算符是百分之百安全的，永远不会报错。现在这一点不成立了。这样的设计是为了让大家养成良好的编程习惯，变量一定要在声明之后使用，否则就报错。</p><h5 id="不允许重复声明"><a href="#不允许重复声明" class="headerlink" title="不允许重复声明"></a>不允许重复声明</h5><p><code>let</code>不允许在相同作用域内，重复声明同一个变量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此，不能在函数内部重新声明参数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> arg; <span class="comment">// 报错</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">arg</span>) </span>&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> arg; <span class="comment">// 不报错</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="const命令"><a href="#const命令" class="headerlink" title="const命令"></a>const命令</h4><h5 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h5><p><code>const</code>声明一个只读的常量。一旦声明，常量的值就不能改变。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PI = <span class="number">3.1415</span>;</span><br><span class="line">PI <span class="comment">// 3.1415</span></span><br><span class="line"></span><br><span class="line">PI = <span class="number">3</span>;</span><br><span class="line"><span class="comment">// TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure><p>上面代码表明改变常量的值会报错。</p><p><code>const</code>声明的变量不得改变值，这意味着，<code>const</code>一旦声明变量，就必须立即初始化，不能留到以后赋值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo;</span><br><span class="line"><span class="comment">// SyntaxError: Missing initializer in const declaration</span></span><br></pre></td></tr></table></figure><p>上面代码表示，对于<code>const</code>来说，只声明不赋值，就会报错。</p><p><code>const</code>的作用域与<code>let</code>命令相同：只在声明所在的块级作用域内有效。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> MAX = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MAX <span class="comment">// Uncaught ReferenceError: MAX is not defined</span></span><br></pre></td></tr></table></figure><p><code>const</code>命令声明的常量也是不提升，同样存在暂时性死区，只能在声明的位置后面使用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(MAX); <span class="comment">// ReferenceError</span></span><br><span class="line">  <span class="keyword">const</span> MAX = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码在常量<code>MAX</code>声明之前就调用，结果报错。</p><p><code>const</code>声明的常量，也与<code>let</code>一样不可重复声明。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> message = <span class="string">"Hello!"</span>;</span><br><span class="line"><span class="keyword">let</span> age = <span class="number">25</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下两行都会报错</span></span><br><span class="line"><span class="keyword">const</span> message = <span class="string">"Goodbye!"</span>;</span><br><span class="line"><span class="keyword">const</span> age = <span class="number">30</span>;</span><br></pre></td></tr></table></figure><h4 id="块级作用域"><a href="#块级作用域" class="headerlink" title="块级作用域"></a>块级作用域</h4><p><code>let</code>实际上为 JavaScript 新增了块级作用域。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> n = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> n = <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(n); <span class="comment">// 5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的函数有两个代码块，都声明了变量<code>n</code>，运行后输出 5。这表示外层代码块不受内层代码块的影响。如果两次都使用<code>var</code>定义变量<code>n</code>，最后输出的值才是 10。</p><p>ES6 允许块级作用域的任意嵌套。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#123;&#123;&#123;<span class="keyword">let</span> insane = <span class="string">'Hello World'</span>&#125;&#125;&#125;&#125;&#125;;</span><br></pre></td></tr></table></figure><p>上面代码使用了一个五层的块级作用域。外层作用域无法读取内层作用域的变量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#123;&#123;</span><br><span class="line">  &#123;<span class="keyword">let</span> insane = <span class="string">'Hello World'</span>&#125;</span><br><span class="line">  <span class="built_in">console</span>.log(insane); <span class="comment">// 报错</span></span><br><span class="line">&#125;&#125;&#125;&#125;;</span><br></pre></td></tr></table></figure><p>内层作用域可以定义外层作用域的同名变量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#123;&#123;</span><br><span class="line">  <span class="keyword">let</span> insane = <span class="string">'Hello World'</span>;</span><br><span class="line">  &#123;<span class="keyword">let</span> insane = <span class="string">'Hello World'</span>&#125;</span><br><span class="line">&#125;&#125;&#125;&#125;;</span><br></pre></td></tr></table></figure><p>块级作用域的出现，实际上使得获得广泛应用的立即执行函数表达式（IIFE）不再必要了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IIFE 写法</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> tmp = ...;</span><br><span class="line">  ...</span><br><span class="line">&#125;());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 块级作用域写法</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> tmp = ...;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对象新特性"><a href="#对象新特性" class="headerlink" title="对象新特性"></a>对象新特性</h3><h4 id="属性的简洁表示法"><a href="#属性的简洁表示法" class="headerlink" title="属性的简洁表示法"></a>属性的简洁表示法</h4><p>ES6 允许直接写入变量和函数，作为对象的属性和方法。这样的书写更加简洁。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> foo = <span class="string">'bar'</span>;</span><br><span class="line"><span class="keyword">const</span> baz = &#123;foo&#125;;</span><br><span class="line">baz <span class="comment">// &#123;foo: "bar"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">const</span> baz = &#123;<span class="attr">foo</span>: foo&#125;;</span><br></pre></td></tr></table></figure><p>上面代码表明，ES6 允许在对象之中，直接写变量。这时，属性名为变量名, 属性值为变量的值。下面是另一个例子。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;x, y&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;<span class="attr">x</span>: x, <span class="attr">y</span>: y&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="number">1</span>, <span class="number">2</span>) <span class="comment">// Object &#123;x: 1, y: 2&#125;</span></span><br></pre></td></tr></table></figure><p>除了属性简写，方法也可以简写。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  method() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> o = &#123;</span><br><span class="line">  method: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello!"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="属性名表达式"><a href="#属性名表达式" class="headerlink" title="属性名表达式"></a>属性名表达式</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> propKey = <span class="string">'foo'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  [propKey]: <span class="literal">true</span>,</span><br><span class="line">  [<span class="string">'a'</span> + <span class="string">'bc'</span>]: <span class="number">123</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ES6 允许字面量定义对象时，用方法二（表达式）作为对象的属性名，即把表达式放在方括号内。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> propKey = <span class="string">'foo'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  [propKey]: <span class="literal">true</span>,</span><br><span class="line">  [<span class="string">'a'</span> + <span class="string">'bc'</span>]: <span class="number">123</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="函数的新特性"><a href="#函数的新特性" class="headerlink" title="函数的新特性"></a>函数的新特性</h3><h4 id="参数的默认值"><a href="#参数的默认值" class="headerlink" title="参数的默认值"></a>参数的默认值</h4><p>ES6 之前，不能直接为函数的参数指定默认值，只能采用变通的方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  y = y || <span class="string">'World'</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log(<span class="string">'Hello'</span>) <span class="comment">// Hello World</span></span><br><span class="line">log(<span class="string">'Hello'</span>, <span class="string">'China'</span>) <span class="comment">// Hello China</span></span><br><span class="line">log(<span class="string">'Hello'</span>, <span class="string">''</span>) <span class="comment">// Hello World</span></span><br></pre></td></tr></table></figure><p>上面代码检查函数<code>log</code>的参数<code>y</code>有没有赋值，如果没有，则指定默认值为<code>World</code>。这种写法的缺点在于，如果参数<code>y</code>赋值了，但是对应的布尔值为<code>false</code>，则该赋值不起作用。就像上面代码的最后一行，参数<code>y</code>等于空字符，结果被改为默认值。</p><p>为了避免这个问题，通常需要先判断一下参数<code>y</code>是否被赋值，如果没有，再等于默认值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> y === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  y = <span class="string">'World'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ES6 允许为函数的参数设置默认值，即直接写在参数定义的后面。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">x, y = <span class="string">'World'</span></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x, y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log(<span class="string">'Hello'</span>) <span class="comment">// Hello World</span></span><br><span class="line">log(<span class="string">'Hello'</span>, <span class="string">'China'</span>) <span class="comment">// Hello China</span></span><br><span class="line">log(<span class="string">'Hello'</span>, <span class="string">''</span>) <span class="comment">// Hello</span></span><br></pre></td></tr></table></figure><h4 id="rest参数"><a href="#rest参数" class="headerlink" title="rest参数"></a>rest参数</h4><p>ES6 引入 rest 参数（形式为<code>...变量名</code>），用于获取函数的多余参数，这样就不需要使用<code>arguments</code>对象了。rest 参数搭配的变量是一个数组，该变量将多余的参数放入数组中。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">...values</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> val <span class="keyword">of</span> values) &#123;</span><br><span class="line">    sum += val;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, <span class="number">5</span>, <span class="number">3</span>) <span class="comment">// 10</span></span><br></pre></td></tr></table></figure><p>上面代码的<code>add</code>函数是一个求和函数，利用 rest 参数，可以向该函数传入任意数目的参数。</p><h4 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h4><p>ES6 允许使用“箭头”（<code>=&gt;</code>）定义函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="function"><span class="params">n</span> =&gt;</span> n;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> f = <span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如果箭头函数不需要参数或需要多个参数，就使用一个圆括号代表参数部分。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> f = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">5</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sum = <span class="function">(<span class="params">num1, num2</span>) =&gt;</span> num1 + num2;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span>(<span class="params">num1, num2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> num1 + num2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>如果箭头函数的代码块部分多于一条语句，就要使用大括号将它们括起来，并且使用<code>return</code>语句返回。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="function">(<span class="params">num1, num2</span>) =&gt;</span> &#123; <span class="keyword">return</span> num1 + num2; &#125;</span><br></pre></td></tr></table></figure><p>由于大括号被解释为代码块，所以如果箭头函数直接返回一个对象，必须在对象外面加上括号，否则会报错。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="keyword">let</span> getTempItem = <span class="function"><span class="params">id</span> =&gt;</span> &#123; <span class="attr">id</span>: id, <span class="attr">name</span>: <span class="string">"Temp"</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不报错</span></span><br><span class="line"><span class="keyword">let</span> getTempItem = <span class="function"><span class="params">id</span> =&gt;</span> (&#123; <span class="attr">id</span>: id, <span class="attr">name</span>: <span class="string">"Temp"</span> &#125;);</span><br></pre></td></tr></table></figure><p>下面是一种特殊情况，虽然可以运行，但会得到错误的结果。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> foo = <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="attr">a</span>: <span class="number">1</span> &#125;;</span><br><span class="line">foo() <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure><p>上面代码中，原始意图是返回一个对象<code>{ a: 1 }</code>，但是由于引擎认为大括号是代码块，所以执行了一行语句<code>a: 1</code>。这时，<code>a</code>可以被解释为语句的标签，因此实际执行的语句是<code>1;</code>，然后函数就结束了，没有返回值。</p><p>箭头函数有几个使用注意点。</p><p>（1）函数体内的<code>this</code>对象，就是定义时所在的对象，而不是使用时所在的对象。</p><p>（2）不可以当作构造函数，也就是说，不可以使用<code>new</code>命令，否则会抛出一个错误。</p><p>（3）不可以使用<code>arguments</code>对象，该对象在函数体内不存在。如果要用，可以用 rest 参数代替。</p><h4 id="双冒号运算符"><a href="#双冒号运算符" class="headerlink" title="双冒号运算符"></a>双冒号运算符</h4><p>箭头函数可以绑定<code>this</code>对象，大大减少了显式绑定<code>this</code>对象的写法（<code>call</code>、<code>apply</code>、<code>bind</code>）。但是，箭头函数并不适用于所有场合，所以现在有一个<a href="https://github.com/zenparsing/es-function-bind" target="_blank" rel="noopener">提案</a>，提出了“函数绑定”（function bind）运算符，用来取代<code>call</code>、<code>apply</code>、<code>bind</code>调用。</p><p>函数绑定运算符是并排的两个冒号（<code>::</code>），双冒号左边是一个对象，右边是一个函数。该运算符会自动将左边的对象，作为上下文环境（即<code>this</code>对象），绑定到右边的函数上面。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">foo::bar;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">bar.bind(foo);</span><br><span class="line"></span><br><span class="line">foo::bar(...arguments);</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line">bar.apply(foo, <span class="built_in">arguments</span>);</span><br></pre></td></tr></table></figure><p>如果双冒号左边为空，右边是一个对象的方法，则等于将该方法绑定在该对象上面。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> method = obj::obj.foo;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> method = ::obj.foo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> log = ::<span class="built_in">console</span>.log;</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="keyword">var</span> log = <span class="built_in">console</span>.log.bind(<span class="built_in">console</span>);</span><br></pre></td></tr></table></figure><h3 id="变量的解构赋值"><a href="#变量的解构赋值" class="headerlink" title="变量的解构赋值"></a>变量的解构赋值</h3><p>ES6 允许按照一定模式，从数组和对象中提取值，对变量进行赋值，这被称为解构（Destructuring）。</p><p>以前，为变量赋值，只能直接指定值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">let</span> c = <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>ES6 允许写成下面这样。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [a, b, c] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br></pre></td></tr></table></figure><p>上面代码表示，可以从数组中提取值，按照对应位置，对变量赋值。本质上，这种写法属于“模式匹配”，只要等号两边的模式相同，左边的变量就会被赋予对应的值。</p><h4 id="数组的解构赋值"><a href="#数组的解构赋值" class="headerlink" title="数组的解构赋值"></a>数组的解构赋值</h4><h5 id="基本用法-2"><a href="#基本用法-2" class="headerlink" title="基本用法"></a>基本用法</h5><p>下面是一些使用嵌套数组进行解构的例子。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [foo, [[bar], baz]] = [<span class="number">1</span>, [[<span class="number">2</span>], <span class="number">3</span>]];</span><br><span class="line">foo <span class="comment">// 1</span></span><br><span class="line">bar <span class="comment">// 2</span></span><br><span class="line">baz <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [ , , third] = [<span class="string">"foo"</span>, <span class="string">"bar"</span>, <span class="string">"baz"</span>];</span><br><span class="line">third <span class="comment">// "baz"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x, , y] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line">y <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [head, ...tail] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">head <span class="comment">// 1</span></span><br><span class="line">tail <span class="comment">// [2, 3, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x, y, ...z] = [<span class="string">'a'</span>];</span><br><span class="line">x <span class="comment">// "a"</span></span><br><span class="line">y <span class="comment">// undefined</span></span><br><span class="line">z <span class="comment">// []</span></span><br></pre></td></tr></table></figure><p>如果解构不成功，变量的值就等于<code>undefined</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [foo] = [];</span><br><span class="line"><span class="keyword">let</span> [bar, foo] = [<span class="number">1</span>];</span><br></pre></td></tr></table></figure><p>以上两种情况都属于解构不成功，<code>foo</code>的值都会等于<code>undefined</code>。</p><p>另一种情况是不完全解构，即等号左边的模式，只匹配一部分的等号右边的数组。这种情况下，解构依然可以成功。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [x, y] = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line">y <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [a, [b], d] = [<span class="number">1</span>, [<span class="number">2</span>, <span class="number">3</span>], <span class="number">4</span>];</span><br><span class="line">a <span class="comment">// 1</span></span><br><span class="line">b <span class="comment">// 2</span></span><br><span class="line">d <span class="comment">// 4</span></span><br></pre></td></tr></table></figure><p>上面两个例子，都属于不完全解构，但是可以成功。</p><p>如果等号的右边不是数组（或者严格地说，不是可遍历的结构，参见《Iterator》一章），那么将会报错。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="keyword">let</span> [foo] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> [foo] = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> [foo] = <span class="literal">NaN</span>;</span><br><span class="line"><span class="keyword">let</span> [foo] = <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">let</span> [foo] = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> [foo] = &#123;&#125;;</span><br></pre></td></tr></table></figure><p>上面的语句都会报错，因为等号右边的值，要么转为对象以后不具备 Iterator 接口（前五个表达式），要么本身就不具备 Iterator 接口（最后一个表达式）。</p><h5 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h5><p>解构赋值允许指定默认值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [foo = <span class="literal">true</span>] = [];</span><br><span class="line">foo <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x, y = <span class="string">'b'</span>] = [<span class="string">'a'</span>]; <span class="comment">// x='a', y='b'</span></span><br><span class="line"><span class="keyword">let</span> [x, y = <span class="string">'b'</span>] = [<span class="string">'a'</span>, <span class="literal">undefined</span>]; <span class="comment">// x='a', y='b'</span></span><br></pre></td></tr></table></figure><p><strong>注意，ES6 内部使用严格相等运算符（<code>===</code>），判断一个位置是否有值。所以，只有当一个数组成员严格等于<code>undefined</code>，默认值才会生效。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [x = <span class="number">1</span>] = [<span class="literal">undefined</span>];</span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x = <span class="number">1</span>] = [<span class="literal">null</span>];</span><br><span class="line">x <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p>上面代码中，如果一个数组成员是<code>null</code>，默认值就不会生效，因为<code>null</code>不严格等于<code>undefined</code>。</p><p>如果默认值是一个表达式，那么这个表达式是惰性求值的，即只有在用到的时候，才会求值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'aaa'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> [x = f()] = [<span class="number">1</span>];</span><br></pre></td></tr></table></figure><p>上面代码中，因为<code>x</code>能取到值，所以函数<code>f</code>根本不会执行。上面的代码其实等价于下面的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x;</span><br><span class="line"><span class="keyword">if</span> ([<span class="number">1</span>][<span class="number">0</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">  x = f();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  x = [<span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认值可以引用解构赋值的其他变量，但该变量必须已经声明。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> [x = <span class="number">1</span>, y = x] = [];     <span class="comment">// x=1; y=1</span></span><br><span class="line"><span class="keyword">let</span> [x = <span class="number">1</span>, y = x] = [<span class="number">2</span>];    <span class="comment">// x=2; y=2</span></span><br><span class="line"><span class="keyword">let</span> [x = <span class="number">1</span>, y = x] = [<span class="number">1</span>, <span class="number">2</span>]; <span class="comment">// x=1; y=2</span></span><br><span class="line"><span class="keyword">let</span> [x = y, y = <span class="number">1</span>] = [];     <span class="comment">// ReferenceError: y is not defined</span></span><br></pre></td></tr></table></figure><p>上面最后一个表达式之所以会报错，是因为<code>x</code>用<code>y</code>做默认值时，<code>y</code>还没有声明。</p><h4 id="对象的解构赋值"><a href="#对象的解构赋值" class="headerlink" title="对象的解构赋值"></a>对象的解构赋值</h4><p>解构不仅可以用于数组，还可以用于对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; foo, bar &#125; = &#123; <span class="attr">foo</span>: <span class="string">"aaa"</span>, <span class="attr">bar</span>: <span class="string">"bbb"</span> &#125;;</span><br><span class="line">foo <span class="comment">// "aaa"</span></span><br><span class="line">bar <span class="comment">// "bbb"</span></span><br></pre></td></tr></table></figure><p>对象的解构与数组有一个重要的不同。<strong>数组的元素是按次序排列的，变量的取值由它的位置决定；而对象的属性没有次序，变量必须与属性同名，才能取到正确的值。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; bar, foo &#125; = &#123; <span class="attr">foo</span>: <span class="string">"aaa"</span>, <span class="attr">bar</span>: <span class="string">"bbb"</span> &#125;;</span><br><span class="line">foo <span class="comment">// "aaa"</span></span><br><span class="line">bar <span class="comment">// "bbb"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123; baz &#125; = &#123; <span class="attr">foo</span>: <span class="string">"aaa"</span>, <span class="attr">bar</span>: <span class="string">"bbb"</span> &#125;;</span><br><span class="line">baz <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure><p>上面代码的第一个例子，等号左边的两个变量的次序，与等号右边两个同名属性的次序不一致，但是对取值完全没有影响。第二个例子的变量没有对应的同名属性，导致取不到值，最后等于<code>undefined</code>。</p><p>如果变量名与属性名不一致，必须写成下面这样。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="attr">foo</span>: baz &#125; = &#123; <span class="attr">foo</span>: <span class="string">'aaa'</span>, <span class="attr">bar</span>: <span class="string">'bbb'</span> &#125;;</span><br><span class="line">baz <span class="comment">// "aaa"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123; <span class="attr">first</span>: <span class="string">'hello'</span>, <span class="attr">last</span>: <span class="string">'world'</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> &#123; <span class="attr">first</span>: f, <span class="attr">last</span>: l &#125; = obj;</span><br><span class="line">f <span class="comment">// 'hello'</span></span><br><span class="line">l <span class="comment">// 'world'</span></span><br></pre></td></tr></table></figure><p>这实际上说明，对象的解构赋值是下面形式的简写（参见《对象的扩展》一章）。对象中属性名和属性值相同时，可以</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="attr">foo</span>: foo, <span class="attr">bar</span>: bar &#125; = &#123; <span class="attr">foo</span>: <span class="string">"aaa"</span>, <span class="attr">bar</span>: <span class="string">"bbb"</span> &#125;;</span><br></pre></td></tr></table></figure><p>也就是说，对象的解构赋值的内部机制，是先找到同名属性，然后再赋给对应的变量。真正被赋值的是后者，而不是前者。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; <span class="attr">foo</span>: baz &#125; = &#123; <span class="attr">foo</span>: <span class="string">"aaa"</span>, <span class="attr">bar</span>: <span class="string">"bbb"</span> &#125;;</span><br><span class="line">baz <span class="comment">// "aaa"</span></span><br><span class="line">foo <span class="comment">// error: foo is not defined</span></span><br></pre></td></tr></table></figure><p>上面代码中，<code>foo</code>是匹配的模式，<code>baz</code>才是变量。真正被赋值的是变量<code>baz</code>，而不是模式<code>foo</code>。</p><p>对象的解构也可以指定默认值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;x = <span class="number">3</span>&#125; = &#123;&#125;;</span><br><span class="line">x <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123;x, y = <span class="number">5</span>&#125; = &#123;<span class="attr">x</span>: <span class="number">1</span>&#125;;</span><br><span class="line">x <span class="comment">// 1</span></span><br><span class="line">y <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123;<span class="attr">x</span>: y = <span class="number">3</span>&#125; = &#123;&#125;;</span><br><span class="line">y <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123;<span class="attr">x</span>: y = <span class="number">3</span>&#125; = &#123;<span class="attr">x</span>: <span class="number">5</span>&#125;;</span><br><span class="line">y <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123; <span class="attr">message</span>: msg = <span class="string">'Something went wrong'</span> &#125; = &#123;&#125;;</span><br><span class="line">msg <span class="comment">// "Something went wrong"</span></span><br></pre></td></tr></table></figure><p><strong>默认值生效的条件是，对象的属性值严格等于<code>undefined</code>。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;x = <span class="number">3</span>&#125; = &#123;<span class="attr">x</span>: <span class="literal">undefined</span>&#125;;</span><br><span class="line">x <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> &#123;x = <span class="number">3</span>&#125; = &#123;<span class="attr">x</span>: <span class="literal">null</span>&#125;;</span><br><span class="line">x <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p>上面代码中，属性<code>x</code>等于<code>null</code>，因为<code>null</code>与<code>undefined</code>不严格相等，所以是个有效的赋值，导致默认值<code>3</code>不会生效。</p><p>如果解构失败，变量的值等于<code>undefined</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;foo&#125; = &#123;<span class="attr">bar</span>: <span class="string">'baz'</span>&#125;;</span><br><span class="line">foo <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure><p>如果解构模式是嵌套的对象，而且子对象所在的父属性不存在，那么将会报错。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 报错</span></span><br><span class="line"><span class="keyword">let</span> &#123;<span class="attr">foo</span>: &#123;bar&#125;&#125; = &#123;<span class="attr">baz</span>: <span class="string">'baz'</span>&#125;;</span><br></pre></td></tr></table></figure><p>上面代码中，等号左边对象的<code>foo</code>属性，对应一个子对象。该子对象的<code>bar</code>属性，解构时会报错。原因很简单，因为<code>foo</code>这时等于<code>undefined</code>，再取子属性就会报错，请看下面的代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _tmp = &#123;<span class="attr">baz</span>: <span class="string">'baz'</span>&#125;;</span><br><span class="line">_tmp.foo.bar <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure><p>如果要将一个已经声明的变量用于解构赋值，必须非常小心。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误的写法</span></span><br><span class="line"><span class="keyword">let</span> x;</span><br><span class="line">&#123;x&#125; = &#123;<span class="attr">x</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="comment">// SyntaxError: syntax error</span></span><br></pre></td></tr></table></figure><p>上面代码的写法会报错，因为 JavaScript 引擎会将<code>{x}</code>理解成一个代码块，从而发生语法错误。只有不将大括号写在行首，避免 JavaScript 将其解释为代码块，才能解决这个问题。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正确的写法</span></span><br><span class="line"><span class="keyword">let</span> x;</span><br><span class="line">(&#123;x&#125; = &#123;<span class="attr">x</span>: <span class="number">1</span>&#125;);</span><br></pre></td></tr></table></figure><p>上面代码将整个解构赋值语句，放在一个圆括号里面，就可以正确执行。关于圆括号与解构赋值的关系，参见下文。</p><p>解构赋值允许等号左边的模式之中，不放置任何变量名。因此，可以写出非常古怪的赋值表达式。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(&#123;&#125; = [<span class="literal">true</span>, <span class="literal">false</span>]);</span><br><span class="line">(&#123;&#125; = <span class="string">'abc'</span>);</span><br><span class="line">(&#123;&#125; = []);</span><br></pre></td></tr></table></figure><p>上面的表达式虽然毫无意义，但是语法是合法的，可以执行。</p><p><strong>对象的解构赋值，可以很方便地将现有对象的方法，赋值到某个变量。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123; log, sin, cos &#125; = <span class="built_in">Math</span>;</span><br></pre></td></tr></table></figure><p>上面代码将<code>Math</code>对象的对数、正弦、余弦三个方法，赋值到对应的变量上，使用起来就会方便很多。</p><p>由于数组本质是特殊的对象，因此可以对数组进行对象属性的解构。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="keyword">let</span> &#123;<span class="number">0</span> : first, [arr.length - <span class="number">1</span>] : last&#125; = arr;</span><br><span class="line">first <span class="comment">// 1</span></span><br><span class="line">last <span class="comment">// 3</span></span><br></pre></td></tr></table></figure><p>上面代码对数组进行对象解构。数组<code>arr</code>的<code>0</code>键对应的值是<code>1</code>，<code>[arr.length - 1]</code>就是<code>2</code>键，对应的值是<code>3</code>。方括号这种写法，属于“属性名表达式”（参见《对象的扩展》一章）。</p><h4 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h4><p>变量的解构赋值用途很多。</p><p><strong>（1）交换变量的值</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> y = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">[x, y] = [y, x];</span><br></pre></td></tr></table></figure><p>上面代码交换变量<code>x</code>和<code>y</code>的值，这样的写法不仅简洁，而且易读，语义非常清晰。</p><p><strong>（2）从函数返回多个值</strong></p><p>函数只能返回一个值，如果要返回多个值，只能将它们放在数组或对象里返回。有了解构赋值，取出这些值就非常方便。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个数组</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> [a, b, c] = example();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回一个对象</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">example</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    foo: <span class="number">1</span>,</span><br><span class="line">    bar: <span class="number">2</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> &#123; foo, bar &#125; = example();</span><br></pre></td></tr></table></figure><p><strong>（3）函数参数的定义</strong></p><p>解构赋值可以方便地将一组参数与变量名对应起来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数是一组有次序的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">[x, y, z]</span>) </span>&#123; ... &#125;</span><br><span class="line">f([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数是一组无次序的值</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">&#123;x, y, z&#125;</span>) </span>&#123; ... &#125;</span><br><span class="line">f(&#123;<span class="attr">z</span>: <span class="number">3</span>, <span class="attr">y</span>: <span class="number">2</span>, <span class="attr">x</span>: <span class="number">1</span>&#125;);</span><br></pre></td></tr></table></figure><p><strong>（4）提取 JSON 数据</strong></p><p>解构赋值对提取 JSON 对象中的数据，尤其有用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsonData = &#123;</span><br><span class="line">  id: <span class="number">42</span>,</span><br><span class="line">  status: <span class="string">"OK"</span>,</span><br><span class="line">  data: [<span class="number">867</span>, <span class="number">5309</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123; id, status, <span class="attr">data</span>: number &#125; = jsonData;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(id, status, number);</span><br><span class="line"><span class="comment">// 42, "OK", [867, 5309]</span></span><br></pre></td></tr></table></figure><p>上面代码可以快速提取 JSON 数据的值。</p><p><strong>（5）函数参数的默认值</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jQuery.ajax = <span class="function"><span class="keyword">function</span> (<span class="params">url, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  async = true,</span></span></span><br><span class="line"><span class="function"><span class="params">  beforeSend = function (</span>) </span>&#123;&#125;,</span><br><span class="line">  cache = <span class="literal">true</span>,</span><br><span class="line">  complete = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">  crossDomain = <span class="literal">false</span>,</span><br><span class="line">  global = <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// ... more config</span></span><br><span class="line">&#125; = &#123;&#125;) &#123;</span><br><span class="line">  <span class="comment">// ... do stuff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>指定参数的默认值，就避免了在函数体内部再写<code>var foo = config.foo || &#39;default foo&#39;;</code>这样的语句。</p><p><strong>（6）遍历 Map 结构</strong></p><p>任何部署了 Iterator 接口的对象，都可以用<code>for...of</code>循环遍历。Map 结构原生支持 Iterator 接口，配合变量的解构赋值，获取键名和键值就非常方便。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">map.set(<span class="string">'first'</span>, <span class="string">'hello'</span>);</span><br><span class="line">map.set(<span class="string">'second'</span>, <span class="string">'world'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [key, value] <span class="keyword">of</span> map) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key + <span class="string">" is "</span> + value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// first is hello</span></span><br><span class="line"><span class="comment">// second is world</span></span><br></pre></td></tr></table></figure><p>如果只想获取键名，或者只想获取键值，可以写成下面这样。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取键名</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [key] <span class="keyword">of</span> map) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取键值</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [,value] <span class="keyword">of</span> map) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>（7）输入模块的指定方法</strong></p><p>加载模块时，往往需要指定输入哪些方法。解构赋值使得输入语句非常清晰。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; SourceMapConsumer, SourceNode &#125; = <span class="built_in">require</span>(<span class="string">"source-map"</span>)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ECMAScript 6.0（以下简称 ES6）是 JavaScript 语言的下一代标准，已经在 2015 年 6 月正式发布了。阮一峰老师的&lt;a href=&quot;http://es6.ruanyifeng.com/&quot; target=&quot;_blank&quot; rel=&quot;noopene
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Redux入门指南</title>
    <link href="https://gyunzhi.github.io/2018/08/12/Redux%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/"/>
    <id>https://gyunzhi.github.io/2018/08/12/Redux入门指南/</id>
    <published>2018-08-12T10:28:56.000Z</published>
    <updated>2019-05-06T09:26:27.135Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">为了方便讲解，我写了一个Demo，请先安装一下</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/GYunZhi/cnode.git</span><br><span class="line">$ <span class="built_in">cd</span> cnode &amp;&amp; yarn</span><br><span class="line">$ yarn start</span><br></pre></td></tr></table></figure><h2 id="一、三大原则"><a href="#一、三大原则" class="headerlink" title="一、三大原则"></a>一、三大原则</h2><p><strong>Redux 可以用这三个基本原则来描述：</strong></p><h4 id="单一数据源"><a href="#单一数据源" class="headerlink" title="单一数据源"></a>单一数据源</h4><p><strong>整个应用的 state 被储存在一棵 object tree 中，并且这个 object tree 只存在于唯一一个 store 中。</strong></p><p>这让同构应用开发变得非常容易。来自服务端的  state 可以在无需编写更多代码的情况下被序列化并注入到客户端中。由于是单一的 state tree  ，调试也变得非常容易。在开发中，你可以把应用的 state 保存在本地，从而加快开发速度。此外，受益于单一的 state tree  ，以前难以实现的如“撤销/重做”这类功能也变得轻而易举。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(store.getState())</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 输出</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  visibilityFilter: 'SHOW_ALL',</span></span><br><span class="line"><span class="comment">  todos: [</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      text: 'Consider using Redux',</span></span><br><span class="line"><span class="comment">      completed: true,</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      text: 'Keep all state in a single tree',</span></span><br><span class="line"><span class="comment">      completed: false</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  ]</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*／</span></span><br></pre></td></tr></table></figure><h4 id="State-是只读的"><a href="#State-是只读的" class="headerlink" title="State 是只读的"></a>State 是只读的</h4><p><strong>唯一改变 state 的方法就是触发 action，action 是一个用于描述已发生事件的普通对象。</strong></p><p>这样确保了视图和网络请求都不能直接修改  state，相反它们只能表达想要修改的意图。因为所有的修改都被集中化处理，且严格按照一个接一个的顺序执行，因此不用担心 race  condition 的出现。 Action 就是普通对象而已，因此它们可以被日志打印、序列化、储存、后期调试或测试时回放出来。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">'COMPLETE_TODO'</span>,</span><br><span class="line">  index: <span class="number">1</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">store.dispatch(&#123;</span><br><span class="line">  type: <span class="string">'SET_VISIBILITY_FILTER'</span>,</span><br><span class="line">  filter: <span class="string">'SHOW_COMPLETED'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="使用纯函数来执行修改"><a href="#使用纯函数来执行修改" class="headerlink" title="使用纯函数来执行修改"></a>使用纯函数来执行修改</h4><p><strong>为了描述 action 如何改变 state tree ，你需要编写 reducers。</strong></p><p>Reducer  只是一些纯函数，它接收先前的 state 和 action，并返回新的 state。刚开始你可以只有一个  reducer，随着应用变大，你可以把它拆成多个小的 reducers，分别独立地操作 state tree 的不同部分，因为 reducer  只是函数，你可以控制它们被调用的顺序，传入附加数据，甚至编写可复用的 reducer 来处理一些通用任务，如分页器。<code></code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">visibilityFilter</span>(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'SET_VISIBILITY_FILTER'</span>:</span><br><span class="line">      <span class="keyword">return</span> action.filter</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todos</span>(<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        ...state,</span><br><span class="line">        &#123;</span><br><span class="line">          text: action.text,</span><br><span class="line">          completed: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'COMPLETE_TODO'</span>:</span><br><span class="line">      <span class="keyword">return</span> state.map(<span class="function">(<span class="params">todo, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index === action.index) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Object</span>.assign(&#123;&#125;, todo, &#123;</span><br><span class="line">            completed: <span class="literal">true</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> todo</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers, createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">let</span> reducer = combineReducers(&#123; visibilityFilter, todos &#125;)</span><br><span class="line"><span class="keyword">let</span> store = createStore(reducer)</span><br></pre></td></tr></table></figure><p>就是这样，现在你应该明白 Redux 是怎么回事了。</p><h2 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h2><p>redux中有三个基本概念，Action，Reducer，Store。</p><h4 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h4><p><strong>官方的介绍：</strong></p><p>Actions  are payloads of information that send data from your application to  your store. They are the only source of information for the store. You  send them to the store using store.dispatch().</p><p><strong>中文：</strong></p><p>Actions 是把数据从应用传到 store 的有效载荷。它是 store 数据的唯一来源。用法是通过 store.dispatch() 把 action 传到 store。</p><p><strong>总结：</strong></p><p>Action 有两个作用。</p><ol><li>用Action来分辨具体的执行动作。比如是create ?还是delete？或者是update？</li><li>操作数据首先得有数据。比如添加数据得有数据，删除数据得有ID,action携带了这些数据。</li></ol><h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><p><strong>官方的介绍：</strong></p><p>Actions  describe the fact that something happened, but don’t specify how the  application’s state changes in response. This is the job of a reducer.</p><p><strong>中文：</strong></p><p>Action 只是描述了有事情发生了这一事实，并没有指明应用如何更新 state。这是 reducer 要做的事情。</p><p><strong>总结：</strong></p><p>Action就像leader，告诉我们应该做哪些事，并且提供数据，真正干活的是苦逼的Reducer。</p><h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>一个应用只有一个Store。一个应用只有一个Store。一个应用只有一个Store。</p><p>重要的事情放在前面说，而且说三遍。</p><p><strong>官方的介绍：</strong></p><p>In  the previous sections, we defined the actions that represent the facts  about “what happened” and the reducers that update the state according  to those actions.</p><p>The Store is the object that brings them together. The store has the following responsibilities:</p><ul><li>Holds application state;</li><li>Allows access to state via getState();</li><li>Allows state to be updated via dispatch(action);</li><li>Registers listeners via subscribe(listener).</li></ul><p><strong>翻译成中文：</strong></p><p>上面章节中，我们学会了使用 action 来描述“发生了什么”，和使用 reducers 来根据 action 更新 state 的用法。</p><p>Store 就是把它们联系到一起的对象。Store 有以下职责：</p><ul><li>保存应用的 state；</li><li>提供 getState() 方法获取 state；</li><li>提供 dispatch(action) 方法更新 state；</li><li>通过 subscribe(listener) 注册监听器。</li></ul><p><strong>总结：</strong></p><p>Store提供了一些方法。让我们很方便的操作数据。</p><p>我们不用关心Reducer和Action是怎么关联在一起的，Store已经帮我们做了这些事</p><h4 id="Redux-流程图"><a href="#Redux-流程图" class="headerlink" title="Redux 流程图"></a>Redux 流程图</h4><p><img src="https://camo.githubusercontent.com/76224d874f32535aa62c0cd01750fb71fb02cf53/687474703a2f2f70362e7168696d672e636f6d2f642f696e6e2f39613331326463632f7265647578466c6f772e706e67" alt="流程图"></p><h2 id="三、详细介绍"><a href="#三、详细介绍" class="headerlink" title="三、详细介绍"></a>三、详细介绍</h2><p>这部分主要讲解redux如何在项目中使用。</p><h4 id="Action-1"><a href="#Action-1" class="headerlink" title="Action"></a>Action</h4><p>Action 是一个普通对象。</p><p>redux约定 Action 内使用一个字符串类型的 <code>type</code> 字段来表示将要执行的动作。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="string">'ADD_ITEM'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除了 <code>type</code> 之外，Action可以存放一些其他的想要操作的数据。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="string">'ADD_ITEM'</span>,</span><br><span class="line">  text: <span class="string">'我是Berwin'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面例子表示</p><ol><li>我要创建一条数据</li><li>创建的数据为大概是这样的</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  text: <span class="string">'我是Berwin'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但在实际应用中，我们需要一个函数来为我们创建Action。这个函数叫做actionCreator。它看起来是这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: types.ADD_ITEM,</span><br><span class="line">    text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Reducer-1"><a href="#Reducer-1" class="headerlink" title="Reducer"></a>Reducer</h4><p>Reducer 是一个普通的回调函数，其函数签名为reducer(previousState, action)。</p><p>当它被Redux调用的时候会为他传递两个参数<code>State</code> 和 <code>Action</code>。</p><p>Reducer会根据 <code>Action</code> 的type来对旧的 <code>State</code> 进行操作,返回新的State。</p><p>看起来是下面这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> action = &#123;</span><br><span class="line">  type: <span class="string">'ADD_TODO'</span>,</span><br><span class="line">  text: <span class="string">'Learn Redux'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Reducer很简单，但有三点需要注意</p><ol><li>不要修改 <code>state</code>。</li><li>在 default 情况下返回旧的 state。遇到未知的 action 时，一定要返回旧的 state。</li><li>如果没有旧的State，就返回一个initialState，这很重要！！！</li></ol><p><strong>这是一部分核心源码：</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// currentState 是当前的State，currentReducer 是当前的Reducer</span></span><br><span class="line">currentState = currentReducer(currentState, action);</span><br></pre></td></tr></table></figure><p>如果在default或没有传入旧State的情况下不返回旧的State或initialState,那么当前的State会被重置为undefined！！</p><p>在使用combineReducers方法时，它也会检测你的函数写的是否标准。如果不标准，那么会抛出一个大大的错误！！</p><p><strong>combineReducers</strong></p><p>真正开发项目的时候<code>State</code>会涉及很多功能，在一个<code>Reducer</code>处理所有逻辑会非常混乱，，所以需要拆分成多个小<code>Reducer</code>，每个<code>Reducer</code>只处理它管理的那部分State数据。然后在由一个主<code>rootReducers</code>来专门管理这些小<code>Reducer</code>。</p><p>Redux提供了一个方法 <code>combineReducers</code> 专门来管理这些小Reducer。</p><p>它看起来是下面这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是一个子Reducer</span></span><br><span class="line"><span class="comment"> * @param State</span></span><br><span class="line"><span class="comment"> * @param Action</span></span><br><span class="line"><span class="comment"> * @return new State</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> list = <span class="function">(<span class="params">state = [], action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> ADD_ITEM:</span><br><span class="line">      <span class="keyword">return</span> [createItem(action.text), ...state]</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是一个简单版的子Reducer，它什么都没有做。</span></span><br><span class="line"><span class="keyword">let</span> category = <span class="function">(<span class="params">state = &#123;&#125;, action</span>) =&gt;</span> state;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 这是一个主Reducer</span></span><br><span class="line"><span class="comment"> * @param State</span></span><br><span class="line"><span class="comment"> * @param Action</span></span><br><span class="line"><span class="comment"> * @return new State</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">let</span> rootReducers = combineReducers(&#123;list, category&#125;);</span><br></pre></td></tr></table></figure><p><code>combineReducers</code> 生成了一个类似于Reducer的函数。为什么是类似于，因为它不是真正的Reducer，它只是一个调用Reducer的函数，只不过它接收的参数与真正的Reducer一模一样~</p><p><strong>这是一部分核心源码：</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 过滤reducers，把非function类型的过滤掉</span></span><br><span class="line">  <span class="keyword">var</span> finalReducers = pick(reducers, (val) =&gt; <span class="keyword">typeof</span> val === <span class="string">'function'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一开始我一直以为这个没啥用，后来我发现，这个函数太重要了。它在一开始，就已经把你的State改变了。变成了，Reducer的key 和 Reducer返回的initState组合。</span></span><br><span class="line">  <span class="keyword">var</span> defaultState = mapValues(finalReducers, () =&gt; <span class="literal">undefined</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = defaultState, action</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// finalReducers 是 reducers</span></span><br><span class="line">      <span class="keyword">var</span> finalState = mapValues(finalReducers, (reducer, key) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// state[key] 是当前Reducer所对应的State，可以理解为当前的State</span></span><br><span class="line">      <span class="keyword">var</span> previousStateForKey = state[key];</span><br><span class="line">      <span class="keyword">var</span> nextStateForKey = reducer(previousStateForKey, action);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> nextStateForKey;      </span><br><span class="line">  &#125;);</span><br><span class="line">      <span class="comment">// finalState 是 Reducer的key和stat的组合。。</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上面的源码可以看出，combineReducers 生成一个类似于Reducer的函数<code>combination</code>。</p><p>当使用combination的时候，combination会把所有子Reducer都执行一遍，子Reducer通过action.type  匹配操作，因为是执行所有子Reducer，所以如果两个子Reducer匹配的action.type是一样的，那么都会成功匹配。</p><h4 id="Store-1"><a href="#Store-1" class="headerlink" title="Store"></a>Store</h4><p>上面已经介绍什么是Store，以及它是干什么的，这里我就讲讲如何创建Store，以及如何使用Store的方法。</p><p>创建Store非常简单。createStore 有两个参数，Reducer 和 initialState。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> store = createStore(rootReducers, initialState);</span><br></pre></td></tr></table></figure><p>store有四个方法。</p><ol><li>getState： 获取应用当前State。</li><li>subscribe：添加一个变化监听器。</li><li>dispatch：分发 action。修改State。</li><li>replaceReducer：替换 store 当前用来处理 state 的 reducer。</li></ol><p>常用的是dispatch，这是修改State的唯一途径，使用起来也非常简单，他看起来是这样的~</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建Action</span></span><br><span class="line"><span class="comment"> * @param 添加的数据</span></span><br><span class="line"><span class="comment"> * @return &#123;Object&#125; Action</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: types.ADD_ITEM,</span><br><span class="line">    text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增数据</span></span><br><span class="line">store.dispatch(addItem(<span class="string">'Read the docs'</span>));</span><br></pre></td></tr></table></figure><p><strong>这是一部分核心源码：</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// currentReducer 是当前的Reducer</span></span><br><span class="line">  currentState = currentReducer(currentState, action);</span><br><span class="line"></span><br><span class="line">  listeners.slice().forEach(<span class="function"><span class="keyword">function</span> (<span class="params">listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> listener();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> action;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到其实就是把当前的Reducer执行了。并且传入State和Action。</p><p>State哪来的？</p><p>State其实一直在Redux内部保存着。并且每次执行currentReducer都会更新。在上面代码第一行可以看到。</p><h2 id="四、React-Redux"><a href="#四、React-Redux" class="headerlink" title="四、React-Redux"></a>四、React-Redux</h2><p>Redux 是独立的，它与React没有任何关系。React-Redux是官方提供的一个库，用来结合redux和react的模块。</p><p>React-Redux提供了两个接口<code>Provider</code>、<code>connect</code>。</p><h4 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h4><p>Provider是一个React组件，它的作用是保存store给子组件中的connect使用。</p><ol><li>通过getChildContext方法把store保存到context里。</li><li>后面connect中会通过context读取store。</li></ol><p>它看起来是这个样子的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Provider store=&#123;<span class="keyword">this</span>.props.store&#125;&gt;</span><br><span class="line">  &lt;h1&gt;Hello World!<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&lt;<span class="regexp">/Provider&gt;</span></span><br></pre></td></tr></table></figure><p><strong>这是一部分核心源码：</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getChildContext() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">store</span>: <span class="keyword">this</span>.store &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props, context)</span><br><span class="line">  <span class="keyword">this</span>.store = props.store</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，先获取store，然后用 getChildContext 把store保存起来~</p><h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><p>connect 会把State和dispatch转换成props传递给子组件。它看起来是下面这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> actionCreators <span class="keyword">from</span> <span class="string">'./actionCreators'</span></span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">todos</span>: state.todos &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapDispatchToProps</span>(<span class="params">dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">actions</span>: bindActionCreators(actionCreators, dispatch) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> connect(mapStateToProps, mapDispatchToProps)(Component)</span><br></pre></td></tr></table></figure><p>它会让我们传递一些参数：mapStateToProps，mapDispatchToProps，mergeProps（可不填）和React组件。</p><p>之后这个方法会进行一系列的黑魔法，把state，dispatch转换成props传到React组件上，返回给我们使用。</p><p><strong>mapStateToProps：</strong></p><p>mapStateToProps 是一个普通的函数。</p><p>当它被connect调用的时候会为它传递一个参数State。</p><p>mapStateToProps需要负责的事情就是   返回需要传递给子组件的State，返回需要传递给子组件的State，返回需要传递给子组件的State，（重要的事情说三遍。。。。）然后connect会拿到返回的数据写入到react组件中，然后组件中就可以通过props读取数据啦~~~~</p><p>它看起来是这样的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapStateToProps</span>(<span class="params">state</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">list</span>: state.list &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为stat是全局State，里面包含整个项目的所有State，但是我不需要拿到所有State，我只拿到我需要的那部分State即可，所以需要返回 state.list 传递给组件</p><p><strong>mapDispatchToProps：</strong></p><p>与mapStateToProps很像，mapDispatchToProps也是一个普通的函数。</p><p>当它被connect调用的时候会为它传递一个参数dispatch。</p><p>mapDispatchToProps负责返回一个 <code>dispatchProps</code></p><p><code>dispatchProps</code> 是actionCreator的key和dispatch(action)的组合。</p><p><code>dispatchProps</code> 看起来长这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  addItem: <span class="function">(<span class="params">text</span>) =&gt;</span> dispatch(action)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>connect 收到这样的数据后，会把它放到React组件上。然后子组件就可以通过props拿到addItem并且使用啦。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.props.addItem(<span class="string">'Hello World~'</span>);</span><br></pre></td></tr></table></figure><p>如果觉得复杂，不好理解，，那我用大白话描述一下</p><p>就是通过mapDispatchToProps这个方法，把actionCreator变成方法赋值到props，每当调用这个方法，就会更新State。。。。额，，这么说应该好理解了。。</p><p><strong>bindActionCreators：</strong></p><p>但如果我有很多个Action，总不能手动一个一个加。Redux提供了一个方法叫 <code>bindActionCreators</code>。</p><p><code>bindActionCreators</code> 的作用就是将 <code>Actions</code> 和 <code>dispatch</code> 组合起来生成 <code>mapDispatchToProps</code> 需要生成的内容。</p><p>它看起来像这样：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> actions = &#123;</span><br><span class="line">  addItem: <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">    type: types.ADD_ITEM,</span><br><span class="line">    text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bindActionCreators(actions, dispatch); <span class="comment">// @return &#123;addItem: (text) =&gt; dispatch(&#123; type: types.ADD_ITEM, text &#125;)&#125;</span></span><br></pre></td></tr></table></figure><p><strong>这是一部分核心源码：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function bindActionCreator(actionCreator, dispatch) &#123;</span><br><span class="line">  return (...args) =&gt; dispatch(actionCreator(...args));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// mapValues： map第一个参数的每一项，返回对象，key是key，value是第二个参数返回的数据</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * mapValues： map第一个参数的每一项，返回对象，key是key，value是第二个参数返回的数据</span><br><span class="line"> * @param actionCreators</span><br><span class="line"> * @param dispatch</span><br><span class="line"> * @return &#123;actionKey: (...args) =&gt; dispatch(actionCreator(...args))&#125;</span><br><span class="line"> */</span><br><span class="line">export default function bindActionCreators(actionCreators, dispatch) &#123;</span><br><span class="line">  return mapValues(actionCreators, actionCreator =&gt;</span><br><span class="line">    bindActionCreator(actionCreator, dispatch)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，<code>bindActionCreators</code> 执行这个方法之后，它把 <code>actionCreators</code> 的每一项的 <code>key</code> 不变，<code>value</code> 变成 <code>dispatch(actionCreator(...args))</code> 这玩意，这表示，<code>actionCreator</code> 已经变成了一个可执行的方法，执行这个方法，就会执行 <code>dispatch</code> 更新数据。。</p><p><strong>加了React-Redux之后的流程图</strong></p><p><img src="https://camo.githubusercontent.com/1d3eb7f2982f8c6982a6e74f1dd6fbe872189845/687474703a2f2f70392e7168696d672e636f6d2f642f696e6e2f61386162336561342f72656163742d72656475782e706e67" alt="流程图"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Demo&quot;&gt;&lt;a href=&quot;#Demo&quot; class=&quot;headerlink&quot; title=&quot;Demo&quot;&gt;&lt;/a&gt;Demo&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre
      
    
    </summary>
    
      <category term="React" scheme="https://gyunzhi.github.io/categories/React/"/>
    
    
      <category term="React" scheme="https://gyunzhi.github.io/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>跨文档消息通信</title>
    <link href="https://gyunzhi.github.io/2018/08/05/%E8%B7%A8%E6%96%87%E6%A1%A3%E6%B6%88%E6%81%AF%E9%80%9A%E4%BF%A1/"/>
    <id>https://gyunzhi.github.io/2018/08/05/跨文档消息通信/</id>
    <published>2018-08-05T10:28:56.000Z</published>
    <updated>2019-05-06T09:26:27.154Z</updated>
    
    <content type="html"><![CDATA[<p>在开发过程中我们会使用<code>ifram</code>来嵌入一个页面或者通过<code>window.open</code>打开一个新的窗口，这两个窗口之间有时候需要通信，下面我们看下具体会有哪些情况。</p><p>不同窗口之间通信有两种情况：</p><p>ifram             与通过ifram标签打开的窗口通信</p><p>window.open    与window.open打开的窗口通信</p><p>这两种情况又分为了同域下的窗口通信和不同域下的通信</p><h2 id="同域下的窗口通信"><a href="#同域下的窗口通信" class="headerlink" title="同域下的窗口通信"></a>同域下的窗口通信</h2><h3 id="ifram"><a href="#ifram" class="headerlink" title="ifram"></a>ifram</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 通过js可以访问被包含页面的DOM元素</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oMyIframe = <span class="built_in">document</span>.getElementById(<span class="string">'myframe'</span>);</span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="comment">// 如果我们要操作一个iframe里面的dom元素，需要通过 contentWindow 获取到iframe引入的页面的window对象</span></span></span><br><span class="line"><span class="javascript">oMyIframe.contentWindow.document.body.style.background = <span class="string">'red'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，改变2.iframe.html的背景色"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"myframe"</span> <span class="attr">src</span>=<span class="string">"2.iframe.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span> : 当前窗口 </span></span><br><span class="line"><span class="undefined">parent : 父级窗口</span></span><br><span class="line"><span class="undefined">top : 顶级窗口</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="comment">//parent =&gt; window 如果当前页面是顶级，没有被其他页面所包含，那么parent就是当前页面的window对象，那么如果被包含了，则parent就是包含当前页面的父级页面的window对象</span></span></span><br><span class="line"><span class="javascript">parent.document.body.style.background = <span class="string">'green'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">这里是2.iframe.html页面</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，改变1.iframe.html的背景色"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="window-open"><a href="#window-open" class="headerlink" title="window.open"></a>window.open</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn2 = <span class="built_in">document</span>.getElementById(<span class="string">'btn2'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> newWindow = <span class="literal">null</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="comment">//window.open 返回被打开窗口的window对象</span></span></span><br><span class="line"><span class="javascript">newWindow = <span class="built_in">window</span>.open(<span class="string">'2.window.open.html'</span>, <span class="string">'_blank'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oBtn2.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">newWindow.document.body.style.background = <span class="string">'red'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，开启一个新的窗口打开2.window.open.html页面"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，改变2.window.open.html页面的背景色"</span> <span class="attr">id</span>=<span class="string">"btn2"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="comment">//window.opener : 通过window.open方法打开当前页面的窗口的window对象</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.opener.document.body.style.background = <span class="string">'green'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">这是4.window.open.html页面</span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，改变1.window.open.html页面的背景色"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="不同域下的窗口通信（跨文档通信）"><a href="#不同域下的窗口通信（跨文档通信）" class="headerlink" title="不同域下的窗口通信（跨文档通信）"></a>不同域下的窗口通信（跨文档通信）</h2><p>问题：跨域之后之前同域下的操作都失效了，会产生跨域安全限制问题</p><p>解决：postMessage方法，通过这个方法给另外一个窗口发送信息 （注意：接收消息的窗口的window对象调用postMessage方法）</p><h3 id="a域名"><a href="#a域名" class="headerlink" title="a域名"></a>a域名</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>)</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oMyIframe = <span class="built_in">document</span>.getElementById(<span class="string">'myframe'</span>)</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">postMessage : 可以通过这个方法给另外一个窗口发送信息</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">注意：接收消息的窗口的<span class="built_in">window</span>对象调用postMessage方法</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">第一个参数：发送的数据</span></span><br><span class="line"><span class="undefined">第二个参数：接收数据的域名｛带上协议｝</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript">oMyIframe.contentWindow.postMessage(<span class="string">'1'</span>, <span class="string">'http://www.b.com'</span>)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"点击我，www.b.com域名下postMessage.html的背景色"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">"myframe"</span> <span class="attr">src</span>=<span class="string">"http://www.b.com/postMessage.html"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="b域名"><a href="#b域名" class="headerlink" title="b域名"></a>b域名</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// message事件 : 当窗口接收到通过postMessage发送过来的数据的时候触发</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">message事件的事件对象下保存了发送过来的内容</span></span><br><span class="line"><span class="undefined">ev.data: 发送过来的数据</span></span><br><span class="line"><span class="undefined">ev.origin: 发送消息的域名</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> (ev.data == <span class="string">'1'</span>) &#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.style.background = <span class="string">'red'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript">&#125;, <span class="literal">false</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">这是b.com的postMessage.html页面</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在开发过程中我们会使用&lt;code&gt;ifram&lt;/code&gt;来嵌入一个页面或者通过&lt;code&gt;window.open&lt;/code&gt;打开一个新的窗口，这两个窗口之间有时候需要通信，下面我们看下具体会有哪些情况。&lt;/p&gt;
&lt;p&gt;不同窗口之间通信有两种情况：&lt;/p&gt;
&lt;p&gt;ifra
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>事件探究</title>
    <link href="https://gyunzhi.github.io/2018/07/21/%E4%BA%8B%E4%BB%B6%E6%8E%A2%E7%A9%B6/"/>
    <id>https://gyunzhi.github.io/2018/07/21/事件探究/</id>
    <published>2018-07-21T12:16:56.000Z</published>
    <updated>2019-05-06T09:26:27.136Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>事件是异步编程的一种实现，事件机制是对<strong>观察者模式</strong>（有时被称作发布/订阅模式 ）的进一步抽象。观察者(Observer)相当于事件监听者，被观察者(Observable)或者说主题(Subject)相当于事件源和事件，事件发生时通知事件监听者，执行相应的回调函数。</p><p><img src="http://img.gongyz.cn/blog/181031/K67L8aEkF3.jpg" alt="mark"></p><p><strong>事件监听机制主要由事件源、事件对象、事件监听器三个部分组成：</strong></p><p>事件源： 点击一个button，触发click事件，这个button就是事件源</p><p>事件对象：事件发生以后，会产生一个事件对象，作为参数传给监听函数 ，里面保存了和当前这个事件有关的一些详细信息 </p><p>事件监听器：用来注册、监听和触发事件，操作部署在EventTarget接口</p><h3 id="EventTarget接口"><a href="#EventTarget接口" class="headerlink" title="EventTarget接口"></a><strong>EventTarget接口</strong></h3><p>DOM 的事件操作（监听和触发），都定义在<code>EventTarget</code>接口。所有节点对象都部署了这个接口，其他一些需要事件通信的浏览器内置对象（比如，<code>XMLHttpRequest</code>、<code>AudioNode</code>、<code>AudioContext</code>）也部署了这个接口。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">注意: Internet Explorer 6-8 并不支持这个方法，而是提供了类似的 `element.attachEvent` API 。如果要进行跨浏览器使用，请考虑使用有效的JavaScript 库。</span><br></pre></td></tr></table></figure><p>该接口主要提供三个实例方法。</p><ul><li><code>addEventListener</code>：绑定事件的监听函数</li><li><code>removeEventListener</code>：移除事件的监听函数</li><li><code>dispatchEvent</code>：触发事件</li></ul><p><strong>（1）addEventListener</strong></p><p><code>EventTarget.addEventListener()</code>用于在当前节点或对象上，定义一个特定事件的监听函数。一旦这个事件发生，就会执行监听函数。该方法没有返回值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.addEventListener(type, listener[, useCapture]);</span><br></pre></td></tr></table></figure><p>该方法接受三个参数。</p><ul><li><code>type</code>：事件名称，大小写敏感。</li><li><code>listener</code>：监听函数。事件发生时，会调用该监听函数。</li><li><code>useCapture</code>：布尔值，表示监听函数是否在捕获阶段（capture）触发（参见后文事件流部分），默认为<code>false</code>（监听函数只在冒泡阶段被触发），该参数可选。</li></ul><p>下面是一个例子。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hello world'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> button = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span><br><span class="line">button.addEventListener(<span class="string">'click'</span>, hello, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>button</code>节点的<code>addEventListener</code>方法绑定<code>click</code>事件的监听函数<code>hello</code>，该函数只在冒泡阶段触发。</p><p>关于参数，有两个地方需要注意。</p><p>首先，第二个参数除了监听函数，还可以是一个具有<code>handleEvent</code>方法的对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">buttonElement.addEventListener(<span class="string">'click'</span>, &#123;</span><br><span class="line">  handleEvent: <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'click'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>addEventListener</code>方法的第二个参数，就是一个具有<code>handleEvent</code>方法的对象。</p><p>其次，第三个参数除了布尔值<code>useCapture</code>，还可以是一个属性配置对象。该对象有以下属性。</p><blockquote><ul><li><code>capture</code>：布尔值，表示该事件是否在<code>捕获阶段</code>触发监听函数。</li><li><code>once</code>：布尔值，表示监听函数是否只触发一次，然后就自动移除。</li><li><code>passive</code>：布尔值，表示监听函数不会调用事件的<code>preventDefault</code>方法。如果监听函数调用了，浏览器将忽略这个要求，并在监控台输出一行警告。</li></ul></blockquote><p>如果希望事件监听函数只执行一次，可以打开属性配置对象的<code>once</code>属性。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">element.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 只执行一次的代码</span></span><br><span class="line">&#125;, &#123;<span class="attr">once</span>: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure><p><code>addEventListener</code>方法可以为针对当前对象的同一个事件，添加多个不同的监听函数。这些函数按照添加顺序触发，即先添加先触发。如果为同一个事件多次添加同一个监听函数，该函数只会执行一次，多余的添加将自动被去除（不必使用<code>removeEventListener</code>方法手动去除）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Hello world'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, hello, <span class="literal">false</span>);</span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">'click'</span>, hello, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>执行上面代码，点击文档只会输出一行<code>Hello world</code>。</p><p><strong>如果希望向监听函数传递参数，可以用匿名函数包装一下监听函数。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> el = <span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span><br><span class="line">el.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; print(<span class="string">'Hello'</span>); &#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码通过匿名函数，向监听函数<code>print</code>传递了一个参数，<em>如果不使用匿名函数包装，<code>print</code>会直接执行</em>。</p><p><strong>（2）removeEventListener</strong></p><p><code>EventTarget.removeEventListener</code>方法用来移除<code>addEventListener</code>方法添加的事件监听函数。该方法没有返回值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.addEventListener(<span class="string">'click'</span>, listener, <span class="literal">false</span>);</span><br><span class="line">div.removeEventListener(<span class="string">'click'</span>, listener, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p><code>removeEventListener</code>方法的参数，与<code>addEventListener</code>方法完全一致。它的第一个参数“事件类型”，大小写敏感。</p><p>注意，<code>removeEventListener</code>方法移除的监听函数，必须是<code>addEventListener</code>方法添加的那个监听函数，而且必须在同一个元素节点，否则无效。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">div.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;&#125;, <span class="literal">false</span>);</span><br><span class="line">div.removeEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;&#125;, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>removeEventListener</code>方法无效，因为监听函数不是同一个匿名函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">element.addEventListener(<span class="string">'mousedown'</span>, handleMouseDown, <span class="literal">true</span>);</span><br><span class="line">element.removeEventListener(<span class="string">"mousedown"</span>, handleMouseDown, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>removeEventListener</code>方法也是无效的，因为第三个参数不一样。</p><p><strong>（3）dispatchEvent</strong></p><p><code>EventTarget.dispatchEvent</code>方法在当前节点上触发指定事件，从而触发监听函数的执行。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target.dispatchEvent(event)</span><br></pre></td></tr></table></figure><p><code>dispatchEvent</code>方法的参数是一个<code>Event</code>对象的实例（参见后文Event对象部分）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="built_in">document</span>.getElementById(<span class="string">'el'</span>)</span><br><span class="line">el.addEventListener(<span class="string">'click'</span>, hello, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">var</span> event = <span class="keyword">new</span> Event(<span class="string">'click'</span>);</span><br><span class="line">el.dispatchEvent(event);</span><br></pre></td></tr></table></figure><p>上面代码在当前节点触发了<code>click</code>事件。</p><p>如果<code>dispatchEvent</code>方法的参数为空，或者不是一个有效的事件对象，将报错。</p><h3 id="Event对象"><a href="#Event对象" class="headerlink" title="Event对象"></a>Event对象</h3><p>事件发生以后，会产生一个事件对象，作为参数传给监听函数。浏览器原生提供一个<code>Event</code>对象，所有的事件都是这个对象的实例，或者说继承了<code>Event.prototype</code>对象。</p><p><code>Event</code>对象本身就是一个构造函数，可以用来生成新的实例。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">event = <span class="keyword">new</span> Event(type, options);</span><br></pre></td></tr></table></figure><p><code>Event</code>构造函数接受两个参数。第一个参数<code>type</code>是字符串，表示事件的名称；第二个参数<code>options</code>是一个对象，表示事件对象的配置。该对象主要有下面两个属性。</p><ul><li><p><code>bubbles</code>：布尔值，可选，默认为<code>false</code>，表示事件对象是否冒泡。</p></li><li><p><code>cancelable</code>：布尔值，可选，默认为<code>false</code>，表示是否可以通过<code>Event.preventDefault()</code>方法取消浏览器对该事件的默认行为。</p></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ev = <span class="keyword">new</span> Event(</span><br><span class="line">  <span class="string">'look'</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">'bubbles'</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">'cancelable'</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="built_in">document</span>.dispatchEvent(ev);</span><br></pre></td></tr></table></figure><p>上面代码新建一个<code>look</code>事件实例，然后使用<code>dispatchEvent</code>方法触发该事件。</p><p>注意，如果不是显式指定<code>bubbles</code>属性为<code>true</code>，生成的事件就只能在“捕获阶段”触发监听函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码为</span></span><br><span class="line"><span class="comment">// &lt;div&gt;&lt;p&gt;Hello&lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="keyword">var</span> div = <span class="built_in">document</span>.querySelector(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.querySelector(<span class="string">'p'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> tag = event.currentTarget.tagName;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Tag: '</span> + tag); <span class="comment">// 没有任何输出</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">div.addEventListener(<span class="string">'click'</span>, callback, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> click = <span class="keyword">new</span> Event(<span class="string">'click'</span>);</span><br><span class="line">p.dispatchEvent(click);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>p</code>元素发出一个<code>click</code>事件，该事件默认不会冒泡。<code>div.addEventListener</code>方法指定在冒泡阶段监听，因此监听函数不会触发。如果写成<code>div.addEventListener(&#39;click&#39;, callback, true)</code>，那么在“捕获阶段”可以监听到这个事件。</p><h4 id="实例属性"><a href="#实例属性" class="headerlink" title="实例属性"></a><strong>实例属性</strong></h4><p><strong>Event.bubbles，Event.eventPhase</strong>   </p><p><code>Event.bubbles</code>属性返回一个布尔值，表示当前事件是否会冒泡。该属性为只读属性，一般用来了解 Event 实例是否可以冒泡。前面说过，除非显式声明，<code>Event</code>构造函数生成的事件，默认是不冒泡的。</p><p><code>Event.eventPhase</code>属性返回一个整数常量，表示事件目前所处的阶段。该属性只读。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> phase = event.eventPhase;</span><br></pre></td></tr></table></figure><p><code>Event.eventPhase</code>的返回值有四种可能。</p><ul><li>0，事件目前没有发生。</li><li>1，事件目前处于捕获阶段，即处于从祖先节点向目标节点的传播过程中。</li><li>2，事件到达目标节点，即<code>Event.target</code>属性指向的那个节点。</li><li>3，事件处于冒泡阶段，即处于从目标节点向祖先节点的反向传播过程中。</li></ul><p><strong>Event.cancelable，Event.cancelBubble，event.defaultPrevented</strong>   </p><p><code>Event.cancelable</code>属性返回一个布尔值，表示事件是否可以取消。该属性为只读属性，一般用来了解 Event 实例的特性。</p><p>大多数浏览器的原生事件是可以取消的。比如，取消<code>click</code>事件，点击链接将无效。但是除非显式声明，<code>Event</code>构造函数生成的事件，默认是不可以取消的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evt = <span class="keyword">new</span> Event(<span class="string">'foo'</span>);</span><br><span class="line">evt.cancelable  <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p>当<code>Event.cancelable</code>属性为<code>true</code>时，调用<code>Event.preventDefault()</code>就可以取消这个事件，阻止浏览器对该事件的默认行为。</p><p>如果事件不能取消，调用<code>Event.preventDefault()</code>会没有任何效果。所以使用这个方法之前，最好用<code>Event.cancelable</code>属性判断一下是否可以取消。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">preventEvent</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (event.cancelable) &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">'This event couldn\'t be canceled.'</span>);</span><br><span class="line">    <span class="built_in">console</span>.dir(event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Event.cancelBubble</code>属性是一个布尔值，如果设为<code>true</code>，相当于执行<code>Event.stopPropagation()</code>，可以阻止事件的传播。</p><p><code>Event.defaultPrevented</code>属性返回一个布尔值，表示该事件是否调用过<code>Event.preventDefault</code>方法。该属性只读。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (event.defaultPrevented) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'该事件已经取消了'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Event.currentTarget，Event.target</strong>   </p><p><code>Event.currentTarget</code>属性返回事件当前所在的节点，即正在执行的监听函数所绑定的那个节点。</p><p><code>Event.target</code>属性返回原始触发事件的那个节点，即事件最初发生的节点。事件传播过程中，不同节点的监听函数内部的<code>Event.target</code>与<code>Event.currentTarget</code>属性的值是不一样的，前者总是不变的，后者则是指向监听函数所在的那个节点对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML代码为</span></span><br><span class="line"><span class="comment">// &lt;p id="para"&gt;Hello &lt;em&gt;World&lt;/em&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hide</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span> === e.currentTarget);  <span class="comment">// 总是 true</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span> === e.target);  <span class="comment">// 有可能不是 true</span></span><br><span class="line">  e.target.style.visibility = <span class="string">'hidden'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">para.addEventListener(<span class="string">'click'</span>, hide, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码中，如果在<code>para</code>节点的<code>&lt;em&gt;</code>子节点上面点击，则<code>e.target</code>指向<code>&lt;em&gt;</code>子节点，导致<code>&lt;em&gt;</code>子节点（即 World 部分）会不可见。如果点击 Hello 部分，则整个<code>para</code>都将不可见。</p><p><strong>Event.type</strong>   </p><p><code>Event.type</code>属性返回一个字符串，表示事件类型。事件的类型是在生成事件的时候。该属性只读。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evt = <span class="keyword">new</span> Event(<span class="string">'foo'</span>);</span><br><span class="line">evt.type <span class="comment">// "foo"</span></span><br></pre></td></tr></table></figure><p><strong>Event.timeStamp</strong>   </p><p><code>Event.timeStamp</code>属性返回一个毫秒时间戳，表示事件发生的时间。它是相对于网页加载成功开始计算的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evt = <span class="keyword">new</span> Event(<span class="string">'foo'</span>);</span><br><span class="line">evt.timeStamp <span class="comment">// 3683.6999999995896</span></span><br></pre></td></tr></table></figure><p>它的返回值有可能是整数，也有可能是小数（高精度时间戳），取决于浏览器的设置。</p><p>下面是一个计算鼠标移动速度的例子，显示每秒移动的像素数量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> previousX;</span><br><span class="line"><span class="keyword">var</span> previousY;</span><br><span class="line"><span class="keyword">var</span> previousT;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'mousemove'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    previousX !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">    previousY !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">    previousT !== <span class="literal">undefined</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">var</span> deltaX = event.screenX - previousX;</span><br><span class="line">    <span class="keyword">var</span> deltaY = event.screenY - previousY;</span><br><span class="line">    <span class="keyword">var</span> deltaD = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(deltaX, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(deltaY, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> deltaT = event.timeStamp - previousT;</span><br><span class="line">    <span class="built_in">console</span>.log(deltaD / deltaT * <span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  previousX = event.screenX;</span><br><span class="line">  previousY = event.screenY;</span><br><span class="line">  previousT = event.timeStamp;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>Event.isTrusted</strong>   </p><p><code>Event.isTrusted</code>属性返回一个布尔值，表示该事件是否由真实的用户行为产生。比如，用户点击链接会产生一个<code>click</code>事件，该事件是用户产生的；<code>Event</code>构造函数生成的事件，则是脚本产生的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evt = <span class="keyword">new</span> Event(<span class="string">'foo'</span>);</span><br><span class="line">evt.isTrusted <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p>上面代码中，<code>evt</code>对象是脚本产生的，所以<code>isTrusted</code>属性返回<code>false</code>。</p><p><strong>Event.detail</strong>   </p><p><code>Event.detail</code>属性只有浏览器的 UI （用户界面）事件才具有。该属性返回一个数值，表示事件的某种信息。具体含义与事件类型相关。比如，对于<code>click</code>和<code>dbclick</code>事件，<code>Event.detail</code>是鼠标按下的次数（<code>1</code>表示单击，<code>2</code>表示双击，<code>3</code>表示三击）；对于鼠标滚轮事件，<code>Event.detail</code>是滚轮正向滚动的距离，负值就是负向滚动的距离，返回值总是3的倍数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码如下</span></span><br><span class="line"><span class="comment">// &lt;p&gt;Hello&lt;/p&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">giveDetails</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.detail);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'p'</span>).onclick = giveDetails;</span><br></pre></td></tr></table></figure><h4 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h4><p><strong>Event.preventDefault()</strong>   </p><p><code>Event.preventDefault</code>方法取消浏览器对当前事件的默认行为。比如点击链接后，浏览器默认会跳转到另一个页面，使用这个方法以后，就不会跳转了；再比如，按一下空格键，页面向下滚动一段距离，使用这个方法以后也不会滚动了。该方法生效的前提是，事件对象的<code>cancelable</code>属性为<code>true</code>，如果为<code>false</code>，调用该方法没有任何效果。</p><p>注意，该方法只是取消事件对当前元素的默认影响，不会阻止事件的传播。如果要阻止传播，可以使用<code>stopPropagation()</code>或<code>stopImmediatePropagation()</code>方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码为</span></span><br><span class="line"><span class="comment">// &lt;input type="checkbox" id="my-checkbox" /&gt;</span></span><br><span class="line"><span class="keyword">var</span> cb = <span class="built_in">document</span>.getElementById(<span class="string">'my-checkbox'</span>);</span><br><span class="line"></span><br><span class="line">cb.addEventListener(</span><br><span class="line">  <span class="string">'click'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">e</span>)</span>&#123; e.preventDefault(); &#125;,</span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>上面代码中，浏览器的默认行为是单击会选中单选框，取消这个行为，就导致无法选中单选框。</p><p>利用这个方法，可以为文本输入框设置校验条件。如果用户的输入不符合条件，就无法将字符输入文本框。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码为</span></span><br><span class="line"><span class="comment">// &lt;input type="text" id="my-input" /&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">'my-input'</span>);</span><br><span class="line">input.addEventListener(<span class="string">'keypress'</span>, checkName, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkName</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (e.charCode &lt; <span class="number">97</span> || e.charCode &gt; <span class="number">122</span>) &#123;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面代码为文本框的<code>keypress</code>事件设定监听函数后，将只能输入小写字母，否则输入事件的默认行为（写入文本框）将被取消，导致不能向文本框输入内容。</p><p><strong>Event.stopPropagation()</strong>   </p><p><code>stopPropagation</code>方法阻止事件在 DOM 中继续传播，防止再触发定义在别的节点上的监听函数，但是不包括在当前节点上其他的事件监听函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stopEvent</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  e.stopPropagation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">el.addEventListener(<span class="string">'click'</span>, stopEvent, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码中，<code>click</code>事件将不会进一步冒泡到<code>el</code>节点的父节点。</p><p><strong>Event.stopImmediatePropagation()</strong>   </p><p><code>Event.stopImmediatePropagation</code>方法阻止同一个事件的其他监听函数被调用，不管监听函数定义在当前节点还是其他节点。也就是说，该方法阻止事件的传播，比<code>Event.stopPropagation()</code>更彻底。</p><p>如果同一个节点对于同一个事件指定了多个监听函数，这些函数会根据添加的顺序依次调用。只要其中有一个监听函数调用了<code>Event.stopImmediatePropagation</code>方法，其他的监听函数就不会再执行了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">l1</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  e.stopImmediatePropagation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">l2</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'hello world'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">el.addEventListener(<span class="string">'click'</span>, l1, <span class="literal">false</span>);</span><br><span class="line">el.addEventListener(<span class="string">'click'</span>, l2, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>上面代码在<code>el</code>节点上，为<code>click</code>事件添加了两个监听函数<code>l1</code>和<code>l2</code>。由于<code>l1</code>调用了<code>event.stopImmediatePropagation</code>方法，所以<code>l2</code>不会被调用。</p><p><strong>Event.composedPath()</strong>   </p><p><code>Event.composedPath()</code>返回一个数组，成员是事件的最底层节点和依次冒泡经过的所有上层节点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码如下</span></span><br><span class="line"><span class="comment">// &lt;div&gt;</span></span><br><span class="line"><span class="comment">//   &lt;p&gt;Hello&lt;/p&gt;</span></span><br><span class="line"><span class="comment">// &lt;/div&gt;</span></span><br><span class="line"><span class="keyword">var</span> div = <span class="built_in">document</span>.querySelector(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.querySelector(<span class="string">'p'</span>);</span><br><span class="line"></span><br><span class="line">div.addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e.composedPath());</span><br><span class="line">&#125;, <span class="literal">false</span>);</span><br><span class="line"><span class="comment">// [p, div, body, html, document, Window]</span></span><br></pre></td></tr></table></figure><p>上面代码中，<code>click</code>事件的最底层节点是<code>p</code>，向上依次是<code>div</code>、<code>body</code>、<code>html</code>、<code>document</code>、<code>Window</code>。</p><h4 id="自定义事件"><a href="#自定义事件" class="headerlink" title="自定义事件"></a>自定义事件</h4><p>下面是一个代码代码示例演示如何派发一个自定义的事件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">  &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span><br><span class="line">  &lt;meta http-equiv=<span class="string">"X-UA-Compatible"</span> content=<span class="string">"ie=edge"</span>&gt;</span><br><span class="line">  &lt;title&gt;Document&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;a id=<span class="string">'el'</span> href=<span class="string">"javascript:;"</span>&gt;click&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">ev</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 事件对象可以是通过事件函数的第一个参数传入也可以是全局的event对象</span></span><br><span class="line">    <span class="built_in">console</span>.log(event)</span><br><span class="line">    <span class="built_in">console</span>.log(ev)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> el= <span class="built_in">document</span>.getElementById(<span class="string">'el'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (el.addEventListener) &#123;</span><br><span class="line">    el.addEventListener(<span class="string">'click'</span>, fn, <span class="literal">false</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    el.attachEvent(<span class="string">'onclick'</span>, fn)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> event = <span class="keyword">new</span> Event(<span class="string">'click'</span>, &#123;<span class="attr">cancelable</span>: <span class="literal">false</span>&#125;);</span><br><span class="line">  el.dispatchEvent(event)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IE下触发click事件</span></span><br><span class="line">  <span class="comment">// el.click()</span></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><h3 id="绑定事件监听函数"><a href="#绑定事件监听函数" class="headerlink" title="绑定事件监听函数"></a>绑定事件监听函数</h3><p>JavaScript 有三种方法，可以为事件绑定监听函数。</p><p><strong>HTML 的 on- 属性</strong>   </p><p>HTML 语言允许在元素的属性中，直接定义某些事件的监听代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onload=<span class="string">"doSomething()"</span>&gt;</span><br><span class="line">&lt;div onclick=<span class="string">"console.log('触发事件')"</span>&gt;</span><br></pre></td></tr></table></figure><p>上面代码为<code>body</code>节点的<code>load</code>事件、<code>div</code>节点的<code>click</code>事件，指定了监听代码。一旦事件发生，就会执行这段代码。</p><p>元素的事件监听属性，都是<code>on</code>加上事件名，比如<code>onload</code>就是<code>on + load</code>，表示<code>load</code>事件的监听代码。</p><p>注意，这些属性的值是将会执行的代码，而不是一个函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 正确 --&gt;</span><br><span class="line">&lt;body onload=<span class="string">"doSomething()"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- 错误 --&gt;</span><br><span class="line">&lt;body onload=<span class="string">"doSomething"</span>&gt;</span><br></pre></td></tr></table></figure><p>一旦指定的事件发生，<code>on-</code>属性的值是原样传入 JavaScript 引擎执行。因此如果要执行函数，不要忘记加上一对圆括号。</p><p>直接设置<code>on-</code>属性，与通过元素节点的<code>setAttribute</code>方法设置<code>on-</code>属性，效果是一样的。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">el.setAttribute(<span class="string">'onclick'</span>, <span class="string">'doSomething()'</span>);</span><br><span class="line"><span class="comment">// 等同于</span></span><br><span class="line"><span class="comment">// &lt;Element onclick="doSomething()"&gt;</span></span><br></pre></td></tr></table></figure><p><strong>元素节点的事件属性</strong>   </p><p>元素节点对象的事件属性，同样可以指定监听函数。这些事件属性由<a href="https://wangdoc.com/javascript/events/globaleventhandlers.html" target="_blank" rel="noopener">GlobalEventHandlers</a>接口提供 。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = doSomething;</span><br><span class="line">div.onclick = <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'触发事件'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>使用这个方法指定的监听函数的优点是使用比较方便，缺点是只能为每个事件指定一个回调函数，并且无法指定事件触发的阶段（捕获阶段还是冒泡阶段） </p><p><strong>EventTarget.addEventListener</strong> </p><p>所有 DOM 节点实例都有<code>addEventListener</code>方法，用来为该节点定义事件的监听函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'load'</span>, doSomething, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p><code>addEventListener</code>方法的详细介绍，参见上文<code>EventTarget</code>接口。</p><p><strong>小结</strong>   </p><p>上面三种方法，第一种“HTML 的 on- 属性”，违反了 HTML 与 JavaScript 代码相分离的原则，将两者写在一起，不利于代码分工，因此不推荐使用。</p><p>第二种“元素节点的事件属性”的缺点在于，同一个事件只能定义一个监听函数，也就是说，如果定义两次<code>onclick</code>属性，后一次定义会覆盖前一次。因此，也不推荐使用。</p><p>第三种<code>EventTarget.addEventListener</code>是推荐的指定监听函数的方法。它有如下优点：</p><ul><li>同一个事件可以添加多个监听函数。</li><li>能够指定在哪个阶段（捕获阶段还是冒泡阶段）触发监听函数。</li><li>除了 DOM 节点，其他对象（比如<code>window</code>、<code>XMLHttpRequest</code>等）也有这个接口，它等于是整个 JavaScript 统一的监听函数接口。</li></ul><h3 id="事件监听函数this指向"><a href="#事件监听函数this指向" class="headerlink" title="事件监听函数this指向"></a>事件监听函数this指向</h3><p>监听函数内部的<code>this</code>指向触发事件的那个元素节点。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button id=<span class="string">"btn"</span> onclick=<span class="string">"console.log(this.id)"</span>&gt;点击&lt;<span class="regexp">/button&gt;</span></span><br></pre></td></tr></table></figure><p>执行上面代码，点击后会输出<code>btn</code>。</p><p>其他两种监听函数的写法，<code>this</code>的指向也是如此。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTML 代码如下</span></span><br><span class="line"><span class="comment">// &lt;button id="btn"&gt;点击&lt;/button&gt;</span></span><br><span class="line"><span class="keyword">var</span> btn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写法一</span></span><br><span class="line">btn.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.id);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 写法二</span></span><br><span class="line">btn.addEventListener(</span><br><span class="line">  <span class="string">'click'</span>,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.id);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">false</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>上面两种写法，点击按钮以后也是输出<code>btn</code>。</p><h3 id="事件流"><a href="#事件流" class="headerlink" title="事件流"></a>事件流</h3><p>事件流描述的是页面中节点元素接收到事件的顺序，有意思的时早期IE和NetScape提出了两种相反的事件流的概念，IE提出的是事件冒泡流，而NetScape提出的是事件捕获流。在最新的规范出来之后，一般采用的是标准的DOM事件流。</p><p><img src="http://img.gongyz.cn/blog/181031/fE35IL7BIj.png" alt="mark"></p><p>从上图我们可以知道：</p><p>事件冒泡：事件开始时由<strong>最具体的元素接收，然后逐级向上传播到较为不具体的节点</strong> </p><p>事件捕获：事件开始时由<strong>不太具体的DOM节点应该更早接收到事件，而最具体的节点应该最后接收到事件</strong> </p><p>DOM事件流：包含3个阶段，<strong>事件捕获阶段、处于目标阶段、事件冒泡阶段</strong> ，默认是在冒泡阶段去执行监听函数</p><h3 id="事件委托"><a href="#事件委托" class="headerlink" title="事件委托"></a>事件委托</h3><p>事件委托利用了事件冒泡，只指定一个事件处理程序，就可以管理某一类型的所有事件 。可以防止事件处理程序过多，提高页面性能。<strong><em>事件委托还有一个好处就是动态添加进来的元素也能绑定事件处理函数</em></strong> </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul id=<span class="string">"ul"</span>&gt;</span><br><span class="line">    &lt;li&gt;<span class="number">111</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;222&lt;/</span>li&gt;</span><br><span class="line">    &lt;li&gt;<span class="number">333</span>&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;444&lt;/</span>li&gt;</span><br><span class="line">&lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 把li的事件处理函数放到ul上</span></span><br><span class="line"><span class="regexp">window.onload = function()&#123;</span></span><br><span class="line"><span class="regexp">    var ul = document.getElementById("ul");</span></span><br><span class="line"><span class="regexp">   ul.onclick = function()&#123;</span></span><br><span class="line"><span class="regexp">       console.log(123)</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h2&gt;&lt;p&gt;事件是异步编程的一种实现，事件机制是对&lt;strong&gt;观察者模式&lt;/strong&gt;（有时被称作发布/订阅模式 ）的进一步抽象。观察者(Obs
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Blob API的使用</title>
    <link href="https://gyunzhi.github.io/2018/07/16/Blob%20API%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://gyunzhi.github.io/2018/07/16/Blob API的使用/</id>
    <published>2018-07-15T20:16:56.000Z</published>
    <updated>2019-05-06T09:26:27.116Z</updated>
    
    <content type="html"><![CDATA[<p>在一般的Web开发中，很少会用到Blob，但Blob可以满足一些场景下的特殊需求。Blob，Binary Large  Object的缩写，代表二进制类型的大对象。Blob的概念在一些数据库中有使用到，例如，MSQL中的BLOB类型就表示二进制数据的容器。在Web中，Blob类型的对象表示不可变的类似文件对象的原始数据，通俗点说，就是Blob对象是二进制数据，但它是类似文件对象的二进制数据，因此可以像操作File对象一样操作Blob对象，实际上，File继承自Blob。</p><h2 id="Blob基本用法"><a href="#Blob基本用法" class="headerlink" title="Blob基本用法"></a>Blob基本用法</h2><h3 id="创建Blob对象"><a href="#创建Blob对象" class="headerlink" title="创建Blob对象"></a>创建Blob对象</h3><p>可以通过Blob的构造函数创建Blob对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blob(blobParts[, options])</span><br></pre></td></tr></table></figure><p>参数说明：</p><p>blobParts：数组类型，数组中的每一项连接起来构成Blob对象的数据，数组中的每项元素可以是<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer" target="_blank" rel="noopener"><code>ArrayBuffer</code></a>, <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ArrayBufferView" target="_blank" rel="noopener"><code>ArrayBufferView</code></a>, <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a>, <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMString" target="_blank" rel="noopener"><code>DOMString</code></a> 。</p><p>options：可选项，字典格式类型，可以指定如下两个属性：</p><ul><li>type，默认值为 <code>&quot;&quot;</code>，它代表了将会被放入到blob中的数组内容的MIME类型。</li><li><p>endings，默认值为”transparent”，用于指定包含行结束符<code>\n</code>的字符串如何被写入。 </p><p> 它是以下两个值中的一个： </p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"native"</span>，表示行结束符会被更改为适合宿主操作系统文件系统的换行符；</span><br></pre></td></tr></table></figure> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"transparent"</span>，表示会保持blob中保存的结束符不变。</span><br></pre></td></tr></table></figure></li></ul><p>例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data1 = <span class="string">"a"</span>;</span><br><span class="line"><span class="keyword">var</span> data2 = <span class="string">"b"</span>;</span><br><span class="line"><span class="keyword">var</span> data3 = <span class="string">"&lt;div style='color:red;'&gt;This is a blob&lt;/div&gt;"</span>;</span><br><span class="line"><span class="keyword">var</span> data4 = &#123; <span class="string">"name"</span>: <span class="string">"abc"</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blob1 = <span class="keyword">new</span> Blob([data1]);</span><br><span class="line"><span class="keyword">var</span> blob2 = <span class="keyword">new</span> Blob([data1, data2]);</span><br><span class="line"><span class="keyword">var</span> blob3 = <span class="keyword">new</span> Blob([data3]);</span><br><span class="line"><span class="keyword">var</span> blob4 = <span class="keyword">new</span> Blob([<span class="built_in">JSON</span>.stringify(data4)]);</span><br><span class="line"><span class="keyword">var</span> blob5 = <span class="keyword">new</span> Blob([data4]);</span><br><span class="line"><span class="keyword">var</span> blob6 = <span class="keyword">new</span> Blob([data3, data4]);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(blob1);  <span class="comment">//输出：Blob &#123;size: 1, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob2);  <span class="comment">//输出：Blob &#123;size: 2, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob3);  <span class="comment">//输出：Blob &#123;size: 44, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob4);  <span class="comment">//输出：Blob &#123;size: 14, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob5);  <span class="comment">//输出：Blob &#123;size: 15, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob6);  <span class="comment">//输出：Blob &#123;size: 59, type: ""&#125;</span></span><br></pre></td></tr></table></figure><p>size代表<code>Blob</code> 对象中所包含数据的字节数。这里要注意，使用字符串和普通对象创建Blob时的不同，blob4使用通过<code>JSON.stringify</code>把data4对象转换成json字符串，blob5则直接使用data4创建，两个对象的size分别为14和15。blob4的size等于14很容易理解，因为JSON.stringify(data4)的结果为：<code>&quot;{&quot;name&quot;:&quot;abc&quot;}&quot;</code>，正好14个字节(不包含最外层的引号)。blob5的size等于15是如何计算而来的呢？实际上，当使用普通对象创建Blob对象时，相当于调用了普通对象的toString()方法得到字符串数据，然后再创建Blob对象。所以，blob5保存的数据是<code>&quot;[object Object]&quot;</code>，是15个字节(不包含最外层的引号)。</p><h3 id="slice方法"><a href="#slice方法" class="headerlink" title="slice方法"></a>slice方法</h3><p>Blob对象有一个slice方法，返回一个新的 <code>Blob</code>对象，包含了源 <code>Blob</code>对象中指定范围内的数据。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slice([start[, end[, contentType]]])</span><br></pre></td></tr></table></figure><p>参数说明：</p><p>start： 可选，代表 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 里的下标，表示第一个会被会被拷贝进新的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的字节的起始位置。如果传入的是一个负数，那么这个偏移量将会从数据的末尾从后到前开始计算。</p><p>end： 可选，代表的是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的一个下标，这个下标-1的对应的字节将会是被拷贝进新的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的最后一个字节。如果你传入了一个负数，那么这个偏移量将会从数据的末尾从后到前开始计算。</p><p>contentType： 可选，给新的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 赋予一个新的文档类型。这将会把它的 type 属性设为被传入的值。它的默认值是一个空的字符串。</p><p>例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> data = <span class="string">"abcdef"</span>;</span><br><span class="line"><span class="keyword">var</span> blob1 = <span class="keyword">new</span> Blob([data]);</span><br><span class="line"><span class="keyword">var</span> blob2 = blob1.slice(<span class="number">0</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(blob1);  <span class="comment">//输出：Blob &#123;size: 6, type: ""&#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(blob2);  <span class="comment">//输出：Blob &#123;size: 3, type: ""&#125;</span></span><br></pre></td></tr></table></figure><p>通过slice方法，从blob1中创建出一个新的blob对象，size等于3。</p><h2 id="Blob使用场景"><a href="#Blob使用场景" class="headerlink" title="Blob使用场景"></a>Blob使用场景</h2><h3 id="分片上传"><a href="#分片上传" class="headerlink" title="分片上传"></a>分片上传</h3><p>前面已经说过，File继承自Blob，因此我们可以调用slice方法对大文件进行分片长传。代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uploadFile</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> chunkSize = <span class="number">1024</span> * <span class="number">1024</span>;   <span class="comment">// 每片1M大小</span></span><br><span class="line">  <span class="keyword">var</span> totalSize = file.size;</span><br><span class="line">  <span class="keyword">var</span> chunkQuantity = <span class="built_in">Math</span>.ceil(totalSize/chunkSize);  <span class="comment">//分片总数</span></span><br><span class="line">  <span class="keyword">var</span> offset = <span class="number">0</span>;  <span class="comment">// 偏移量</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">  reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    xhr.open(<span class="string">"POST"</span>,<span class="string">"http://xxxx/upload?fileName="</span>+file.name);</span><br><span class="line">    xhr.overrideMimeType(<span class="string">"application/octet-stream"</span>);</span><br><span class="line">    </span><br><span class="line">    xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span>(xhr.readyState === XMLHttpRequest.DONE &amp;&amp; xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">        ++offset;</span><br><span class="line">        <span class="keyword">if</span>(offset === chunkQuantity) &#123;</span><br><span class="line">          alert(<span class="string">"上传完成"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(offset === chunkQuantity<span class="number">-1</span>)&#123;</span><br><span class="line">          blob = file.slice(offset*chunkSize, totalSize);   <span class="comment">// 上传最后一片</span></span><br><span class="line">          reader.readAsBinaryString(blob);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          blob = file.slice(offset*chunkSize, (offset+<span class="number">1</span>)*chunkSize);   </span><br><span class="line">          reader.readAsBinaryString(blob);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">"上传出错"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(xhr.sendAsBinary) &#123;</span><br><span class="line">      xhr.sendAsBinary(e.target.result);   <span class="comment">// e.target.result是此次读取的分片二进制数据</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      xhr.send(e.target.result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">var</span> blob = file.slice(<span class="number">0</span>, chunkSize);</span><br><span class="line">   reader.readAsBinaryString(blob);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码还可以进一步丰富，比如显示当前的上传进度，使用多个XMLHttpRequest对象并行上传对象（需要传递分片数据的位置参数给服务器端）等。</p><h3 id="Blob-URL"><a href="#Blob-URL" class="headerlink" title="Blob URL"></a>Blob URL</h3><p>Blob URL是blob协议的URL，它的格式如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blob:http:<span class="comment">//XXX</span></span><br></pre></td></tr></table></figure><p>Blob URL可以通过<code>URL.createObjectURL(blob)</code>创建。在绝大部分场景下，我们可以像使用Http协议的URL一样，使用Blob URL。常见的场景有：作为文件的下载地址和作为图片资源地址。</p><ul><li>文件下载地址</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Blob Test&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script&gt;</span></span><br><span class="line"><span class="regexp">        function createDownloadFile() &#123;</span></span><br><span class="line"><span class="regexp">            var content = "Blob Data";</span></span><br><span class="line"><span class="regexp">            var blob = new Blob([content]);</span></span><br><span class="line"><span class="regexp">            var link = document.getElementsByTagName("a")[0];</span></span><br><span class="line"><span class="regexp">            link.download = "file";</span></span><br><span class="line"><span class="regexp">            link.href = URL.createObjectURL(blob);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        window.onload = createDownloadFile;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>script&gt;</span><br><span class="line">&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">    &lt;a&gt;下载&lt;/</span>a&gt;</span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><p>点击下载按钮，浏览器将会下载一个名为file的文件，文件的内容是：Blob Data。通过Blob对象，我们在前端代码中就可以动态生成文件，提供给浏览器下载。打开Chrome浏览器调试窗口，在Elements标签下可以看到生成的Blob URL为：</p><p><img src="http://img.gongyz.cn/blog/181031/5bE1bG760D.jpg" alt="mark"></p><ul><li>图片资源地址</li></ul><p>为图片文件创建一个Blob URL，赋值给<img>标签：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Blob Test&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script&gt;</span></span><br><span class="line"><span class="regexp">        function handleFile(e) &#123;</span></span><br><span class="line"><span class="regexp">            var file = e.files[0];</span></span><br><span class="line"><span class="regexp">            var blob = URL.createObjectURL(file);</span></span><br><span class="line"><span class="regexp">            var img = document.getElementsByTagName("img")[0];</span></span><br><span class="line"><span class="regexp">            img.src = blob;</span></span><br><span class="line"><span class="regexp">            img.onload = function(e) &#123;</span></span><br><span class="line"><span class="regexp">                URL.revokeObjectURL(this.src);  /</span><span class="regexp">/ 释放createObjectURL创建的对象##</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>script&gt;</span><br><span class="line">&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">    &lt;input type="file" accept="image/</span>*<span class="string">" onchange="</span>handleFile(<span class="keyword">this</span>)<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">    &lt;br/&gt;</span></span><br><span class="line"><span class="string">    &lt;img style="</span>width:<span class="number">200</span>px;height:<span class="number">200</span>px<span class="string">"&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p>input中选择的图片会在<img>里显示出来，如图所示：</p><p><img src="http://img.gongyz.cn/blog/181031/Cm2EDdd201.jpg" alt="mark"></p><p>同时，可以在Network标签栏，发现这个Blob URL的请求信息：</p><p><img src="http://img.gongyz.cn/blog/181031/eE7LldFHA9.jpg" alt="mark"></p><p>这个请求信息和平时我们使用的Http URL获取图片几乎完全一样。我们还可以使用Data URL加载图片资源：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Blob Test&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">    &lt;script&gt;</span></span><br><span class="line"><span class="regexp">        function handleFile(e) &#123;</span></span><br><span class="line"><span class="regexp">            var file = e.files[0];</span></span><br><span class="line"><span class="regexp">            var fileReader = new FileReader();</span></span><br><span class="line"><span class="regexp">            var img = document.getElementsByTagName("img")[0];</span></span><br><span class="line"><span class="regexp">            fileReader.onload = function(e) &#123;</span></span><br><span class="line"><span class="regexp">                img.src = e.target.result;</span></span><br><span class="line"><span class="regexp">            &#125;</span></span><br><span class="line"><span class="regexp">            fileReader.readAsDataURL(file);</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>script&gt;</span><br><span class="line">&lt;<span class="regexp">/head&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">&lt;body&gt;</span></span><br><span class="line"><span class="regexp">    &lt;input type="file" accept="image/</span>*<span class="string">" onchange="</span>handleFile(<span class="keyword">this</span>)<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">    &lt;br/&gt;</span></span><br><span class="line"><span class="string">    &lt;img style="</span>width:<span class="number">200</span>px;height:<span class="number">200</span>px<span class="string">"&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p>FileReader的<code>readAsDataURL</code>生成一个Data URL，如图所示：</p><p><img src="http://img.gongyz.cn/blog/181031/B819BkEh5E.jpg" alt="mark"></p><p>Data URL对大家来说应该并不陌生，Web性能优化中有一项措施：把小图片用base64编码直接嵌入到HTML文件中，实际上就是利用了Data URL来获取嵌入的图片数据。</p><p>那么Blob URL和Data URL有什么区别呢？</p><ol><li>Blob URL的长度一般比较短，但Data URL因为直接存储图片base64编码后的数据，往往很长，如上图所示，浏览器在显示Data URL时使用了省略号（…）。当显式大图片时，使用Blob URL能获取更好的可能性。</li><li>Blob URL可以方便的使用XMLHttpRequest获取源数据，例如：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> blobUrl = URL.createObjectURL(<span class="keyword">new</span> Blob([<span class="string">'Test'</span>], &#123;<span class="attr">type</span>: <span class="string">'text/plain'</span>&#125;));</span><br><span class="line"><span class="keyword">var</span> x = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"><span class="comment">// 如果设置x.responseType = 'blob'，将返回一个Blob对象，而不是文本:</span></span><br><span class="line"><span class="comment">// x.responseType = 'blob';</span></span><br><span class="line">x.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(x.responseText);   <span class="comment">// 输出 Test</span></span><br><span class="line">&#125;;</span><br><span class="line">x.open(<span class="string">'get'</span>, blobUrl);</span><br><span class="line">x.send();</span><br></pre></td></tr></table></figure><p>对于Data URL，并不是所有浏览器都支持通过XMLHttpRequest获取源数据的。</p><p>3.<strong>Blob URL 只能在当前应用内部使用</strong>，把Blob URL复制到浏览器的地址栏中，是无法获取数据的。Data URL相比之下，就有很好的移植性，你可以在任意浏览器中使用。</p><p>除了可以用作图片资源的网络地址，Blob URL也可以用作其他资源的网络地址，例如html文件、json文件等，为了保证浏览器能正确的解析Blob URL返回的文件类型，需要在创建Blob对象时指定相应的type：   </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建HTML文件的Blob URL</span></span><br><span class="line"><span class="keyword">var</span> data = <span class="string">"&lt;div style='color:red;'&gt;This is a blob&lt;/div&gt;"</span>;</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([data], &#123; <span class="attr">type</span>: <span class="string">'text/html'</span> &#125;);</span><br><span class="line"><span class="keyword">var</span> blobURL = URL.createObjectURL(blob);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建JSON文件的Blob URL</span></span><br><span class="line"><span class="keyword">var</span> data = &#123; <span class="string">"name"</span>: <span class="string">"abc"</span> &#125;;</span><br><span class="line"><span class="keyword">var</span> blob = <span class="keyword">new</span> Blob([<span class="built_in">JSON</span>.stringify(data)], &#123; <span class="attr">type</span>: <span class="string">'application/json'</span> &#125;);</span><br><span class="line"><span class="keyword">var</span> blobURL = URL.createObjectURL(blob);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在一般的Web开发中，很少会用到Blob，但Blob可以满足一些场景下的特殊需求。Blob，Binary Large  Object的缩写，代表二进制类型的大对象。Blob的概念在一些数据库中有使用到，例如，MSQL中的BLOB类型就表示二进制数据的容器。在Web中，Blo
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>从HTML5拖放事件探究文件上传功能</title>
    <link href="https://gyunzhi.github.io/2018/07/15/%E4%BB%8EHTML5%E6%8B%96%E6%94%BE%E4%BA%8B%E4%BB%B6%E6%8E%A2%E7%A9%B6%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/"/>
    <id>https://gyunzhi.github.io/2018/07/15/从HTML5拖放事件探究文件上传功能/</id>
    <published>2018-07-14T22:16:56.000Z</published>
    <updated>2019-05-06T09:26:27.146Z</updated>
    
    <content type="html"><![CDATA[<h3 id="拖放事件"><a href="#拖放事件" class="headerlink" title="拖放事件"></a>拖放事件</h3><p>HTML5为所有的HTML元素新增了一个<code>draggable</code>属性，表示元素是否允许拖动。默认情况下，图像、链接和文本是可以拖动的，文本只有在被选中的情况下才能拖动。 <strong>需要注意的是在ff下只加<code>draggable=&quot;true&quot;</code>还不能实现拖放，需要做一些处理，大多数浏览器会为正被拖动的元素创建一个半透明的副本，这个副本始终跟着光标移</strong>动。</p><p>元素拖放时会触发一系列的拖放事件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">（1）拖放元素事件：事件对象为被拖放的元素</span><br><span class="line"></span><br><span class="line">    ondragstart  拖放开始触发</span><br><span class="line">    ondragend    拖放结束触发</span><br><span class="line">  ondrag       拖放期间触发，连续触发(无论拖放元素放在有效目标还是无效目标，都会触发)</span><br><span class="line"></span><br><span class="line">（2）目标元素事件：事件对象为目标元素</span><br><span class="line"></span><br><span class="line">     ondragenter  拖放元素进入目标元素触发</span><br><span class="line">     ondragleave  拖放元素离开目标元素触发</span><br><span class="line">     ondragover   拖放元素进入目标元素和离开目标元素之间触发，连续触发</span><br><span class="line">     ondrop       在目标元素上释放鼠标时触发，要想触发drop事件就必须在dragover当中阻止默认事件</span><br><span class="line"></span><br><span class="line">（3）事件执行顺序：</span><br><span class="line"></span><br><span class="line">  drop不触发的时候</span><br><span class="line">  dragstart &gt; drag &gt; dragenter &gt; dragover &gt; dragleave &gt; dragend</span><br><span class="line"></span><br><span class="line">drop触发的时候 在dragover中阻止默认事件</span><br><span class="line">dragstart &gt; drag &gt; dragenter &gt; dragover &gt; drop &gt; dragend</span><br></pre></td></tr></table></figure><p>示例代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>拖放事件<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">ul li &#123;</span></span><br><span class="line"><span class="undefined">width: 100px;</span></span><br><span class="line"><span class="undefined">height: 40px;</span></span><br><span class="line"><span class="undefined">background: #ff0;</span></span><br><span class="line"><span class="undefined">margin-bottom: 8px;</span></span><br><span class="line"><span class="undefined">list-style: none;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">div &#123;</span></span><br><span class="line"><span class="undefined">width: 200px;</span></span><br><span class="line"><span class="undefined">height: 200px;</span></span><br><span class="line"><span class="undefined">background: #f00;</span></span><br><span class="line"><span class="undefined">margin: 100px 0 0 100px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl = <span class="built_in">document</span>.getElementById(<span class="string">'ul1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv = <span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oLi = oUl.getElementsByTagName(<span class="string">'li'</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> i = <span class="number">0</span>;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 拖放元素事件</span></span></span><br><span class="line"><span class="javascript">oLi.ondragstart = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background = <span class="string">'blue'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oLi.ondragend = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background = <span class="string">'yellow'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oLi.ondrag=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="comment">//连续触发</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.title=i++;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 目标元素事件,通过重写dragenter和dragleave方法来自定义目标元素背景颜色</span></span></span><br><span class="line"><span class="javascript">oDiv.ondragenter=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background=<span class="string">'green'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondragleave=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background=<span class="string">'red'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 要想触发drop事件就必须在dragover当中阻止默认事件</span></span></span><br><span class="line"><span class="javascript">oDiv.ondragover = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(i);</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 在目标元素上释放鼠标时触发</span></span></span><br><span class="line"><span class="javascript">oDiv.ondrop = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background = <span class="string">'#000'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"ul1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>拖放元素<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span>目标元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="解决ff下不能拖放的问题"><a href="#解决ff下不能拖放的问题" class="headerlink" title="解决ff下不能拖放的问题"></a>解决ff下不能拖放的问题</h3><p>要解决ff下不能拖放的问题，必须在<code>ondragstart</code>事件中设置<code>dataTransfer</code>对象的<code>setData</code>方法，<code>dataTransfer</code>对象是event对象下的一个属性，需要通过event对象访问 ，下文会详细说明<code>dataTransfer</code>对象。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>ff下不能拖放的问题<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">ul li&#123;width: 100px;height: 40px;background: #ff0;margin-bottom:8px;list-style: none; &#125;</span></span><br><span class="line"><span class="undefined">div&#123;width: 100px;height: 100px;background: #f00;margin:300px 0 0 300px;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl=<span class="built_in">document</span>.getElementById(<span class="string">'ul1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv=<span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> aLi=oUl.getElementsByTagName(<span class="string">'li'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 拖放元素事件</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aLi.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">aLi[i].ondragstart=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">ev.dataTransfer.setData(<span class="string">'name'</span>,<span class="string">'gongyz'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 目标元素事件</span></span></span><br><span class="line"><span class="javascript">oDiv.ondragover=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 要想触发ondrop事件，必须在onondragover中阻止默认事件</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondrop=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(ev.dataTransfer.getData(<span class="string">'name'</span>))</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"ul1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>a<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>b<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>c<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="DataTransfer-对象"><a href="#DataTransfer-对象" class="headerlink" title="DataTransfer 对象"></a>DataTransfer 对象</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p><code>DataTransfer</code> 对象用来保存，通过拖放动作，拖动到浏览器的数据。它可以保存一项或多项数据、一种或者多种数据类型。</p><p>这个对象在所有的拖放事件属性<code>dataTransfer</code>中都是可用的，但是不能单独创建，也就是说，在进行拖放操作的时候，会自动创建一个<code>dataTransfer</code>对象，这个对象作为拖放事件的事件对象的一个属性，保存了当前拖放操作的数据。</p><p><strong>方法</strong></p><p><code>setData(key,value)</code> ：设置拖放时要传递的数据（拖放元素）</p><p><code>getData(key)</code>：获取拖放时传递的数据（目标元素）</p><p><code>setDragImage(DOMElement image,x,y)</code> ：使用自定义的图片作为拖放时副本 (该方法接收三个参数  指定的元素，坐标X，坐标Y)</p><p><strong>属性</strong></p><p><code>files</code>：用来获取外部拖放进来的文件，返回一个类数组的<code>FileList</code>对象 </p><h4 id="拖放删除元素"><a href="#拖放删除元素" class="headerlink" title="拖放删除元素"></a>拖放删除元素</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>拖放删除元素<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">ul li&#123;width: 100px;height: 30px;margin:8px;background: #ff0;&#125;</span></span><br><span class="line"><span class="undefined">div&#123;width: 200px;height: 200px;margin:100px 0 0 100px;background: #f00;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl=<span class="built_in">document</span>.getElementsByTagName(<span class="string">'ul'</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv=<span class="built_in">document</span>.getElementsByTagName(<span class="string">'div'</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> aLi=oUl.getElementsByTagName(<span class="string">'li'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aLi.length; i++) &#123;</span></span><br><span class="line"><span class="undefined">aLi[i].index=i;</span></span><br><span class="line"><span class="javascript">aLi[i].ondragstart=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">ev.dataTransfer.setData(<span class="string">'data'</span>,<span class="keyword">this</span>.index);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondragover=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//要想触发ondrop事件，必须在onondragover中阻止默认事件</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondrop=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// 拿到索引值后删除对应的元素</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> _index=ev.dataTransfer.getData(<span class="string">'data'</span>);</span></span><br><span class="line"><span class="undefined">oUl.removeChild(aLi[_index]);</span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aLi.length; i++) &#123;</span></span><br><span class="line"><span class="undefined">aLi[i].index = i;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>a<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>b<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>c<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>d<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="自定义拖放副本"><a href="#自定义拖放副本" class="headerlink" title="自定义拖放副本"></a>自定义拖放副本</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>dataTransfer对象详解<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">ul li&#123;width: 100px;height: 40px;background: #ff0;margin-bottom:8px;list-style: none; &#125;</span></span><br><span class="line"><span class="undefined">div&#123;width: 100px;height: 100px;background: #f00;margin:300px 0 0 300px;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">setDragImage方法  使用自定义的图片作为拖放时副本</span></span><br><span class="line"><span class="undefined">该方法接收三个参数  指定的元素，坐标X，坐标Y</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl=<span class="built_in">document</span>.getElementById(<span class="string">'ul1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv=<span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> aLi=oUl.getElementsByTagName(<span class="string">'li'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oImg=<span class="built_in">document</span>.getElementsByTagName(<span class="string">'img'</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// 拖放元素事件</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; aLi.length; i++) &#123;</span></span><br><span class="line"><span class="undefined">aLi[i].index=i;</span></span><br><span class="line"><span class="javascript">aLi[i].ondragstart=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> ev=ev||event;</span></span><br><span class="line"><span class="javascript"><span class="keyword">this</span>.style.background=<span class="string">'blue'</span>;</span></span><br><span class="line"><span class="javascript">ev.dataTransfer.setData(<span class="string">'name'</span>,<span class="string">'leo'</span>);</span></span><br><span class="line"><span class="undefined">ev.dataTransfer.setDragImage(oImg,0,0)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">//目标元素</span></span></span><br><span class="line"><span class="javascript">oDiv.ondragover=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// 要想触发drop事件就必须在dragover当中阻止默认事件</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondrop=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="number">123</span>)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"ul1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>a<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>b<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">draggable</span>=<span class="string">"true"</span>&gt;</span>c<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"xxx.png"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="File和FileReader对象"><a href="#File和FileReader对象" class="headerlink" title="File和FileReader对象"></a>File和FileReader对象</h3><p>File是一个是特殊类型的Blob对象，保存了和文件有关的信息。File 对象可以是来自用户在一个<code>&lt;input&gt;</code>元素上选择文件后返回的<code>FileList</code>对象,也可以是来自由拖放操作生成的<code>DataTransfer</code>对象中的<code>files</code>属性，这个属性就是一个类数组的<code>FileList</code>对象。</p><p>FileReader 用来读取通过<code>dataTransfer</code>对象的<code>files</code>属性获取的外部文件 ，将文件读取为Data URL格式,读取的结果保存在result属性中，如果是图片，返回base64格式的图片数据 。</p><p>结合之前的拖放操作和DataTransfer对象，我们就可以实现<strong>拖放上传文件功能</strong>，下面的代码示例介绍了FileReader接口的使用方法：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>图片预览功能<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">div&#123;width: 300px;height: 300px;background: #f00;margin:100px 0 0 200px;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">fileReader对象  用来读取通过dataTransfer对象的files属性获取的文件</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> fd = <span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">readAsDataURL()方法   参数为要读取的文件对象，将文件读取为DataURL格式</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">onload事件  当读取文件完成的时候触发此事件</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">fd.result            取读取的文件数据，如果是图片，返回base64格式的图片数据</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv=<span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl=<span class="built_in">document</span>.getElementsByTagName(<span class="string">'ul'</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">//目标元素</span></span></span><br><span class="line"><span class="javascript">oDiv.ondragover=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">// 要想触发drop事件就必须在dragover当中阻止默认事件</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oDiv.ondrop=<span class="function"><span class="keyword">function</span> (<span class="params">ev</span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> ev=ev||event;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> fs=ev.dataTransfer.files;</span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; fs.length; i++) &#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> (fs[i].type.indexOf(<span class="string">'image'</span>) !== <span class="number">-1</span>) &#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> fd=<span class="keyword">new</span> FileReader();</span></span><br><span class="line"><span class="undefined">fd.readAsDataURL(fs[i]);</span></span><br><span class="line"><span class="javascript">fd.onload=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oLi=<span class="built_in">document</span>.createElement(<span class="string">'li'</span>);</span></span><br><span class="line"><span class="javascript">oLi.innerHTML=<span class="string">'&lt;img src="'</span>+<span class="keyword">this</span>.result+<span class="string">'"&gt;'</span>;</span></span><br><span class="line"><span class="undefined">oUl.appendChild(oLi);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript">&#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">alert(<span class="string">'请上传图片类型！！！'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span>请把文件拖放在此处<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;拖放事件&quot;&gt;&lt;a href=&quot;#拖放事件&quot; class=&quot;headerlink&quot; title=&quot;拖放事件&quot;&gt;&lt;/a&gt;拖放事件&lt;/h3&gt;&lt;p&gt;HTML5为所有的HTML元素新增了一个&lt;code&gt;draggable&lt;/code&gt;属性，表示元素是否允许拖动。默认情况下，
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>面向对象程序设计</title>
    <link href="https://gyunzhi.github.io/2018/07/08/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    <id>https://gyunzhi.github.io/2018/07/08/面向对象程序设计/</id>
    <published>2018-07-07T21:16:56.000Z</published>
    <updated>2019-05-06T09:26:27.155Z</updated>
    
    <content type="html"><![CDATA[<h3 id="理解对象"><a href="#理解对象" class="headerlink" title="理解对象"></a>理解对象</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>在学习面向对象开发之前，我觉的有必要先来了解对象这个东西是什么，ECMA-262把对象定义为：“无序属性的集合，其属性可以包含基本值、对象或者函数”。对象都是基于一个引用类型创建的，这个引用类型可以是原生类型，也可以是开发人员自定义的类型。</p><p>原生的引用类型有：Object、Array、Date、RegExp、Function，基本包装类型Boolean、Number、String以及两个单体内置对象Global（在浏览器环境window对象就是Global）、Math。</p><p>说明：Object、Array、…、String、Global、Math都是内置对象，ECMA-262对内置对象的定义是：“由ECMAScript提供的，不依赖于宿主环境的对象，这些对象在ECMAScript执行之前就已经存在了”，也就是说开发人员不需要显式的实例化内置对象，因为它们已经实例化了。那么单体内置对象又是什么意思呢。其实也很好理解，看一下下面的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在chromo控制台操作</span></span><br><span class="line"><span class="built_in">Object</span></span><br><span class="line">ƒ <span class="built_in">Object</span>() &#123; [native code] &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span></span><br><span class="line">ƒ <span class="built_in">Array</span>() &#123; [native code] &#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Math</span></span><br><span class="line"><span class="built_in">Math</span> &#123;<span class="attr">abs</span>: ƒ, <span class="attr">acos</span>: ƒ, <span class="attr">acosh</span>: ƒ, <span class="attr">asin</span>: ƒ, <span class="attr">asinh</span>: ƒ, …&#125;</span><br></pre></td></tr></table></figure><p>我们可以看到Object、Array是函数，而Math是对象，所以可以直接使用Math的API，而其他的内置对象一般是作为构造函数，通过new关键字用来来创建一个对象的。</p><p>创建自定义对象最简单的方式就是创建一个Object实例，Object是所有对象的基础，也就是说Object类型所具有的属性和方法同样也存在于具体的对象中。（<em>在后面的讲解原型链会做出具体说明</em>）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> <span class="built_in">Object</span>()</span><br><span class="line">person.name=<span class="string">'leo'</span></span><br><span class="line">person.sayName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'名字:'</span>+<span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line">person.sayName() <span class="comment">// leo</span></span><br></pre></td></tr></table></figure><p>上面的例子中，我们创建了一个person对象，并且给它添加了name属性和sayName方法，但现在有更简洁的写法，通过对象字面量形式来创建对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">'leo'</span>,</span><br><span class="line">  showName: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">person.showName();</span><br></pre></td></tr></table></figure><h4 id="对象的属性类型"><a href="#对象的属性类型" class="headerlink" title="对象的属性类型"></a>对象的属性类型</h4><p>ECMAScript-262 的定义中，对象的属性有两种，一种是数据属性，另一种是访问器属性 ，这两种属性都有一些特性值来描述该属性。这些特性是为了实现JavaScript引擎用的，因此在JavaScript中不能直接访问它们。而且为了表示这些特性是内部值，该规范把它们放在了两对方括号中，例如[[Enumerable]]。</p><h5 id="数据属性"><a href="#数据属性" class="headerlink" title="数据属性"></a>数据属性</h5><p>数据属性共有4个描述其行为的特性，其中包含一个存放数据值得特性。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[[Configurable]]： 表示能否通过delete删除属性，能否修改属性的特性，或者能否把属性修改为访问器属性。默认为true。</span><br><span class="line"></span><br><span class="line">[[Enumerable]]： 表示能否通过for-in遍历属性。默认为true。</span><br><span class="line"></span><br><span class="line">[[Writable]]： 表示能否修改属性的值。默认为true。</span><br><span class="line"></span><br><span class="line">[[Value]]： 用于存放属性的数据值，默认为undefined。</span><br></pre></td></tr></table></figure><p><strong>要修改属性默认的特性，必须使用 ESMAScript 5 的<code>Object.defineProperty()</code>方法。这个方法接收三个参数：属性所在的对象、属性的名字和一个描述符对象。其中，描述符对象的属性必须是：configurable、enumerable、writable和value。设置其中一个或多个值，可以修改对应的特性值。</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> person = &#123;</span><br><span class="line">  name: <span class="string">'gongyz'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(person, <span class="string">"name"</span>, &#123;</span><br><span class="line">  writable: <span class="literal">false</span>,</span><br><span class="line">  value: <span class="string">'zhangsan'</span></span><br><span class="line">&#125;)</span><br><span class="line">person.name = <span class="string">'123'</span></span><br><span class="line"><span class="built_in">console</span>.log(person) <span class="comment">// 'zhangsan'</span></span><br></pre></td></tr></table></figure><p>上面的代码创建了一个name属性，当我们调用<code>Object.defineProperty()</code>writable特性设为false后，如果为它指定新值，非严格模式下操作会被忽略，严格模式下，赋值操作将会抛出错误。</p><h5 id="访问器属性"><a href="#访问器属性" class="headerlink" title="访问器属性"></a>访问器属性</h5><p>访问器属性不包括数据值，但它包含一对getter和setter函数（不过这两个函数都不是必须的）。在读取访问器属性时，会调用getter函数，这个函数负责返回有效的值；在写入访问器属性时，会调用setter函数并传入新值，这个函数负责处理数据。访问器属性有如下4个特性。</p><pre><code>[[Configurable]]：同上。[[Enumerable]]：同上。[[Get]]：在读取属性时调用的函数。默认为undefined。[[Set]]：在写入属性时调用的函数。默认为undefined。</code></pre><p><strong>注意：访问器属性不能被直接定义，必须使用<code>Object.defineProperty()</code>方法</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问器属性</span></span><br><span class="line"><span class="keyword">var</span> book = &#123;</span><br><span class="line">  _year: <span class="number">2004</span>, <span class="comment">// _year前面的下划线是一种常用的记号，用于表示只能通过对象方法访问的属性</span></span><br><span class="line">  version: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(book, <span class="string">'year'</span>, &#123;</span><br><span class="line">  <span class="keyword">get</span>: function () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._year</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">set</span>: function (newVal) &#123;</span><br><span class="line">    <span class="keyword">if</span> (newVal &gt; <span class="number">2004</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._year = newVal</span><br><span class="line">      <span class="keyword">this</span>.version += newVal - <span class="number">2004</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">book.year = <span class="number">2008</span></span><br><span class="line"><span class="built_in">console</span>.log(book)</span><br></pre></td></tr></table></figure><p>上面的代码创建了一个book对象，并给它定义了两个默认属性；<code>_year</code>和<code>version</code>。<code>_year</code>前面的下划线是一种常用的记号，用于表示只能通过对象方法访问的属性。而访问器属性year包含一个getter和setter函数。getter函数返回<code>_year</code>的值，setter函数通过计算来确定正确的版本。因此把year属性修改为2008会导致<code>_year</code>变成2008，而<code>version</code>变成5。这是访问器属性的常见方式，即设置一个属性的值会导致其他属性发生变化。</p><p>注意：在IE8及之前的IE浏览器不支持<code>Object.defineProperty()</code>方法，要创建访问器属性，一般使用两个非标准的方法<code>__defineGetter__</code> 和<code>__defineSetter__</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 定义访问器属性的旧方法</span><br><span class="line">book.__defineGetter__(&apos;year&apos;, function () &#123;</span><br><span class="line">  return this._year</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">book.__defineSetter__(&apos;year&apos;, function (newVal) &#123;</span><br><span class="line">  if (newVal &gt; 2004) &#123;</span><br><span class="line">    this._year = newVal</span><br><span class="line">    this.version += newVal - 2004</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h5 id="定义多个属性"><a href="#定义多个属性" class="headerlink" title="定义多个属性"></a>定义多个属性</h5><p>ESMAScript 5 定义了一个Object.defineProperties()方法。利用这个方法可以通过描述符一次性定义多个属性。这个方法接收两个对象参数：第一个是要添加和修改其属性的对象，第二个对象的属性与第一个对象要添加或修改的属性一 一对应。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> book = &#123;&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperties(book, &#123;</span><br><span class="line">  _year: &#123;</span><br><span class="line">    value: <span class="number">2004</span></span><br><span class="line">  &#125;,</span><br><span class="line">  version: &#123;</span><br><span class="line">    value: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  year: &#123;</span><br><span class="line">    <span class="keyword">get</span>: function () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._year</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>: function (newVal) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal &gt; <span class="number">2004</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>._year = newVal</span><br><span class="line">        <span class="keyword">this</span>.version += newVal - <span class="number">2004</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">book.year = <span class="number">2008</span></span><br><span class="line"><span class="built_in">console</span>.log(book)</span><br><span class="line"><span class="built_in">console</span>.log(book.year)</span><br></pre></td></tr></table></figure><h5 id="读取属性的特性"><a href="#读取属性的特性" class="headerlink" title="读取属性的特性"></a>读取属性的特性</h5><p>ESMAScript 5 的<code>Object.getOwnPropertyDescriptor()</code> 方法，可以获取给定属性的特性。同样的IE9+的浏览器支持此方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(book, <span class="string">'year'</span>)</span><br></pre></td></tr></table></figure><h3 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h3><h4 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h4><p>虽然Object构造函数或对象字面量都可以用来创建单个对象，但这些方式有个明显的缺点：使用同一个接口创建多个对象，会产生大量重复代码。为了解决这个问题，同时考虑到在ECMAScript中无法创建类，开发人员就用封装函数来创建对象。这种通过用函数封装以特定接口创建对象的细节，并通过调用函数来创建对象的方式，称为<em>工厂模式</em>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPerson</span>(<span class="params">name, sex</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//原料</span></span><br><span class="line">  <span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//加工</span></span><br><span class="line">  obj.name = name;</span><br><span class="line">  obj.sex = sex;</span><br><span class="line"></span><br><span class="line">  obj.showName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'名字:'</span> + <span class="keyword">this</span>.name);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  obj.showSex = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'性别:'</span> + <span class="keyword">this</span>.sex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//出厂</span></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = createPerson(<span class="string">'leo'</span>, <span class="string">'male'</span>);</span><br><span class="line"><span class="keyword">var</span> p2 = createPerson(<span class="string">'gongyz'</span>, <span class="string">'male'</span>);</span><br><span class="line"></span><br><span class="line">p1.showName(); <span class="comment">// leo</span></span><br><span class="line">p2.showName(); <span class="comment">// gongyz</span></span><br><span class="line"><span class="built_in">console</span>.log(p1 <span class="keyword">instanceof</span> <span class="built_in">Object</span>); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(p2 <span class="keyword">instanceof</span> <span class="built_in">Object</span>); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(p1.showName === p2.showName) <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p>函数createPerson()能够根据接收的参数来创建一个包含基本信息的person对象。可以多次调用这个函数，而每次它都会返回一个包含两个属性和两个方法的对象。<strong>工厂模式虽然解决了创建多个相似对象的问题，但是却没有解决对象识别问题（没有办法通过 instance 判断创建出来的对象是什么类型，因为它总是Object）</strong>，随着JavaScript的发展，有一个新的模式出现了。</p><h4 id="构造函数模式"><a href="#构造函数模式" class="headerlink" title="构造函数模式"></a>构造函数模式</h4><p>我们知道，像Object、Array这样的原生构造函数，在运行时会自动出现在执行环境中。此外，也可以创建自定义的构造函数，从而创建自定义对象类型的属性和方法。例如，我们可以使用构造函数模式将前面的例子重写如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, sex</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 假想的系统内部的工作流程</span></span><br><span class="line">  <span class="comment">// var this=new Object();</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  <span class="keyword">this</span>.sex = sex;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.showName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'名字:'</span> + <span class="keyword">this</span>.name);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.showSex = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'性别:'</span> + <span class="keyword">this</span>.sex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 假想的系统内部的工作流程</span></span><br><span class="line">  <span class="comment">// return this;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Person(<span class="string">'leo'</span>, <span class="string">'male'</span>);</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> Person(<span class="string">'lili'</span>, <span class="string">'female'</span>);</span><br><span class="line"></span><br><span class="line">p1.showName(); <span class="comment">// leo</span></span><br><span class="line">p2.showName(); <span class="comment">// lili</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(p1 <span class="keyword">instanceof</span> Person); <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(p2 <span class="keyword">instanceof</span> Person); <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(p1 <span class="keyword">instanceof</span> <span class="built_in">Object</span>);  <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(p2 <span class="keyword">instanceof</span> <span class="built_in">Object</span>);  <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>在上面的代码中，Person()函数取代了createPerson()函数，同时Person()中的代码与createPerson()还存在一下不同之处：</p><ul><li>没有显示的创建对象</li><li>直接将属性和方法赋给了this对象</li><li>没有return语句</li><li>首字母大写（按照惯例，构造函数首字母应该大写）</li><li>使用new关键字调用构造函数来创建对象</li></ul><p>其实，要创建Person的新实例，必须使用new操作符。使用new关键字调用构造函数时实际上会经历下面4个步骤：</p><ul><li>创建一个新的对象</li><li>this指向这个新的对象</li><li>执行构造函数中的代码，为对象添加属性和方法</li><li>返回新对象</li></ul><p>使用构造函数创建对象可以将它的实例标识为一种特定的类型，这样就解决了工厂模式中对象识别问题。上面代码中创建的对象p1、p2都是Person的实例，但同时也都是Object的实例，这是因为所有的对象都继承自Object（这个在后面的继承中会说明）。</p><p><strong>1、将构造函数当做函数</strong></p><p>构造函数与普通函数的唯一区别就在于调用它们的方式不同。任何函数，只要通过 new 操作符来调用，那它就可以作为构造函数；如果不通过 new 操作符调用，那它就和普通的函数调用没什么区别。例如前面定义的Person函数可以通过下列的任何一种方式调用：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当做构造函数使用</span></span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person(<span class="string">'gongyz'</span>, <span class="string">'male'</span>)</span><br><span class="line">person.showName() <span class="comment">// gongyz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当做普通函数使用</span></span><br><span class="line"><span class="keyword">var</span> person = Person(<span class="string">'gongyz'</span>, <span class="string">'male'</span>)</span><br><span class="line"><span class="built_in">window</span>.showName() <span class="comment">// gongyz // 添加到window</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在另一个对象作用域中调用</span></span><br><span class="line"><span class="keyword">var</span> obj = <span class="keyword">new</span> <span class="built_in">Object</span>()</span><br><span class="line">Person.call(obj,<span class="string">'gongyz'</span>, <span class="string">'male'</span>)</span><br><span class="line">obj.showName() <span class="comment">// gongyz</span></span><br></pre></td></tr></table></figure><p><strong>2、构造函数的问题</strong></p><p>构造函数模式使用了new关键字，解决了对象识别问题，但是没有解决方法复用问题，每次创建一个实例的时候，方法就会在那个实例上重新创建一遍，好在，这个问题可以通过原型模式解决。</p><h4 id="原型模式"><a href="#原型模式" class="headerlink" title="原型模式"></a>原型模式</h4><p>几乎所有的函数（除了一些内建函数）都有一个prototype（原型）属性，这个属性是一个指针，指向一个对象，而这个对象的用途是用来存放所有实例共享的属性和方法。我们把这个对象称为<strong>原型对象</strong>。我们可以给内置对象的prototype添加属性和方法，但是不推荐这样做，这样可能会覆盖掉内置对象的属性或方法。拿上面的例子来说，我们可以把方法和属性都放到原型对象中。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.name = <span class="string">'gongyz'</span>;</span><br><span class="line">Person.prototype.sex = <span class="string">'male'</span>;</span><br><span class="line"></span><br><span class="line">Person.prototype.showName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'名字:'</span> + <span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person.prototype.showSex = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'性别:'</span> + <span class="keyword">this</span>.sex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Person();</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> Person();</span><br><span class="line"></span><br><span class="line">p1.showName(); <span class="comment">// gonygz</span></span><br><span class="line"></span><br><span class="line">p2.showName(); <span class="comment">// gongyz</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(p1.showName == p2.showName) <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h4 id="组合使用构造函数和原型模式"><a href="#组合使用构造函数和原型模式" class="headerlink" title="组合使用构造函数和原型模式"></a>组合使用构造函数和原型模式</h4><p>通常情况下，公用的属性和方法才会放在prototype上，所以我们一般使用构造模式 + 原型模式的混合方式来创建对象 ，这样每一个实例既可以有自己的属性和方法，同时也有了共有的属性和方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, sex</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.name = name;</span><br><span class="line">  <span class="keyword">this</span>.sex = sex;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person.prototype.showName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'名字:'</span> + <span class="keyword">this</span>.name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person.prototype.showSex = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'性别:'</span> + <span class="keyword">this</span>.sex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> Person(<span class="string">'leo'</span>, <span class="string">'male'</span>);</span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> Person(<span class="string">'lili'</span>, <span class="string">'female'</span>);</span><br><span class="line"></span><br><span class="line">p1.showName();</span><br><span class="line">p1.showSex();</span><br><span class="line"></span><br><span class="line">p2.showName();</span><br><span class="line">p2.showSex();</span><br></pre></td></tr></table></figure><h4 id="this指向问题"><a href="#this指向问题" class="headerlink" title="this指向问题"></a>this指向问题</h4><p>在JavaScript，this的指向是很多该开始接触这门语言的人比较头疼的问题，大部分情况下，函数的调用方式决定了this的值，但也有一些例外的情况，同时在严格模式和非严格模式下this的值也会有一些差别。</p><p>通常情况下：</p><ol><li>函数通过 new 调用，this 绑定的是新创建的对象</li><li>函数在某个上下文对象中调用，this 绑定的是那个上下文对象</li><li>函数通过call、apply、bind调用，this 绑定的是指定的上下文对象</li><li>全局环境下调用，默认绑定的是window对象。如果在严格模式下，绑定到undefined。</li></ol><p>this指向出问题的情况：</p><ol><li>构造函数里面有定时器</li><li>构造函数里面有事件</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造函数里面有定时器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">this</span>.n = <span class="number">12</span></span><br><span class="line"><span class="keyword">var</span> _this = <span class="keyword">this</span></span><br><span class="line">setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">_this.show()</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">// window</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.show = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.n)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造函数里面有事件</span></span><br><span class="line"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'input'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">this</span>.n = <span class="number">12</span></span><br><span class="line"><span class="keyword">var</span> _this = <span class="keyword">this</span></span><br><span class="line">oBtn.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">_this.show()</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>) <span class="comment">// input</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.show = <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.n)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person()</span><br></pre></td></tr></table></figure><p>上面两种情况下，this指向的分别是window和input对象，解决这个问题很简单，另外保存一份当前对象的this引用就可以了。</p><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>继承是复用代码的一种形式，子类通过继承父类的属性和方法达到代码复用的目的。</p><h4 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h4><p>在每个<strong>对象</strong>上面都有一个<code>__proto__</code>属性，可称为隐式原型 。这不是一个标准的属性，但是每个浏览器都支持。该隐式原型指向的是创建该对象的构造函数的原型对象。这样就保证了实例能够访问在构造函数的原型中定义的属性和方法。对象和原型对象之间通过<code>__proto__</code>就构成了一条原型链。原型链的最外层是<code>Object.prototype</code> ，因为Object是所有对象的基础。</p><h4 id="拷贝继承"><a href="#拷贝继承" class="headerlink" title="拷贝继承"></a>拷贝继承</h4><p>父类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, sex</span>) </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.name = name;</span><br><span class="line"><span class="keyword">this</span>.sex = sex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.showName = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person.prototype.showSex = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.sex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>子类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Worker</span>(<span class="params">name, sex, job</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用父级的构造函数继承属性</span></span><br><span class="line">  Person.call(<span class="keyword">this</span>, name, sex); <span class="comment">// this -&gt; new 出来的Worker对象  </span></span><br><span class="line">  <span class="keyword">this</span>.job = job;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Worker.prototype = Person.prototype // 直接把父类的引用给子类，会导致子类修改父类</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 通过原型来继承父级的方法</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> Person.prototype) &#123;</span><br><span class="line">  Worker.prototype[i] = Person.prototype[i];</span><br><span class="line">  &#125;</span><br><span class="line">  Worker.prototype.showJob = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">this</span>.job);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过在子类的构造函数中调用父类的构造函数，并且通过call方法修改this指向，可以继承父类的属性。接下来我们需要继承父类的方法，如果直接把父类构造函数的原型对象引用赋值给子类原型对象，可以实现继承父类的方法，但是这样会导致我们在修改子类原型对象的时候会影响到父类的原型对象，所以我们通过for-in来继承父类的方法。可以封装一个extend方法来进行拷贝操作。下面是一个简单的extend方法封装。感兴趣可以去看看JQuery中的extend方法。实现起来更加复杂。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">obj1, obj2</span>)</span>&#123;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> attr <span class="keyword">in</span> obj2)&#123;</span><br><span class="line">obj1[attr] = obj2[attr]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>拷贝方法有一个很大的问题就是，如果父类中存在不可枚举的方法，那么通过for-in是无法继承的。</p><h4 id="类式继承"><a href="#类式继承" class="headerlink" title="类式继承"></a>类式继承</h4><p>在JavaScript中其实没有类的概念的，类式继承是通过构造函数实现继承。</p><p>子类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Worker</span>(<span class="params">name, sex, job</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用父级的构造函数继承属性</span></span><br><span class="line">  Person.call(<span class="keyword">this</span>, name, sex); <span class="comment">// this -&gt; new 出来的Worker对象  </span></span><br><span class="line">  <span class="keyword">this</span>.job = job;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承父级原型中的方法</span></span><br><span class="line">Worker.prototype = <span class="keyword">new</span> Person()</span><br><span class="line">Worker.prototype.constructor = Worker; <span class="comment">// 让constructor 指向 Worker</span></span><br><span class="line">Worker.prototype.showJob = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="keyword">this</span>.job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="对象中常用的属性和方法"><a href="#对象中常用的属性和方法" class="headerlink" title="对象中常用的属性和方法"></a>对象中常用的属性和方法</h3><p>hasOwnProperty : 判断是否是对象自身下面的属性 </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = []</span><br><span class="line">arr.num = <span class="number">10</span></span><br><span class="line"><span class="built_in">Array</span>.prototype.num2 = <span class="number">20</span></span><br><span class="line"><span class="built_in">console</span>.log( arr.hasOwnProperty(<span class="string">'num'</span>)  ) <span class="comment">// true</span></span><br><span class="line"><span class="built_in">console</span>.log(  arr.hasOwnProperty(<span class="string">'num2'</span>)  )  <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p>constructor : 查看对象的构造函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span> (<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log( a1.constructor )  <span class="comment">// Person</span></span><br><span class="line">Person.prototype.constructor = Person  <span class="comment">// 每一个函数都会有的，都是自动生成的</span></span><br></pre></td></tr></table></figure><p>instanceof : 对象与构造函数在原型链上是否有关系</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> person = <span class="keyword">new</span> Person()</span><br><span class="line"><span class="built_in">console</span>.log( person <span class="keyword">instanceof</span> <span class="built_in">Object</span> )  <span class="comment">// true</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;理解对象&quot;&gt;&lt;a href=&quot;#理解对象&quot; class=&quot;headerlink&quot; title=&quot;理解对象&quot;&gt;&lt;/a&gt;理解对象&lt;/h3&gt;&lt;h4 id=&quot;基本概念&quot;&gt;&lt;a href=&quot;#基本概念&quot; class=&quot;headerlink&quot; title=&quot;基本概念&quot;&gt;&lt;/a
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>Ajax基础和应用</title>
    <link href="https://gyunzhi.github.io/2018/07/01/Ajax%E5%9F%BA%E7%A1%80%E5%92%8C%E5%BA%94%E7%94%A8/"/>
    <id>https://gyunzhi.github.io/2018/07/01/Ajax基础和应用/</id>
    <published>2018-06-30T18:16:52.000Z</published>
    <updated>2019-05-06T09:26:27.091Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Ajax原理和封装"><a href="#Ajax原理和封装" class="headerlink" title="Ajax原理和封装"></a>Ajax原理和封装</h3><p>Ajax全称为 Asynchronous JavaScript and XML （异步JavaScript和XML） ，使用Ajax可以无需刷新页面即可从服务器获取到数据，带来更好的用户体验。Ajax技术的核心是XMLHttpRequest对象，虽然名字中含有XML，但Ajax通信与数据格式无关，从服务器获取的数据可以是XML格式，也可以是JSON格式。目前来说，我们一般使用JSON格式的数据。</p><h4 id="表单的基本知识"><a href="#表单的基本知识" class="headerlink" title="表单的基本知识"></a>表单的基本知识</h4><p>在介绍XMLHttpRequest对象之前，我们先来了解一下表单基本知识，在Ajax出现之前，网页通常使用表单提交数据，但是这种方式在提交数据时会刷新页面，用户体验不太好。</p><p>表单的数据提交有两种方式：get、post，这两种方式在提交数据时有一点区别</p><p>action :       数据提交的地址，默认是当前页面</p><p>method :  数据提交的方式，默认是get方式<br>          get： 数据以查询字符串的方式传递到服务器（username=gongyz&amp;age=a123）<br>        post：数据放在请求体中传递到服务器</p><p>enctype : 提交的数据的编码格式，默认是application/x-www-form-urlencoded</p><p>​    application/x-www-form-urlencoded</p><p>​    multipart/form-data </p><p>​    text/plain </p><p><strong>get方式</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"get.php"</span> <span class="attr">enctype</span>=<span class="string">"application/x-www-form-urlencoded"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset="utf-8"'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$username = $_GET[<span class="string">'username'</span>];</span><br><span class="line">$age = $_GET[<span class="string">'age'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"你的名字：&#123;$username&#125;，年龄：&#123;$age&#125;"</span>;</span><br></pre></td></tr></table></figure><p><strong>post方式</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"post.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"username"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset="utf-8"'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'username'</span>];</span><br><span class="line">$age = $_POST[<span class="string">'age'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"你的名字：&#123;$username&#125;，年龄：&#123;$age&#125;"</span>;</span><br></pre></td></tr></table></figure><h4 id="XMLHttpRequest对象"><a href="#XMLHttpRequest对象" class="headerlink" title="XMLHttpRequest对象"></a>XMLHttpRequest对象</h4><p>下面的代码是简单的的XMLHttpRequest对象的使用方法，try/catch是用来兼容IE6和以前的版本。在XMLHttpRequest 2级中，该对象有了一些新的特性，而且现在开发人员也不会去兼容IE6和它之前的版本了，取而代之的是一些Ajax库，比较常用的像Jquery的ajax方法、axios等。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">'Microsoft.XMLHTTP'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.readyState == <span class="number">4</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.status == <span class="number">200</span> ) &#123;</span><br><span class="line"><span class="built_in">console</span>.log(xhr.responseText)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error：'</span>, xhr.status, xhr.statusText);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.open(<span class="string">'get'</span>,<span class="string">'getList.php'</span>,<span class="literal">true</span>);</span><br><span class="line">xhr.send(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'content-type:text/html;charset="utf-8"'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$arr1 = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">echo</span> json_encode($arr1);</span><br></pre></td></tr></table></figure><p>下面会对XMLHttpRequest属性和一些新特性做一些说明，虽然不用原生的XMLHttpRequest进行开发，但了解这些东西对我们还是有帮助的。</p><h5 id="XHR用法"><a href="#XHR用法" class="headerlink" title="XHR用法"></a>XHR用法</h5><p><em>open方法</em></p><p>在使用XHR对象时，要调用的第一个方法是open方法，该方法接受三个参数</p><p>​    请求类型： get/post</p><p>​    请求URL</p><p>​    是否异步发送请求（一般默认为true，不会去阻塞下面代码的执行）</p><p><strong>注意：调用open方法并不会发送请求，而是启动一个请求以备发送</strong></p><p>send<em>方法</em></p><p>send方法接收一个参数，即要作为请求主体发送的数据，调用send方法后，请求就会发送到服务器，在收到响应后，相应的数据会自动填充XHR对象的属性</p><p><em>responseText：作为响应主体被返回的文本</em></p><p><em>responseXML：如果响应的内容是XML数据，这个属性中将会保存包含响应数据的XML DOM文档，否则为null</em></p><p><em>status：http状态码</em></p><p><em>statusText：http状态说明</em></p><p><em>readyState：</em></p><p>该属性标识请求/响应响应过程当前所处的状态，该属性有5个取值，该值改变时会触发onreadystatechange事件</p><p>​    0： 未初始化化。尚未调用open方法。</p><p>​    1： 启动。已经调用open方法，但尚未调用send方法</p><p>​    2： 发送。已经调用send方法，但尚未接收到响应</p><p>​    3： 接收。已经接收的部分数据</p><p>​    4：完成。已经接收到全部响应数据，并且可以在客户端使用</p><p>对于同步请求，可以等到请求完成在进行其他操作，但通常情况，我们使用的是异步请求，所以需要在onreadystatechange事件中监测每次状态变化后readyState值。所以我们只对readyState值为4的情况感兴趣。</p><p>注意：为了保证浏览器兼容性，应该在调用open方法之前指定onreadystatechange事件的处理函数（目前没碰上过这种兼容性问题，但是建议这样处理，可能该问题在低版本浏览器会出现）</p><p><em>abort方法</em></p><p>调用该方法后，XHR对象会停止触发事件，而且也不允许再访问任何与响应有关的对象属性。在终止操作后，还应该对XHR对象进行解引用操作。由于内存原因，不建议重用XHR对象。</p><h5 id="get、post区别和处理"><a href="#get、post区别和处理" class="headerlink" title="get、post区别和处理"></a>get、post区别和处理</h5><p>使用XHR对象发送get请求</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">'Microsoft.XMLHTTP'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.readyState == <span class="number">4</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.status == <span class="number">200</span> ) &#123;</span><br><span class="line"><span class="built_in">console</span>.log( xhr.responseText );</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error：'</span>, xhr.status, xhr.statusText);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">存在的问题</span></span><br><span class="line"><span class="comment">1.缓存 在url？后面连接一个随机数，时间戳</span></span><br><span class="line"><span class="comment">2.乱码 编码encodeURI</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">xhr.open(<span class="string">'get'</span>,<span class="string">'test.php?username='</span>+<span class="built_in">encodeURI</span>(<span class="string">'刘伟'</span>)+<span class="string">'&amp;age=30&amp;'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),<span class="literal">true</span>);</span><br><span class="line">xhr.send();</span><br></pre></td></tr></table></figure><p>使用XHR对象发送post请求</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">'Microsoft.XMLHTTP'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.readyState == <span class="number">4</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.status == <span class="number">200</span> ) &#123;</span><br><span class="line"><span class="built_in">console</span>.log( xhr.responseText );</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error：'</span>, xhr.status, xhr.statusText);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// post方式，数据放在send()里面作为参数传递</span></span><br><span class="line">xhr.open(<span class="string">'post'</span>,<span class="string">'test.php'</span>,<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 申明发送的数据类型</span></span><br><span class="line">xhr.setRequestHeader(<span class="string">'content-type'</span>, <span class="string">'application/x-www-form-urlencoded'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// post没有缓存问题,无需编码</span></span><br><span class="line">xhr.send(<span class="string">'username=刘伟&amp;age=30'</span>);</span><br></pre></td></tr></table></figure><h5 id="XHR新特性"><a href="#XHR新特性" class="headerlink" title="XHR新特性"></a>XHR新特性</h5><p><strong>FormData</strong></p><p>FormData对象用来创建于与表单格式相同的数据（用于通过XHR传输），使用了FormData之后，不需要设置请求头的content-type，XHR能够识别传入的数据类型是FormData实例，并配置适当的头部信息。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">'Microsoft.XMLHTTP'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.readyState == <span class="number">4</span> ) &#123;</span><br><span class="line"><span class="keyword">if</span> ( xhr.status == <span class="number">200</span> ) &#123;</span><br><span class="line"><span class="built_in">console</span>.log( xhr.responseText );</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Error：'</span>, xhr.status, xhr.statusText);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// post方式，数据放在send()里面作为参数传递</span></span><br><span class="line">xhr.open(<span class="string">'post'</span>,<span class="string">'test.php'</span>,<span class="literal">true</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = <span class="keyword">new</span> FormData()</span><br><span class="line">data.append(<span class="string">'username'</span>, <span class="string">'gongyz'</span>)</span><br><span class="line">data.append(<span class="string">'age'</span>, <span class="string">'123'</span>)</span><br><span class="line"></span><br><span class="line">xhr.send(data);</span><br></pre></td></tr></table></figure><p><strong>load事件：</strong>在接收到完整的响应数据时触发，可以替换上面的onreadystatechange事件</p><p><strong>progress事件：</strong>可以用来制作精度条</p><p>​    lengthComputable：表示进度信息是否可用</p><p>​    loaded：已经上传的字节数</p><p>​    total：总字节数</p><p>下面是一个Ajax上传文件的例子，我们通过这个例子来学习load和progress事件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">#div1 &#123;width: 300px; height: 30px; border: 1px solid #000; position: relative;&#125;</span></span><br><span class="line"><span class="undefined">#div2 &#123;width: 0; height: 30px; background: #CCC;&#125;</span></span><br><span class="line"><span class="undefined">#div3 &#123;width: 300px; height: 30px; line-height: 30px; text-align: center; position: absolute; left: 0; top: 0;&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oMyFile = <span class="built_in">document</span>.getElementById(<span class="string">'myFile'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv1 = <span class="built_in">document</span>.getElementById(<span class="string">'div1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv2 = <span class="built_in">document</span>.getElementById(<span class="string">'div2'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oDiv3 = <span class="built_in">document</span>.getElementById(<span class="string">'div3'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="undefined">    </span></span><br><span class="line"><span class="javascript">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(<span class="string">'OK,上传完成'</span>);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">xhr.upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">ev</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> (lengthComputable) &#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> iScale = ev.loaded / ev.total;</span></span><br><span class="line"><span class="javascript">oDiv2.style.width = <span class="number">300</span> * iScale + <span class="string">'px'</span>;</span></span><br><span class="line"><span class="javascript">oDiv3.innerHTML = iScale * <span class="number">100</span> + <span class="string">'%'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">xhr.open(<span class="string">'post'</span>, <span class="string">'post_file.php'</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">xhr.setRequestHeader(<span class="string">'X-Request-With'</span>, <span class="string">'XMLHttpRequest'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oFormData = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="javascript">oFormData.append(<span class="string">'file'</span>, oMyFile.files[<span class="number">0</span>]);</span></span><br><span class="line"><span class="undefined">xhr.send(oFormData);</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"myFile"</span> /&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"btn"</span> <span class="attr">value</span>=<span class="string">"上传"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"div3"</span>&gt;</span>0%<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>注意，progress事件不是定义在xhr，而是定义在xhr.upload，因为这里需要区分下载和上传，下载也有一个progress事件</strong></p><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>Ajax的基本知识基本上都在上面，新增的特性还有一些，感兴趣的可以去看JavaScript高级程序设计（目前是第三版）。补充一句，关于Ajax文件上传可以去看看大家可以去看看我之前的文章<strong>从 HTML5 拖放事件 探究文件上传功能</strong>和<strong>Blob API的使用</strong>，另外阮一峰老师也有一篇博客<a href="http://www.ruanyifeng.com/blog/2012/08/file_upload.html" target="_blank" rel="noopener">文件上传的渐进式增强</a>，也推荐大家看一看。</p><h3 id="Ajax跨域解决方案"><a href="#Ajax跨域解决方案" class="headerlink" title="Ajax跨域解决方案"></a>Ajax跨域解决方案</h3><h4 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h4><p>在XMLHttpRequest 2 级之前，JSONP是最常用的跨域解决方案，JSONP由两部分组成，回调函数和数据。回调函数是当响应来到是应该在页面中调用的函数。回调函数的名字一般是在请求中指定的。而数据就是传入回调函数中的JSON数据。</p><p>下面是一个JSONP的示例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">#q &#123;width: 300px; height: 30px; padding: 5px; border:1px solid #f90; font-size: 16px;&#125;</span></span><br><span class="line"><span class="undefined">#ul1 &#123;border:1px solid #f90; width: 310px; margin: 0;padding: 0; display: none;&#125;</span></span><br><span class="line"><span class="undefined">li a &#123; line-height: 30px; padding: 5px; text-decoration: none; color: black; display: block;&#125;</span></span><br><span class="line"><span class="undefined">li a:hover&#123; background: #f90; color: white; &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span> (<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl = <span class="built_in">document</span>.getElementById(<span class="string">'ul1'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> html = <span class="string">''</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> (data.s.length) &#123;</span></span><br><span class="line"><span class="javascript">oUl.style.display = <span class="string">'block'</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;data.s.length; i++) &#123;</span></span><br><span class="line"><span class="xml">html += '<span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">href</span>=<span class="string">"http://www.baidu.com/s?wd='+data.s[i]+'"</span>&gt;</span>'+ data.s[i] +'<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span>';</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">oUl.innerHTML = html;</span></span><br><span class="line"><span class="javascript">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">oUl.style.display = <span class="string">'none'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oQ = <span class="built_in">document</span>.getElementById(<span class="string">'q'</span>);</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oUl = <span class="built_in">document</span>.getElementById(<span class="string">'ul1'</span>);</span></span><br><span class="line"><span class="undefined">  </span></span><br><span class="line"><span class="javascript">oQ.onkeyup = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> ( <span class="keyword">this</span>.value != <span class="string">''</span> ) &#123;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oScript = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span></span><br><span class="line"><span class="javascript">oScript.src = <span class="string">'http://suggestion.baidu.com/su?wd='</span>+<span class="keyword">this</span>.value+<span class="string">'&amp;cb=handleResponse'</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.appendChild(oScript);</span></span><br><span class="line"><span class="javascript">&#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="javascript">oUl.style.display = <span class="string">'none'</span>;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"q"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"ul1"</span>&gt;</span><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h4><p>跨域资源共享是XMLHttpRequest 2级加入了W3C的规范中，目前大部分主流浏览器都支持，CORS的基本思想就是使用HTTP头部让浏览器和服务器进行沟通，从而决定跨域请求时成功还是失败。</p><p>当发送一个HTTP请求时，浏览器检测到这是一个跨域请求，会给该请求添加一个额外的Origin头部，其中包含请求页面的源信息（协议、域名和端口），以便服务器根据这个头部信息来决定是否给与响应。下面是一个Origin头部的示例：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Origin</span>: http://www.nczoline.net</span><br></pre></td></tr></table></figure><p>如果服务器认为这个请求可以接受，就在Access-Control-Allow-Origin头部中回发出相同的原信息（如果是公共资源，可以回发’*’）。例如：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Access-Control-Allow-Origin</span>: http://www.nczoline.net</span><br></pre></td></tr></table></figure><p>如果没有这个头部，或者有这个头部但是源信息不匹配，浏览器就会驳回请求。正常情况下浏览器会处理请求。</p><p><strong>注意：对于跨域请求，cookie不会再客户端和服务端之前传递（为了安全）</strong></p><p>代码实例</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE HTML&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>无标题文档<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined">/*</span></span><br><span class="line"><span class="undefined">实现跨域请求，还需要后端的相关配合才可以</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">XDomainRequest： XDomainRequest是在IE8和IE9上的 CORS 的实现，在IE10中被包含CORS的 XMLHttpRequest 取代了</span></span><br><span class="line"><span class="undefined">*/</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> oBtn = <span class="built_in">document</span>.getElementById(<span class="string">'btn'</span>);</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript">oBtn.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"><span class="built_in">console</span>.log(xhr.responseText)</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript">xhr.open(<span class="string">'get'</span>, <span class="string">'http://www.b.com/ajax.php'</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="undefined">xhr.send();</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// var xdr= new XDomainRequest();</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// xdr.onload = function() &#123;</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// console.log(this.responseText);</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// &#125;</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// xdr.open('get', 'http://www.b.com/ajax.php', true);</span></span></span><br><span class="line"><span class="javascript"><span class="comment">// xdr.send();</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"跨域请求"</span> <span class="attr">id</span>=<span class="string">"btn"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Access-Control-Allow-Origin: http://www.a.com'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'hello'</span>;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Ajax原理和封装&quot;&gt;&lt;a href=&quot;#Ajax原理和封装&quot; class=&quot;headerlink&quot; title=&quot;Ajax原理和封装&quot;&gt;&lt;/a&gt;Ajax原理和封装&lt;/h3&gt;&lt;p&gt;Ajax全称为 Asynchronous JavaScript and XML （异
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>闭包的应用</title>
    <link href="https://gyunzhi.github.io/2018/06/30/%E9%97%AD%E5%8C%85%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://gyunzhi.github.io/2018/06/30/闭包的应用/</id>
    <published>2018-06-29T18:16:52.000Z</published>
    <updated>2019-05-06T09:26:27.154Z</updated>
    
    <content type="html"><![CDATA[<h3 id="闭包的概念"><a href="#闭包的概念" class="headerlink" title="闭包的概念"></a>闭包的概念</h3><p>函数嵌套函数，内部函数可以引用外部函数的参数和变量,外部函数执行完了之后，其变量和参数也不会被垃圾回收机制收回 （注：在JavaScript高级程序设计中对闭包下的定义是：<em>闭包是指有有权访问另一个函数作用域中的变量的函数</em>，这两者并不冲突，我个人 更倾向于闭包是一种概念）</p><h3 id="闭包的作用"><a href="#闭包的作用" class="headerlink" title="闭包的作用"></a>闭包的作用</h3><p><strong>（1） 让变量长期驻扎在内存当中</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a=<span class="number">5</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(a);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> fn2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn=fn1();<span class="comment">//fn1执行完后，变量a并没有被垃圾回收机制收回</span></span><br><span class="line"></span><br><span class="line">fn();<span class="comment">//在这里，还可以访问到fn1中的变量a</span></span><br></pre></td></tr></table></figure><p><strong>（2） 避免全局变量的污染</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  a++;</span><br><span class="line">  <span class="built_in">console</span>.log(a)</span><br><span class="line">&#125;</span><br><span class="line">fn1(); <span class="comment">//2</span></span><br><span class="line">fn1(); <span class="comment">//3</span></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">//3   全局变量被改变</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 使用闭包之后的函数：通过闭包实现每次调用a累加,同时又不会改变全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">    alert(a);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">fn=fn2();</span><br><span class="line">fn(); <span class="comment">//2</span></span><br><span class="line">fn(); <span class="comment">//3</span></span><br><span class="line"><span class="built_in">console</span>.log(a); <span class="comment">//1   全局变量不变</span></span><br></pre></td></tr></table></figure><p><strong>（3）让函数拥有私有成员</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 让函数拥有私有成员</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn1 = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a=<span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 特权函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">    <span class="built_in">console</span>.log(a)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 特权函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    a++;</span><br><span class="line">    <span class="built_in">console</span>.log(a);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span>&#123;</span><br><span class="line">    <span class="string">"fn2"</span>:fn2,</span><br><span class="line">    <span class="string">"fn3"</span>:fn3</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">fn1.fn2(); <span class="comment">//2</span></span><br><span class="line">fn1.fn3(); <span class="comment">//2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a);<span class="comment">//undefined</span></span><br><span class="line">fn2();<span class="comment">//undefined</span></span><br><span class="line">fn3();<span class="comment">//undefined</span></span><br></pre></td></tr></table></figure><h3 id="闭包的应用"><a href="#闭包的应用" class="headerlink" title="闭包的应用"></a>闭包的应用</h3><p>（1）模仿块级作用域</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//块级作用域</span></span><br><span class="line">  <span class="keyword">var</span> a = <span class="number">10</span></span><br><span class="line">  <span class="built_in">console</span>.log(a)  <span class="comment">// 10</span></span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(a)  <span class="comment">// a is not defined</span></span><br></pre></td></tr></table></figure><p>（2）在循环中直接找到对应元素的索引 </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;闭包<span class="number">2</span>&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  &lt;style type="text/</span>css<span class="string">"&gt;</span></span><br><span class="line"><span class="string">    li&#123;background: #000;border:2px solid #fff;color: #fff;list-style: none;&#125;</span></span><br><span class="line"><span class="string">  &lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">  &lt;ul&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;1&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;2&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;3&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li&gt;4&lt;/li&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 普通函数：点击每一个元素输出的都是 4</span></span><br><span class="line"><span class="string"> for (var i =0;i&lt;aLi.length;i++) &#123;</span></span><br><span class="line"><span class="string">    aLi[i].onclick=function ()&#123;</span></span><br><span class="line"><span class="string">      console.log(i);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 闭包函数：使用闭包后，点击对应的元素，输出的是对应元素的索引值</span></span><br><span class="line"><span class="string"> for (var i =0;i&lt;aLi.length;i++) &#123;</span></span><br><span class="line"><span class="string">    (function (i)&#123;</span></span><br><span class="line"><span class="string">      aLi[i].onclick=function ()&#123;</span></span><br><span class="line"><span class="string">        console.log(i);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;)(i);</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> // 方法二</span></span><br><span class="line"><span class="string"> for (var i =0;i&lt;aLi.length;i++) &#123;</span></span><br><span class="line"><span class="string">    aLi[i].onclick=(function (i)&#123;</span></span><br><span class="line"><span class="string">      return function ()&#123;</span></span><br><span class="line"><span class="string">        console.log(i);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;)(i);</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><h3 id="闭包的注意事项"><a href="#闭包的注意事项" class="headerlink" title="闭包的注意事项"></a>闭包的注意事项</h3><p>  闭包在<code>IE8-</code>下会引发内存泄漏：内存泄漏就是指浏览器不关闭,内存一直不会被释放</p><p>  在理解内存泄漏时，我们先来了解一下JS中的垃圾回收机制：</p><p>  JS中的内存回收是自动回收的，主要有两种方式:</p><p>​    (1) 标记清除</p><p>​      变进入环境（例如，在函数中声明一个变量），则将这个变量标记为’进入环境’，当变量离开环境时，则将其标记为离开环境。垃圾收集器会自动回收那些离开环境的变量所占用的内存</p><p>   (2) 引用计数</p><p>​      引用计数的含义是跟踪每一个值被引用的次数。当声明一个变量并将一个值赋给该变量，则这个值的引用次数加1。如果这个变量又取了另外一个值，则这个值得引用次数减1，当这个值得引用次数变为0时，就可以将其占用的内存空间回收回来。</p><p>​    内存泄漏就是由于引用计数方式中的循环引用造成的，在下面的例子中，oBjectA和objectB分别指向一个Object类型的对象，则这两个对象的引用计数都是1，然后oBjectA和objectB通过各自的属性互相引用，oBjectA和objectB指向的那两个对象的引用计数都变成了2，这样就造成内存无法回收。（这里希望大家搞 清楚一个概念，oBjectA和objectB的值才是对象，oBjectA和objectB本身是变量）。现代浏览器都是采用标记清除的垃圾回收策略，但是在<code>IE8-</code>中的BOM和DOM并不是原生的JavaScript对象，其BOM和DOM使用c++以COM对象的形式实现的，而COM对象的垃圾回收机制采用的就是引用计数策略</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">var</span> objectA = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">   <span class="keyword">var</span> objectB = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">   </span><br><span class="line">   objectA.attr1 = objectB;</span><br><span class="line">   objectB.attr = objectA;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ES6中新特性"><a href="#ES6中新特性" class="headerlink" title="ES6中新特性"></a>ES6中新特性</h3><p>在ES5和之前的版本中，没有块级作用域的概念，所以开发人员巧妙的利用闭包来实现块级作用域，以满足开发需求。但是在ES6中新增了let和const命令，并且定义了块级作用域的命令，所以闭包以后将会慢慢废弃，我们只需要了解有这个东西即可，重要的是积极学习使用ES6的新特性，这里推荐下阮一峰老师的<a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener">ECMAScript 6 入门</a>。</p><p>ES6 新增了<code>let</code>命令，用来声明变量。它的用法类似于<code>var</code>，但是所声明的变量，只在<code>let</code>命令所在的代码块内有效。 </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> a = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a <span class="comment">// ReferenceError: a is not defined.</span></span><br><span class="line">b <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><p>使用<code>let</code>命令代替<code>var</code>我们可以改写一下上面的for循环</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改成let命令后，点击每个元素时，输出的是对应元素的索引，不需要再使用闭包了</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i =<span class="number">0</span>;i&lt;aLi.length;i++) &#123;</span><br><span class="line">    aLi[i].onclick=<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(i);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;闭包的概念&quot;&gt;&lt;a href=&quot;#闭包的概念&quot; class=&quot;headerlink&quot; title=&quot;闭包的概念&quot;&gt;&lt;/a&gt;闭包的概念&lt;/h3&gt;&lt;p&gt;函数嵌套函数，内部函数可以引用外部函数的参数和变量,外部函数执行完了之后，其变量和参数也不会被垃圾回收机制收回 （注
      
    
    </summary>
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/categories/JavaScript/"/>
    
    
      <category term="JavaScript" scheme="https://gyunzhi.github.io/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>前端安全配置Content-Security-Policy</title>
    <link href="https://gyunzhi.github.io/2018/06/16/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AEContent-Security-Policy/"/>
    <id>https://gyunzhi.github.io/2018/06/16/前端安全配置Content-Security-Policy/</id>
    <published>2018-06-15T19:09:59.000Z</published>
    <updated>2019-05-06T09:26:27.146Z</updated>
    
    <content type="html"><![CDATA[<h3 id="什么是CSP"><a href="#什么是CSP" class="headerlink" title="什么是CSP"></a>什么是CSP</h3><p>​    CSP全称Content Security Policy (内容安全策略),是为了页面内容安全而制定的一系列防护策略.  通过CSP所约束的的规则可以指定可信的内容来源（这里的内容可以指脚本、图片、iframe、font、style等等可能的远程的资源）。</p><h3 id="CSP的作用"><a href="#CSP的作用" class="headerlink" title="CSP的作用"></a>CSP的作用</h3><p>​    跨域脚本攻击 <a href="http://baike.baidu.com/view/2161269.htm" target="_blank" rel="noopener">XSS</a>（Cross Site Scripting ） 是最常见、危害最大的网页安全漏洞，为了防止它们，要采取很多编程措施，非常麻烦。通过制定CSP 策略，开发者可以明确告诉浏览器，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，即让浏览器自动禁止外部注入恶意脚本。CSP 大大增强了网页的安全性。攻击者即使发现了漏洞，也没法注入脚本，除非还控制了一台列入了白名单的可信主机。 </p><h3 id="常用指令说明"><a href="#常用指令说明" class="headerlink" title="常用指令说明"></a>常用指令说明</h3><p>​    指令是CSP 中用来定义策略的基本单位，CSP 提供了很多指令，涉及安全的各个方面，我们可以使用单个或者多个指令组合在一起来防护我们的网站。</p><p><strong>获取指令（以下指令可以限制各类资源的加载）</strong></p><ul><li><strong>script-src</strong>：外部脚本</li><li><strong>style-src</strong>：样式表</li><li><strong>img-src</strong>：图像</li><li><strong>media-src</strong>：媒体文件（音频和视频）</li><li><strong>font-src</strong>：字体文件</li><li><strong>object-src</strong>：插件（比如 Flash）</li><li><strong>child-src</strong>：框架</li><li><strong>frame-ancestors</strong>：嵌入的外部资源（比如<frame>） </li><li><strong>connect-src</strong>：HTTP 连接（通过 XHR、WebSockets、EventSource等）</li><li><strong>worker-src</strong>：<code>worker</code>脚本</li><li><strong>manifest-src</strong>：manifest 文件</li></ul><p>注意：<strong>default src</strong> 用来设置上面各个选项的默认值：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="string">'self'</span></span><br></pre></td></tr></table></figure><p>上面代码限制<strong>所有的</strong>外部资源，都只能从当前域名加载。 </p><p>如果同时设置某个单项限制（比如<code>font-src</code>）和<code>default-src</code>，前者会覆盖后者，即字体文件会采用<code>font-src</code>的值，其他资源依然采用<code>default-src</code>的值 。</p><p><strong>报告指令</strong></p><p>​    有时，我们不仅希望防止 XSS，还希望记录此类行为。<code>report-uri</code>就用来告诉浏览器，应该把注入行为报告给哪个网址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src <span class="string">'self'</span>; ...; report-uri /csp_report_url;</span><br></pre></td></tr></table></figure><p>上面代码指定，将注入行为报告给<code>/csp_report_url</code>这个 URL。</p><p>浏览器会使用<code>POST</code>方法，发送一个JSON对象，下面是一个例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"csp-report"</span>: &#123;</span><br><span class="line">    <span class="attr">"document-uri"</span>: <span class="string">"http://example.org/page.html"</span>,</span><br><span class="line">    <span class="attr">"referrer"</span>: <span class="string">"http://evil.example.com/"</span>,</span><br><span class="line">    <span class="attr">"blocked-uri"</span>: <span class="string">"http://evil.example.com/evil.js"</span>,</span><br><span class="line">    <span class="attr">"violated-directive"</span>: <span class="string">"script-src 'self' https://apis.google.com"</span>,</span><br><span class="line">    <span class="attr">"original-policy"</span>: <span class="string">"script-src 'self' https://apis.google.com; report-uri http://example.org/my_amazing_csp_report_parser"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>指令值</strong></p><ul><li>主机名：<code>example.org</code>，<code>https://example.com:443</code></li><li>路径名：<code>example.org/resources/js/</code></li><li>通配符：<code>*.example.org</code>，<code>*://*.example.com:*</code>（表示任意协议、任意子域名、任意端口）</li><li>协议名：<code>https:</code>、<code>data:</code> ：只允许通过https、data协议加载资源</li><li>关键字<code>&#39;self&#39;</code>：当前域名，需要加引号</li><li>关键字<code>&#39;none&#39;</code>：禁止加载任何外部资源，需要加引号</li></ul><p>除了常规值，<code>script-src</code>还可以设置一些特殊值，注意，下面这些值都必须放在单引号里面。 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unsafe-inline：允许执行页面内嵌的`&amp;lt;script&gt;`标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用`eval`、`setTimeout`、`setInterval`和`Function`等函数</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行</span><br></pre></td></tr></table></figure><h3 id="如何启用CSP"><a href="#如何启用CSP" class="headerlink" title="如何启用CSP"></a>如何启用CSP</h3><p>两种方法可以启用 CSP，一种是通过网页的<code>&lt;meta&gt;</code>标签，另一种是通过 HTTP 头信息的<code>Content-Security-Policy</code>的字段。 </p><p>1、通过meta标签启用CSP：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面代码中，CSP 做了如下配置：</p><ul><li>脚本：只信任当前域名</li><li><code>&lt;object&gt;</code>标签：不信任任何URL，即不加载任何资源</li><li>样式表：只信任<code>cdn.example.org</code>和<code>third-party.org</code></li><li>框架（frame）：必须使用HTTPS协议加载</li><li>其他资源：没有限制</li></ul><p>2、服务器端配置<code>Content-Security-Policy</code>启用</p><ul><li><p>Apache</p><p>在VirtualHost的httpd.conf文件中添加如下代码</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Header <span class="built_in">set</span> Content-Security-Policy <span class="string">"default-src 'self';"</span></span><br></pre></td></tr></table></figure><ul><li><p>Nginx</p><p>在 server 对象块中添加如下代码</p></li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">add_header</span> Content-Security-Policy <span class="string">"default-src 'self';"</span></span><br></pre></td></tr></table></figure><h3 id="相关阅读链接"><a href="#相关阅读链接" class="headerlink" title="相关阅读链接"></a>相关阅读链接</h3><ul><li><h5 id="Content-Security-Policy-入门教程"><a href="#Content-Security-Policy-入门教程" class="headerlink" title="Content Security Policy 入门教程"></a><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a></h5></li><li><h5 id="前端安全配置之Content-Security-Policy"><a href="#前端安全配置之Content-Security-Policy" class="headerlink" title="[前端安全配置之Content-Security-Policy"></a>[<a href="https://www.cnblogs.com/heyuqing/p/6215761.html" target="_blank" rel="noopener">前端安全配置之Content-Security-Policy</a></h5></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;什么是CSP&quot;&gt;&lt;a href=&quot;#什么是CSP&quot; class=&quot;headerlink&quot; title=&quot;什么是CSP&quot;&gt;&lt;/a&gt;什么是CSP&lt;/h3&gt;&lt;p&gt;​    CSP全称Content Security Policy (内容安全策略),是为了页面内容安全而制
      
    
    </summary>
    
      <category term="Web安全" scheme="https://gyunzhi.github.io/categories/Web%E5%AE%89%E5%85%A8/"/>
    
    
      <category term="Web安全" scheme="https://gyunzhi.github.io/tags/Web%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>App Links和Universal Links的配置和使用</title>
    <link href="https://gyunzhi.github.io/2018/04/17/App%20Links%E5%92%8CUniversal%20Links%E7%9A%84%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
    <id>https://gyunzhi.github.io/2018/04/17/App Links和Universal Links的配置和使用/</id>
    <published>2018-04-16T22:39:31.000Z</published>
    <updated>2019-05-06T09:26:27.094Z</updated>
    
    <content type="html"><![CDATA[<p>之前的有一篇博文介绍了Scheme的方式来实现App之间的跳转，但是这种方式有一个问题，就是当我们的移动设备上没有安装该App时，它不能做其他的处理，比如跳转到我们公司的网站里面。在2015年，Google和Apple分别提出了和App Links（只支持Android M及以上系统）和Universal Links（只支持IOS9及以上系统）这两个新特性。这两种方式，可以通过访问HTTP/HTTPS链接直接唤起APP进入具体页面，不需要其他额外判断；如果未安装App，访问此链接时，可以展示你网站的内容。这两种方式有一个要求，你需要有一个域名和自己的服务器，下面分别介绍这两种方式：</p><h3 id="App-Links"><a href="#App-Links" class="headerlink" title="App Links"></a>App Links</h3><h4 id="1-在AndroidManifest-xml激活App-links"><a href="#1-在AndroidManifest-xml激活App-links" class="headerlink" title="1. 在AndroidManifest.xml激活App links"></a>1. 在AndroidManifest.xml激活App links</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;intent-filter android:autoVerify=<span class="string">"true"</span>&gt; &lt;!--App Links启动--&gt;</span><br><span class="line">&lt;action android:name=<span class="string">"android.intent.action.VIEW"</span>&gt;&lt;/action&gt;</span><br><span class="line">   &lt;category android:name=<span class="string">"android.intent.category.DEFAULT"</span>&gt;&lt;/category&gt;  </span><br><span class="line">   &lt;category android:name=<span class="string">"android.intent.category.BROWSABLE"</span> /&gt;</span><br><span class="line">   &lt;data android:scheme=<span class="string">"http"</span> android:host=<span class="string">"www.yourdomain.com.com"</span> /&gt;</span><br><span class="line">   &lt;data android:scheme=<span class="string">"https"</span> android:host=<span class="string">"www.yourdomain.com.com"</span> /&gt;</span><br><span class="line">&lt;/intent-filter&gt;</span><br></pre></td></tr></table></figure><p>这个配置告诉安卓去验证一个文件，这个文件地址是<a href="https://yourdomain.com/.well-known/statements.json," target="_blank" rel="noopener">https://yourdomain.com/.well-known/statements.json,</a>如果存在这个文件，同时验证成功，那么用户点击该域名之下的链接时，就可以直接到app，下一步，我们将学会如何构建这个文件。</p><h4 id="2-上传web-app关联文件（statements-json）"><a href="#2-上传web-app关联文件（statements-json）" class="headerlink" title="2. 上传web-app关联文件（statements.json）"></a>2. 上传web-app关联文件（statements.json）</h4><p>基于安全的原因，这个文件必须通过SSL的GET请求获得，所以你需要下载一个SSL证书，并且配置在你的服务器中，然后你可以打开一个文本编辑器，写入如下形式的JSON：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[&#123;  </span><br><span class="line">  <span class="string">"relation"</span>: [<span class="string">"delegate_permission/common.handle_all_urls"</span>], </span><br><span class="line">  <span class="string">"target"</span>: &#123; </span><br><span class="line">    <span class="string">"namespace"</span>: <span class="string">"android_app"</span>,    </span><br><span class="line">    <span class="string">"package_name"</span>: <span class="string">"com.mycompany.myapp"</span>,    </span><br><span class="line">    <span class="string">"sha256_cert_fingerprints"</span>: [<span class="string">"6C:EC:C5:0E:34:AE....EB:0C:9B"</span>] </span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure><p>你可以在AndroidManifest.xml 文件中找到app的package name。你还需要通过在终端中执行以下命令查看keystore参数信息来找到sha256指纹(关于生成签名密钥，你可以看下我之前的文章)：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -v -keystore my-release-key.keystore</span><br></pre></td></tr></table></figure><p>注：</p><ul><li>你可以通过<a href="https://developers.google.com/digital-asset-links/tools/generator" target="_blank" rel="noopener">Statement List Generator and Tester</a>这个网站来自动生成和测试statements.json文件，</li></ul><ul><li>目前可以通过http获得这个文件，但是在M最终版里则只能通过HTTPS验证。确保你的web站点支持HTTPS请求。</li></ul><h4 id="3-上传这个文件到服务器的-well-known文件夹"><a href="#3-上传这个文件到服务器的-well-known文件夹" class="headerlink" title="3.上传这个文件到服务器的.well-known文件夹"></a>3.上传这个文件到服务器的.well-known文件夹</h4><p>如果你的服务器是windows系统，.well-know文件夹可以通过命令行的形式创建。</p><h3 id="Universal-Links"><a href="#Universal-Links" class="headerlink" title="Universal Links"></a>Universal Links</h3><h4 id="1-注册App并打开Associated-Domains服务"><a href="#1-注册App并打开Associated-Domains服务" class="headerlink" title="1. 注册App并打开Associated Domains服务"></a>1. 注册App并打开Associated Domains服务</h4><p>如果你还没有注册App，则需要登陆developer.apple.com注册。然后在Identifiers下AppIDs找到自己的App ID，并打开Associated Domains服务。</p><p><img src="http://img.gongyz.cn/blog/181030/e0KFhCKCLa.png" alt="mark"></p><h4 id="2-在Xcode中开启Associated-Domains服务"><a href="#2-在Xcode中开启Associated-Domains服务" class="headerlink" title="2. 在Xcode中开启Associated Domains服务"></a>2. 在Xcode中开启Associated Domains服务</h4><ul><li><p>打开Associated Domains服务</p><p><img src="http://img.gongyz.cn/blog/181030/d3CjiLlLCG.png" alt="mark"></p></li><li><p>添加域名，点击Associated Domains的“+”添加前缀为applinks:的域名，如下图所示</p><p><img src="http://img.gongyz.cn/blog/181030/6dk58fEi6E.png" alt="mark"></p></li></ul><h4 id="3-配置apple-app-site-association文件"><a href="#3-配置apple-app-site-association文件" class="headerlink" title="3.配置apple-app-site-association文件"></a>3.配置apple-app-site-association文件</h4><p>文件格式如下图所示：</p><p><img src="http://img.gongyz.cn/blog/181030/3mhaLhDHKA.png" alt="mark"></p><ul><li>paths对应域名中的path，用于过滤可以跳转到App的链接，支持通配符‘*’，‘？’以及‘NOT’进行匹配，匹配的优先级是从左至右依次降低。</li></ul><ul><li><p>appID对应项由前缀和ID两部分组成，可以在developer.apple.com中的Identifiers→AppIDs中点击对应的App ID查看。</p><p><img src="http://img.gongyz.cn/blog/181030/HDeh50BC4j.png" alt="mark"></p></li></ul><h4 id="4-上传这个文件到服务器的-well-known文件夹"><a href="#4-上传这个文件到服务器的-well-known文件夹" class="headerlink" title="4.上传这个文件到服务器的.well-known文件夹"></a>4.上传这个文件到服务器的.well-known文件夹</h4><p>IOS下仅支持不支持HTTPS获取apple-app-site-association文件，所以我们必须要在服务器中配置SSL证书</p><h3 id="相关阅读链接"><a href="#相关阅读链接" class="headerlink" title="相关阅读链接"></a>相关阅读链接</h3><ul><li><h5 id="Android-M-App-Links实现"><a href="#Android-M-App-Links实现" class="headerlink" title="Android M App Links实现"></a><a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2015/0718/3200.html" target="_blank" rel="noopener">Android M App Links实现</a></h5></li><li><h5 id="IOS9-Universal-Links的使用"><a href="#IOS9-Universal-Links的使用" class="headerlink" title="IOS9 Universal Links的使用"></a><a href="http://www.cocoachina.com/ios/20160719/17108.html" target="_blank" rel="noopener">IOS9 Universal Links的使用</a></h5></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;之前的有一篇博文介绍了Scheme的方式来实现App之间的跳转，但是这种方式有一个问题，就是当我们的移动设备上没有安装该App时，它不能做其他的处理，比如跳转到我们公司的网站里面。在2015年，Google和Apple分别提出了和App Links（只支持Android M
      
    
    </summary>
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/categories/React-Native/"/>
    
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>浅析移动端深度链接技术</title>
    <link href="https://gyunzhi.github.io/2018/03/30/%E6%B5%85%E6%9E%90%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%B7%B1%E5%BA%A6%E9%93%BE%E6%8E%A5%E6%8A%80%E6%9C%AF/"/>
    <id>https://gyunzhi.github.io/2018/03/30/浅析移动端深度链接技术/</id>
    <published>2018-03-29T16:57:23.000Z</published>
    <updated>2019-05-06T09:26:27.153Z</updated>
    
    <content type="html"><![CDATA[<p>​    公司的后台管理App，是使用React Native框架来写的，RN框架屏蔽了IOS和Android之间开发方式的差异，使得前端可以通过JavaScript来开发跨平台的原生App，前段时间收到一个需求，需要在App中打开第三方的App并进入某个特定的界面。于是去看了一下RN的官方文档和网上的一些关于App之间通信的技术文章。了解到了深度链接这个东西，但是很多文章要么讲解的不是很清楚，要么就是很久之前的东西，而且没有针对于RN框架来展开的具体的介绍，所以打算自己写一篇博客给大家分享一下深度链接技术。</p><h3 id="什么是深度链接"><a href="#什么是深度链接" class="headerlink" title="什么是深度链接"></a>什么是深度链接</h3><p>​    所谓深度链接，简单来讲，就是你在手机上点击一个链接之后，可以打开某个App或者是直接进入到这个App内部的某个页面，而不是App正常打开时显示的首页。</p><h3 id="如何实现深度链接"><a href="#如何实现深度链接" class="headerlink" title="如何实现深度链接"></a>如何实现深度链接</h3><p>​    就目前来讲，实现深度链接主要有以下三种方式，<strong>这篇文章我们主要介绍URL  Scheme的方式来实现深度链接</strong>：</p><ul><li>URL Scheme        iOS，Android平台都支持</li></ul><ul><li>Universal Links     只支持iOS9及以上系统</li></ul><ul><li>App Links              只支持Android6.0及以上系统</li></ul><h4 id="1-什么是URL-Scheme"><a href="#1-什么是URL-Scheme" class="headerlink" title="1.什么是URL Scheme"></a>1.什么是URL Scheme</h4><ol><li><p>通过对比网页链接来理解 URL Scheme，应就容易多了。</p><p>URL Scheme 有两个单词：</p><ul><li>URL，我们都很清楚，<code>http://www.apple.com</code> 就是个 URL，我们也叫它链接或网址；</li><li>Scheme，表示的是一个 URL 中的一个位置—最初始的位置，即 <code>://</code>之前的那段字符。比如 <code>http://www.apple.com</code> 这个网址的 Scheme 是 <strong>http</strong>（可以理解为URL地址的协议）。</li></ul><p>根据我们上面对 URL Schemes 的了解，我们可以很轻易地理解，在手机中，我们可以像定位一个网页一样，用一种特殊的 URL 来定位一个应用甚至应用里某个具体的功能。而定位这个应用的，就是这个应用的URL 的 Scheme 部分，也就是开头儿那部分。比如短信，就是 <code>sms:</code></p><p>下面用苹果的网站和 iOS 上的微信来做个简单对比：</p><table class="tableview" tabindex="1" cellspacing="3" data-target="#table-cell-menu"><tbody><tr><td class="border_l border_r border_t border_b selected" style="text-align: left; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;"></div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">网页（苹果）iOS</div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">iOS</div></div></td></tr><tr><td class="border_l border_r border_t border_b" style="text-align: left; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">网站首页/打开应用</div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;"><a href="http://www.apple.com" target="_blank" rel="noopener">http://www.apple.com</a></div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">weixin://</div></div></td></tr><tr><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">子页面/具体功能</div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;"><a href="http://www.apple.com/mac/（Mac页面）" target="_blank" rel="noopener">http://www.apple.com/mac/（Mac页面）</a></div></div></td><td class="border_l border_r border_t border_b" style="text-align: center; vertical-align: top;"><div class="wrap"><div style="margin: 10px 5px;">weixin://dl/moments（朋友圈）</div></div></td></tr></tbody></table><p>在这里，<code>http://www.apple.com</code> 和 <code>weixin://</code> 都声明了这是谁的地盘。然后在 <code>http://www.apple.com</code> 后面加上 <code>/mac</code> 就跳转到从属于 <code>http://www.apple.com</code> 的一个网页上；同样，在 <code>weixin://</code> 后面加上 <code>dl/moments</code> 就进入了微信的一个具体的功能——朋友圈。</p><p><strong>但是，两者还有几个重要的区别：</strong></p></li></ol><ul><li><p>所有网页都一定有网址，不管是首页还是子页。但未必所有的应用都有自己的 URL Scheme，更不是每个应用的每个功能都有相应的 URL Scheme。实际上，现状是，大多数的应用只有用于打开应用的 URL Scheme，而有一些应用甚至没有用于打开应用的 URL Scheme。几乎没有所有功能都有对应 URL 的应用。<strong>一个 App 是否支持 URL Schemes 要看那个 App 的作者是否在自己的作品里添加了支持 URL Schemes 相关的代码。</strong></p></li><li><p>一个网址只对应一个网页，但并非每个 URL Scheme 都只对应一款应用。因为URL Schemes是可以重复的，所以曾经出现过<a href="http://jbguide.me/2015/03/26/url-scheme-is-vulnerable/" target="_blank" rel="noopener">有 App 使用支付宝的 URL Schemes 拦截支付帐号和密码的事件</a>。</p></li></ul><h4 id="2-如何通过URL-Scheme实现深度链接"><a href="#2-如何通过URL-Scheme实现深度链接" class="headerlink" title="2.如何通过URL Scheme实现深度链接"></a>2.如何通过URL Scheme实现深度链接</h4><p>通过下面这张图来说明APP1与APP2之间，在技术上，如何完成横向调用：</p><p><img src="http://img.gongyz.cn/blog/181030/dC0c39g941.jpg" alt="mark"></p><p>假如要从APP-F调用APP-T</p><p>1）APP-T要进行自定义scheme的配置（iOS是info文件，Android是activity），并且可以对传入的参数进行处理。</p><p>2）APP-F进行调用，首先判断设备是否安装APP-T。</p><p>3）如果未安装，则跳转到APP-T的web版应用（假设他提供web版）或者是跳转到AppStore等应用市场进行下载。</p><p>4）如果已安装，则调用APP-T配置好的URL SCHEME，直接打开APP-T的相关界面。</p><h3 id="自定义URL-Scheme配置"><a href="#自定义URL-Scheme配置" class="headerlink" title="自定义URL Scheme配置"></a>自定义URL Scheme配置</h3><p>​    要想你的应用支持URL Scheme，你需要在应用里面进行配置，IOS和Android配置的方法是不一样的，下面会详细讲一下两者配置的步骤：</p><ul><li><h4 id="IOS"><a href="#IOS" class="headerlink" title="IOS"></a>IOS</h4><p>第一步是创建 URL Scheme — 在 Xcode Project Navigator 中找到并点击工程 info.plist 文件。当该文件显示在右边窗口，在列表上点击鼠标右键，选择 <em>Add Row</em>:</p><p>向下滚动弹出的列表并选择 <em>URL types</em></p><p><img src="http://img.gongyz.cn/blog/181030/7BjDA5i3Kk.gif" alt="mark"></p><p>点击左边剪头打开列表，可以看到 <em>Item 0</em>，一个字典实体。展开 <em>Item 0</em>，可以看到 <em>URL Identifier</em>，一个字符串对象。该字符串是你自定义的 URL scheme 的名字。建议采用反转域名的方法保证该名字的唯一性，比如 <em>com.yourCompany.yourApp</em>。</p><p><img src="http://img.gongyz.cn/blog/181030/lcH6J7eLd2.gif" alt="mark"></p><p>点击 <em>Item 0</em> 新增一行，从下拉列表中选择 <em>URL Schemes</em>，敲击键盘回车键完成插入。</p><p><img src="http://img.gongyz.cn/blog/181030/Kdf3Lh0fke.gif" alt="mark"></p><p>注意 URL Schemes 是一个数组，允许应用定义多个 URL schemes。</p><p><img src="http://img.gongyz.cn/blog/181030/1k6KG8G3gB.gif" alt="mark"></p><p>展开该数据并点击 <em>Item 0</em>。你将在这里定义自定义 URL scheme 的名字。只需要名字，不要在后面追加 :// — 比如，如果你输入 iOSDevApp，你的自定义 url 就是 iOSDevApp://</p><p><img src="http://img.gongyz.cn/blog/181030/Fk1EJB5Fmh.gif" alt="mark"></p><p>此时，整个定义如下图:</p><p><img src="http://img.gongyz.cn/blog/181030/dEbEgieE5H.gif" alt="mark"></p><p>虽然我赞同 Xcode 使用描述性的名字的目的，不过看到创建的实际的 key 也是非常有用的。这里有一个方便的技巧，右键点击 plist 并选择 <em>Show Raw Keys/Values</em>，就能看到以下效果:</p><p><img src="http://img.gongyz.cn/blog/181030/fGf3hfi5hl.png" alt="mark"></p><p>还有另一种有用的输出格式，XML，因为可以非常容易的看到字典和原始数组及其包括的实体的结构。点击 plist 并选择 <em>Open As – Source Code</em>:</p><p><img src="http://img.gongyz.cn/blog/181030/5EABLE6f4i.gif" alt="mark"></p></li></ul><ul><li><h4 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h4><p>Android应用/组件间通信有一种方式是<code>intent</code>，应用可以注册<code>intent filter</code>声明自己对什么样的<code>intent</code>感兴趣，其它应用发送<code>intent</code>时通过系统级广播传递过来，如果与预先注册的<code>intent filter</code>匹配，应用将收到该<code>intent</code>（无论应用是否正在运行，都会被“唤醒”，也就是隐式启动<code>Activity</code>），并取出<code>intent</code>携带的数据，做进一步处理，所以我们需要在<code>AndroidManifest.xml</code>里静态注册<code>intent filter</code>来声明自定义的URL Scheme：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> &lt;activity</span><br><span class="line">  android:name=<span class="string">".MainActivity"</span></span><br><span class="line">  android:launchMode=<span class="string">"singleTask"</span></span><br><span class="line">  android:label=<span class="string">"@string/app_name"</span></span><br><span class="line">  android:configChanges=<span class="string">"keyboard|keyboardHidden|orientation|screenSize"</span></span><br><span class="line">  android:windowSoftInputMode=<span class="string">"adjustResize"</span>&gt;</span><br><span class="line">  &lt;intent-filter&gt; &lt;!-- 正常启动 --&gt;</span><br><span class="line">  &lt;action android:name=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span><br><span class="line">  &lt;category android:name=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span><br><span class="line">  &lt;/intent-filter&gt;</span><br><span class="line"></span><br><span class="line">  &lt;intent-filter&gt; &lt;!-- URL Scheme启动 --&gt;</span><br><span class="line">&lt;action android:name="android.intent.action.VIEW"&gt;&lt;/action&gt;</span><br><span class="line">&lt;category android:name="android.intent.category.DEFAULT"&gt;&lt;/category&gt;  </span><br><span class="line">&lt;data android:scheme="myapp"&gt;&lt;/data&gt; </span><br><span class="line">  &lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="React-Native提供的Liking-API处理深度链接"><a href="#React-Native提供的Liking-API处理深度链接" class="headerlink" title="React Native提供的Liking API处理深度链接"></a>React Native提供的Liking API处理深度链接</h3><p>在RN的官方文档中提供了<a href="http://facebook.github.io/react-native/docs/linking.html#addeventlistener" target="_blank" rel="noopener">Liking</a>这个API让我们处理深度链接来实现App之间的跳转。</p><h4 id="处理传入的链接"><a href="#处理传入的链接" class="headerlink" title="处理传入的链接"></a>处理传入的链接</h4><p>如果你的应用被其注册过的外部url调起，则可以在任何组件内这样获取和处理它：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  Linking.getInitialURL().then(<span class="function">(<span class="params">url</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Initial url is: '</span> + url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'An error occurred'</span>, err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：getInitialURL方法只有在App第一次启动的时候会执行，如果App已经启动但是进程挂到后台，通过深度链接打开该App的时候不会执行getInitialURL方法，所以需要用到addEventListener方法，确保每次打开App时都能知道我们的App是被哪个链接调起的。</p><p>如果要在MainActivity实例存在（即App进程没有关闭的时候）的时候监听传入的<a href="http://www.cnblogs.com/smyhvae/p/3959204.html" target="_blank" rel="noopener">intent</a>，那么需要在<code>AndroidManifest.xml</code>中将MainActivity的<code>launchMode</code>设置为<code>singleTask</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line"> android:name=<span class="string">".MainActivity"</span></span><br><span class="line"> android:launchMode=<span class="string">"singleTask"</span>&gt;</span><br></pre></td></tr></table></figure><p>对于iOS来说，如果要在App启动后也监听传入的App链接，需要在<code>AppDelegate.m</code>中增加以下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// iOS 9.x or newer</span><br><span class="line">#import &lt;React/RCTLinkingManager.h&gt;</span><br><span class="line"></span><br><span class="line">- (BOOL)application:(UIApplication *)application</span><br><span class="line">   openURL:(NSURL *)url</span><br><span class="line">   options:(NSDictionary&lt;UIApplicationOpenURLOptionsKey,id&gt; *)options</span><br><span class="line">&#123;</span><br><span class="line">  return [RCTLinkingManager application:application openURL:url options:options];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// iOS 8.x or older</span><br><span class="line">#import &lt;React/RCTLinkingManager.h&gt;</span><br><span class="line"></span><br><span class="line">- (BOOL)application:(UIApplication *)application openURL:(NSURL *)url</span><br><span class="line">  sourceApplication:(NSString *)sourceApplication annotation:(id)annotation</span><br><span class="line">&#123;</span><br><span class="line">  return [RCTLinkingManager application:application openURL:url</span><br><span class="line">                      sourceApplication:sourceApplication annotation:annotation];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后你的React组件就可以监听<code>Linking</code>的相关事件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  Linking.addEventListener(<span class="string">'url'</span>, <span class="keyword">this</span>._handleOpenURL);</span><br><span class="line">&#125;,</span><br><span class="line">componentWillUnmount() &#123;</span><br><span class="line">  Linking.removeEventListener(<span class="string">'url'</span>, <span class="keyword">this</span>._handleOpenURL);</span><br><span class="line">&#125;,</span><br><span class="line">_handleOpenURL(event) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(event.url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="打开外部链接"><a href="#打开外部链接" class="headerlink" title="打开外部链接"></a>打开外部链接</h4><p>要启动一个链接相对应的应用（打开浏览器、邮箱或者其它的应用），只需调用：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linking.openURL(url).catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'An error occurred'</span>, err));</span><br></pre></td></tr></table></figure><p>如果想在打开链接前先检查是否安装了对应的应用，则调用以下方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Linking.canOpenURL(url).then(<span class="function"><span class="params">supported</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supported) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Can\'t handle url: '</span> + url);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Linking.openURL(url);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(<span class="string">'An error occurred'</span>, err));</span><br></pre></td></tr></table></figure><p>注意：在IOS平台，打开外部链接需要配置Scheme白名单</p><ul><li>在项目的info.plist中添加一LSApplicationQueriesSchemes，类型为Array；</li><li>添加需要支持的项目，类型为字符串类型；</li></ul><p><img src="http://img.gongyz.cn/blog/181030/la88aHAiFb.png" alt="mark"></p><h3 id="相关阅读链接"><a href="#相关阅读链接" class="headerlink" title="相关阅读链接"></a>相关阅读链接</h3><ul><li><h5 id="移动端Deeplink的前世今生"><a href="#移动端Deeplink的前世今生" class="headerlink" title="移动端Deeplink的前世今生"></a><a href="https://zhuanlan.zhihu.com/p/20694818" target="_blank" rel="noopener">移动端Deeplink的前世今生</a></h5></li><li><h5 id="自定义URL-Scheme完全指南"><a href="#自定义URL-Scheme完全指南" class="headerlink" title="自定义URL Scheme完全指南"></a><a href="http://objcio.com/blog/2014/05/21/the-complete-tutorial-on-ios-slash-iphone-custom-url-schemes/" target="_blank" rel="noopener">自定义URL Scheme完全指南</a></h5></li><li><h5 id="如何自定义-URL-Scheme-进行跳转"><a href="#如何自定义-URL-Scheme-进行跳转" class="headerlink" title="如何自定义 URL Scheme 进行跳转"></a><a href="https://www.jianshu.com/p/1295194b11e4" target="_blank" rel="noopener">如何自定义 URL Scheme 进行跳转</a></h5></li><li><h5 id="唤醒App的那些事"><a href="#唤醒App的那些事" class="headerlink" title="唤醒App的那些事"></a><a href="https://www.jianshu.com/p/862885bd8ea2" target="_blank" rel="noopener">唤醒App的那些事</a></h5></li><li><h5 id="H5页面唤醒App"><a href="#H5页面唤醒App" class="headerlink" title="H5页面唤醒App"></a><a href="https://github.com/AlanZhang001/H5CallUpNative" target="_blank" rel="noopener">H5页面唤醒App</a></h5></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;​    公司的后台管理App，是使用React Native框架来写的，RN框架屏蔽了IOS和Android之间开发方式的差异，使得前端可以通过JavaScript来开发跨平台的原生App，前段时间收到一个需求，需要在App中打开第三方的App并进入某个特定的界面。于是去
      
    
    </summary>
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/categories/React-Native/"/>
    
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>Android环境生成签名密钥、打包APK</title>
    <link href="https://gyunzhi.github.io/2018/02/26/Android%E7%8E%AF%E5%A2%83%E7%94%9F%E6%88%90%E7%AD%BE%E5%90%8D%E5%AF%86%E9%92%A5%E3%80%81%E6%89%93%E5%8C%85APK/"/>
    <id>https://gyunzhi.github.io/2018/02/26/Android环境生成签名密钥、打包APK/</id>
    <published>2018-02-25T17:08:23.000Z</published>
    <updated>2019-05-06T09:26:27.091Z</updated>
    
    <content type="html"><![CDATA[<p>Android要求所有应用都有一个数字签名才会被允许安装在用户手机上，所以在把应用发布到类似<a href="https://play.google.com/store" target="_blank" rel="noopener">Google Play store</a>这样的应用市场之前，你需要先生成一个签名的APK包。Android开发者官网上的<a href="https://developer.android.com/tools/publishing/app-signing.html" target="_blank" rel="noopener">如何给你的应用签名</a>文档描述了签名的细节。本指南旨在提供一个简化的签名和打包APK的操作步骤，不会涉及太多理论。</p><h3 id="生成一个签名密钥"><a href="#生成一个签名密钥" class="headerlink" title="生成一个签名密钥"></a>生成一个签名密钥</h3><p>你可以用<code>keytool</code>命令生成一个私有密钥。在Windows上<code>keytool</code>命令放在JDK的bin目录中（比如<code>C:\Program Files\Java\jdkx.x.x_x\bin</code>），如果你没有配置Java环境变量的话，需要先进入那个目录才能在命令行中执行此命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ keytool -genkey -v -keystore my-release-key.keystore -<span class="built_in">alias</span> my-key-alias -keyalg RSA -keysize 2048 -validity 10000</span><br></pre></td></tr></table></figure><p>执行命令后会要求你输入密钥库（keystore）和对应密钥的密码，然后设置一些发行相关的信息。最后它会在当前目录下生成一个叫做<code>my-release-key.keystore</code>的密钥库文件。在运行上面这条语句之后，密钥库里应该已经生成了一个单独的密钥，有效期为10000天。–alias参数后面的别名是你将来为应用签名时所需要用到的，所以记得记录这个别名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看keystore参数信息：keytool -list -v -keystore my-release-key.keystore</span><br></pre></td></tr></table></figure><p><strong>注意：请记得妥善地保管好你的密钥库文件，不要上传到版本库或者其它的地方。</strong></p><h3 id="设置gradle变量"><a href="#设置gradle变量" class="headerlink" title="设置gradle变量"></a>设置gradle变量</h3><ol><li>把<code>my-release-key.keystore</code>文件放到你工程中的<code>android/app</code>文件夹下。</li><li>编辑用户目下的<code>~/.gradle/gradle.properties</code>或者是RN项目中下的<code>android/gradle.properties</code>文件，添加如下的代码（注意把其中的<code>****</code>替换为相应密码）</li></ol><p><strong>注意：~表示用户目录，比如windows上可能是C:\Users\用户名，而mac上可能是/Users/用户名。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MYAPP_RELEASE_STORE_FILE=my-release-key.keystore</span><br><span class="line">MYAPP_RELEASE_KEY_ALIAS=my-key-alias</span><br><span class="line">MYAPP_RELEASE_STORE_PASSWORD=*****</span><br><span class="line">MYAPP_RELEASE_KEY_PASSWORD=*****</span><br></pre></td></tr></table></figure><p>上面的这些会作为全局的gradle变量，我们在后面的步骤中可以用来给应用签名。</p><blockquote><p><strong>关于密钥库的注意事项:</strong></p></blockquote><blockquote><p>一旦你在Play Store发布了你的应用，如果想修改签名密钥，就必须用一个不同的包名来重新发布你的应用（这样也会丢失所有的下载数和评分）。所以请务必备份好你的密钥库和密码。</p></blockquote><p>提示：如果你不想以明文方式保存密码，同时你使用的是macOS系统，那么你也可以把密码<a href="https://pilloxa.gitlab.io/posts/safer-passwords-in-gradle/" target="_blank" rel="noopener">保存到钥匙串（Keychain）中</a>。这样一来你就可以省略掉上面配置中的后两行（即MYAPP_RELEASE_STORE_PASSWORD和MYAPP_RELEASE_KEY_PASSWORD）。</p><h3 id="添加签名到项目的gradle配置文件"><a href="#添加签名到项目的gradle配置文件" class="headerlink" title="添加签名到项目的gradle配置文件"></a>添加签名到项目的gradle配置文件</h3><p>编辑你项目目录下的<code>android/app/build.gradle</code>，添加如下的签名配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123; ... &#125;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            storeFile file(MYAPP_RELEASE_STORE_FILE)</span><br><span class="line">            storePassword MYAPP_RELEASE_STORE_PASSWORD</span><br><span class="line">            keyAlias MYAPP_RELEASE_KEY_ALIAS</span><br><span class="line">            keyPassword MYAPP_RELEASE_KEY_PASSWORD</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            ...</span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="生成发行APK包"><a href="#生成发行APK包" class="headerlink" title="生成发行APK包"></a>生成发行APK包</h3><p>只需在终端中运行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> android &amp;&amp; ./gradlew assembleRelease</span><br></pre></td></tr></table></figure><p>译注：cd android表示进入android目录（如果你已经在android目录中了那就不用输入了）。<code>./gradlew assembleRelease</code>在macOS、Linux或是windows的PowerShell环境中表示执行当前目录下的名为gradlew的脚本文件，且其运行参数为assembleRelease，注意这个<code>./</code>不可省略；而在windows的传统CMD命令行下则需要去掉<code>./</code>。</p><p>Gradle的<code>assembleRelease</code>参数会把所有用到的JavaScript代码都打包到一起，然后内置到APK包中。如果你想调整下这个行为（比如js代码以及静态资源打包的默认文件名或是目录结构等），可以看看<code>android/app/build.gradle</code>文件，然后琢磨下应该怎么修改以满足你的需求。</p><p>生成的APK文件位于<code>android/app/build/outputs/apk/app-release.apk</code>，它已经可以用来发布了。</p><h3 id="测试应用的发行版本"><a href="#测试应用的发行版本" class="headerlink" title="测试应用的发行版本"></a>测试应用的发行版本</h3><p>在把发行版本提交到Play Store之前，你应该做一次最终测试。输入以下命令可以在设备上安装发行版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> android &amp;&amp; ./gradlew installRelease</span><br></pre></td></tr></table></figure><p>注意<code>installRelease</code>参数只能在你完成了上面的签名配置之后才可以使用。你现在可以关掉运行中的packager了，因为你所有的代码和框架依赖已经都被打包到apk包中，可以离线运行了。</p><blockquote><p>在debug和release版本间来回切换安装时可能会报错签名不匹配，此时需要先卸载前一个版本再尝试安装。</p></blockquote><h3 id="针对设备不同的CPU架构生成APK以减小APK文件的大小"><a href="#针对设备不同的CPU架构生成APK以减小APK文件的大小" class="headerlink" title="针对设备不同的CPU架构生成APK以减小APK文件的大小"></a>针对设备不同的CPU架构生成APK以减小APK文件的大小</h3><p>默认情况下，生成的APK会同时包含针对于x86和ARMv7aCPU架构的原生代码。 这样可以让我们更方便的向其他人分享这个APK，因为它几乎可以运行在所有的Android设备上。 但是，这有一个缺点，首先是APK文件更大，其次任何设备上都会有一些未使用的代码。</p><p>你可以在<code>android/app/build.gradle</code>:修改如下代码来打包生成针对不同CPU架构的APK</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- def enableSeparateBuildPerCPUArchitecture = <span class="literal">false</span></span><br><span class="line">+ def enableSeparateBuildPerCPUArchitecture = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>你可以把这上面打包生成的两个APK都上传到支持对用户设备CPU架构定位的应用程序商店，例如Google Play和Amazon AppStore，用户将自动获得相应的APK。如果您想上传到其他市场，例如APKFiles（不支持一个应用有多个APK文件），可以修改下面的代码，来生成适用不同CPU架构的通用APK。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- universalApk <span class="literal">false</span>  </span><br><span class="line">+ universalApk <span class="literal">true</span>  // 设置为<span class="literal">true</span>的时候会再生成一个通用APK</span><br></pre></td></tr></table></figure><h3 id="启用Proguard来减小APK文件的大小（可选）"><a href="#启用Proguard来减小APK文件的大小（可选）" class="headerlink" title="启用Proguard来减小APK文件的大小（可选）"></a>启用Proguard来减小APK文件的大小（可选）</h3><p>Proguard是一个减小APK的大小的工具，它通过移除掉React Native Java字节码文件（和它的依赖库中）中没有被使用到的部分，最终有效的减少APK的大小。</p><p><strong>重要</strong>：启用Proguard之后，你必须再次全面地测试你的应用。Proguard有时候需要为你引入的每个原生库做一些额外的配置。参见<code>app/proguard-rules.pro</code>文件。</p><p>在<code>android/app/build.gradle</code>文件中修改如下代码来启用Proguard</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- def enableProguardInReleaseBuilds = <span class="literal">false</span> </span><br><span class="line">+ def enableProguardInReleaseBuilds = <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>启动Proguard后需清空缓存，否则可能会报错：</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> android &amp;&amp; ./gradlew.bat clean</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Android要求所有应用都有一个数字签名才会被允许安装在用户手机上，所以在把应用发布到类似&lt;a href=&quot;https://play.google.com/store&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Google Play store&lt;/a
      
    
    </summary>
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/categories/React-Native/"/>
    
    
      <category term="React-Native" scheme="https://gyunzhi.github.io/tags/React-Native/"/>
    
  </entry>
  
  <entry>
    <title>CenterOS7部署静态博客</title>
    <link href="https://gyunzhi.github.io/2018/02/20/CenterOS7%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/"/>
    <id>https://gyunzhi.github.io/2018/02/20/CenterOS7部署静态博客/</id>
    <published>2018-02-19T20:09:59.000Z</published>
    <updated>2019-05-06T09:26:27.116Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx       安装nginx </span><br><span class="line">yum install git         安装git （git <span class="built_in">clone</span> ...） 静态文放在/usr/src/blog下</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> nginx  系统启动时运行nginx</span><br><span class="line"><span class="comment"># centos6.x</span></span><br><span class="line">service nginx start     启动nginx服务</span><br><span class="line">service nginx stop    停止nginx服务</span><br><span class="line">service nginx reload    重启nginx服务</span><br><span class="line"></span><br><span class="line"><span class="comment"># centos7.x</span></span><br><span class="line">systemctl start  nginx   启动nginx服务</span><br><span class="line">systemctl stopnginx    停止nginx服务</span><br><span class="line">systemctl reload nginx    重启nginx服务</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>                     查看当前目录</span><br><span class="line">ll/dir                  查看目录下文件和文件夹</span><br><span class="line">mv 文件名 新文件名        修改文件名称</span><br><span class="line">vi nginx.conf           编辑文件</span><br></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"><span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                    <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#include /etc/nginx/conf.d/*.conf;  #关闭默认的配置</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#自定义监听端口，指定静态站点所在目录</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>  <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="attribute">root</span>   /usr/src/blog;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>开启<code>https</code>时<code>nginx</code>配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    \#tcp_nopush     on;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    \#gzip  on;</span><br><span class="line">    \#include /etc/nginx/conf.d/*.conf;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">        <span class="attribute">server_name</span> www.xxx.cn; <span class="comment">#填写绑定证书的域名</span></span><br><span class="line">        <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">ssl_certificate</span> ./conf.d/1_www.xxx.cn_bundle.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> ./conf.d/2_www.xxx.cn.key;</span><br><span class="line">        <span class="attribute">ssl_session_timeout</span> <span class="number">5m</span>;</span><br><span class="line">        <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#按照这个协议配置</span></span><br><span class="line">        <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;<span class="comment">#按照这个套件配置</span></span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   /usr/src/blog; <span class="comment">#站点目录</span></span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>  <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost; </span><br><span class="line">      <span class="attribute">location</span> / &#123;</span><br><span class="line">         <span class="attribute">root</span>   /usr/src/blog; <span class="comment">#站点目录</span></span><br><span class="line">         <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">          rewrite ^(.*) https://$host$1 permanent;  // 80端口请求重定向到https</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;
      
    
    </summary>
    
      <category term="服务器" scheme="https://gyunzhi.github.io/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    
      <category term="服务器" scheme="https://gyunzhi.github.io/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>使用gulp对博文进行压缩</title>
    <link href="https://gyunzhi.github.io/2018/02/15/%E4%BD%BF%E7%94%A8gulp%E5%AF%B9%E5%8D%9A%E6%96%87%E5%8E%8B%E7%BC%A9/"/>
    <id>https://gyunzhi.github.io/2018/02/15/使用gulp对博文压缩/</id>
    <published>2018-02-14T22:06:23.000Z</published>
    <updated>2019-05-06T09:26:27.146Z</updated>
    
    <content type="html"><![CDATA[<p>默认情况下，使用hexo generate命令生成的静态文件没有经过压缩，代码之间会有很多空白行和注释，可以通过gulp对 public 目录中的静态资源文件进行压缩，减少网站整体尺寸大小。下面是具体的步骤：</p><h4 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h4><p>安装完后替换为淘宝镜像源避免因网速问题导致文件下载不全：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br><span class="line">npm config <span class="built_in">set</span> disturl https://npm.taobao.org/dist</span><br></pre></td></tr></table></figure><h4 id="安装gulp"><a href="#安装gulp" class="headerlink" title="安装gulp"></a>安装gulp</h4><p>安装gulp需要全局安装一次，再本地环境安装一次，参见<a href="http://www.gulpjs.com.cn/docs/getting-started/" target="_blank" rel="noopener">gulp入门指南</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install gulp -g</span><br><span class="line">npm install gulp --save-dev</span><br></pre></td></tr></table></figure><h4 id="安装gulp相关插件"><a href="#安装gulp相关插件" class="headerlink" title="安装gulp相关插件"></a>安装gulp相关插件</h4><p>需要用到以下插件</p><blockquote><p>del<br>gulp-clean-css<br>gulp-htmlclean<br>gulp-htmlmin<br>gulp-imagemin<br>gulp-uglify<br>run-sequence</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">npm install del --save-dev</span><br><span class="line">npm install gulp-clean-css --save-dev</span><br><span class="line">npm install gulp-htmlclean --save-dev</span><br><span class="line">npm install gulp-htmlmin --save-dev</span><br><span class="line">npm install gulp-imagemin --save-dev</span><br><span class="line">npm install gulp-uglify --save-dev</span><br><span class="line">npm install run-sequence --save-dev</span><br></pre></td></tr></table></figure><h4 id="编写gulpfile-js文件"><a href="#编写gulpfile-js文件" class="headerlink" title="编写gulpfile.js文件"></a>编写gulpfile.js文件</h4><p>在hexo项目根目录下（node_modules同目录），新增gulpfile.js文件，内容如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> gulp = <span class="built_in">require</span>(<span class="string">'gulp'</span>);</span><br><span class="line"><span class="keyword">var</span> minifycss = <span class="built_in">require</span>(<span class="string">'gulp-clean-css'</span>);</span><br><span class="line"><span class="keyword">var</span> uglify = <span class="built_in">require</span>(<span class="string">'gulp-uglify'</span>);</span><br><span class="line"><span class="keyword">var</span> htmlmin = <span class="built_in">require</span>(<span class="string">'gulp-htmlmin'</span>);</span><br><span class="line"><span class="keyword">var</span> htmlclean = <span class="built_in">require</span>(<span class="string">'gulp-htmlclean'</span>);</span><br><span class="line"><span class="keyword">var</span> imagemin = <span class="built_in">require</span>(<span class="string">'gulp-imagemin'</span>);</span><br><span class="line"><span class="keyword">var</span> del = <span class="built_in">require</span>(<span class="string">'del'</span>);</span><br><span class="line"><span class="keyword">var</span> runSequence = <span class="built_in">require</span>(<span class="string">'run-sequence'</span>);</span><br><span class="line"><span class="keyword">var</span> Hexo = <span class="built_in">require</span>(<span class="string">'hexo'</span>);</span><br><span class="line"><span class="comment">// 清除public文件夹</span></span><br><span class="line">gulp.task(<span class="string">'clean'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> del([<span class="string">'public/**/*'</span>]);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 利用Hexo API 来生成博客内容， 效果和在命令行运行： hexo g 一样</span></span><br><span class="line"><span class="keyword">var</span> hexo = <span class="keyword">new</span> Hexo(process.cwd(), &#123;&#125;);</span><br><span class="line">gulp.task(<span class="string">'generate'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    hexo.init().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hexo.call(<span class="string">'generate'</span>, &#123;</span><br><span class="line">            watch: <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hexo.exit();</span><br><span class="line">    &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cb()</span><br><span class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">        hexo.exit(err);</span><br><span class="line">        <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 压缩public目录下的所有css</span></span><br><span class="line">gulp.task(<span class="string">'minify-css'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./public/**/*.css'</span>)</span><br><span class="line">        .pipe(minifycss(&#123;</span><br><span class="line">            compatibility: <span class="string">'ie8'</span>,</span><br><span class="line">rebase: <span class="literal">false</span>,</span><br><span class="line">        &#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩public目录下的所有html</span></span><br><span class="line">gulp.task(<span class="string">'minify-html'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./public/**/*.html'</span>)</span><br><span class="line">        .pipe(htmlclean())</span><br><span class="line">        .pipe(htmlmin(&#123;</span><br><span class="line">            removeComments: <span class="literal">true</span>,</span><br><span class="line">            minifyJS: <span class="literal">true</span>,</span><br><span class="line">            minifyCSS: <span class="literal">true</span>,</span><br><span class="line">            minifyURLs: <span class="literal">true</span>,</span><br><span class="line">        &#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public'</span>))</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩public目录下的所有js</span></span><br><span class="line">gulp.task(<span class="string">'minify-js'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./public/**/*.js'</span>)</span><br><span class="line">        .pipe(uglify())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public'</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 压缩public目录下的所有img： 这个采用默认配置</span></span><br><span class="line">gulp.task(<span class="string">'minify-img'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./public/images/**/*.*'</span>)</span><br><span class="line">        .pipe(imagemin())</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public/images'</span>))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 同上，压缩图片，这里采用了： 最大化压缩效果。</span></span><br><span class="line">gulp.task(<span class="string">'minify-img-aggressive'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gulp.src(<span class="string">'./public/images/**/*.*'</span>)</span><br><span class="line">        .pipe(imagemin(</span><br><span class="line">        [imagemin.gifsicle(&#123;<span class="string">'optimizationLevel'</span>: <span class="number">3</span>&#125;), </span><br><span class="line">        imagemin.jpegtran(&#123;<span class="string">'progressive'</span>: <span class="literal">true</span>&#125;), </span><br><span class="line">        imagemin.optipng(&#123;<span class="string">'optimizationLevel'</span>: <span class="number">7</span>&#125;), </span><br><span class="line">        imagemin.svgo()],</span><br><span class="line">        &#123;<span class="string">'verbose'</span>: <span class="literal">true</span>&#125;))</span><br><span class="line">        .pipe(gulp.dest(<span class="string">'./public/images'</span>))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 用run-sequence并发执行，同时处理html，css，js，img</span></span><br><span class="line">gulp.task(<span class="string">'compress'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    runSequence([<span class="string">'minify-html'</span>, <span class="string">'minify-css'</span>, <span class="string">'minify-js'</span>, <span class="string">'minify-img-aggressive'</span>], cb);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 执行顺序： 清除public目录 -&gt; 产生原始博客内容 -&gt; 执行压缩混淆</span></span><br><span class="line">gulp.task(<span class="string">'build'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">cb</span>) </span>&#123;</span><br><span class="line">    runSequence(<span class="string">'clean'</span>, <span class="string">'generate'</span>, <span class="string">'compress'</span>, cb)</span><br><span class="line">&#125;);</span><br><span class="line">gulp.task(<span class="string">'default'</span>, [<span class="string">'build'</span>])</span><br></pre></td></tr></table></figure><h4 id="执行gulp压缩再部署"><a href="#执行gulp压缩再部署" class="headerlink" title="执行gulp压缩再部署"></a>执行gulp压缩再部署</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gulp build</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;默认情况下，使用hexo generate命令生成的静态文件没有经过压缩，代码之间会有很多空白行和注释，可以通过gulp对 public 目录中的静态资源文件进行压缩，减少网站整体尺寸大小。下面是具体的步骤：&lt;/p&gt;
&lt;h4 id=&quot;安装npm&quot;&gt;&lt;a href=&quot;#安装n
      
    
    </summary>
    
      <category term="Hexo" scheme="https://gyunzhi.github.io/categories/Hexo/"/>
    
    
      <category term="Hexo" scheme="https://gyunzhi.github.io/tags/Hexo/"/>
    
  </entry>
  
</feed>
